{% if event.topic == "mechanic/user/trigger" %}
  {% capture bulk_operation_query %}
    query {
      inventoryItems {
        edges {
          node {
            id
            __typename
            inventoryLevels {
              edges {
                node {
                  id
                  __typename
                  quantities(names: "available") {
                    name
                    quantity
                  }
                }
              }
            }
          }
        }
      }
    }
  {% endcapture %}

  {% action "shopify" %}
    mutation {
      bulkOperationRunQuery(
        query: {{ bulk_operation_query | json }}
      ) {
        bulkOperation {
          id
          status
        }
        userErrors {
          field
          message
        }
      }
    }
  {% endaction %}

{% elsif event.topic == "mechanic/shopify/bulk_operation" %}
  {% if event.preview %}
    {% capture bulkOperation_objects_jsonl %}
      {"__typename":"InventoryLevel","id":"gid:\/\/shopify\/InventoryLevel\/1234567890?inventory_item_id=1234567890","quantities":[{"name":"available","quantity":-5}]}
    {% endcapture %}

    {% assign bulkOperation = hash %}
    {% assign bulkOperation["objects"] = bulkOperation_objects_jsonl | parse_jsonl %}
  {% endif %}

  {% assign inventory_levels = bulkOperation.objects | where: "__typename", "InventoryLevel" %}

  {% for inventory_level in inventory_levels %}
    {% if inventory_level.quantities.first.quantity < 0 %}
      {% action "shopify" %}
        mutation {
          inventoryAdjustQuantity(
            input: {
              inventoryLevelId: {{ inventory_level.id | json }}
              availableDelta: {{ inventory_level.quantities.first.quantity | times: -1 | json }}
            }
          ) {
            inventoryLevel {
              quantities(names: "available") {
                name
                quantity
              }
            }
            userErrors {
              field
              message
            }
          }
        }
      {% endaction %}
    {% endif %}
  {% endfor %}
{% endif %}
