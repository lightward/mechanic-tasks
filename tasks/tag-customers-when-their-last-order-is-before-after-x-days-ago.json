{
  "name": "Tag customers when their last order is before/after x days ago",
  "options": {
    "days_since_last_order__required_number": 7,
    "tag_customers_when_last_order_is_after__boolean": true,
    "tag_customers_when_last_order_is_before__boolean": null,
    "customer_tag__required": "recent-customer",
    "run_hourly__boolean": false,
    "run_daily__boolean": false
  },
  "subscriptions": [
    "mechanic/user/trigger",
    "mechanic/shopify/bulk_operation"
  ],
  "subscriptions_template": "mechanic/user/trigger\nmechanic/shopify/bulk_operation\n\n{% if options.run_hourly__boolean %}\n  mechanic/scheduler/hourly\n{% elsif options.run_daily__boolean %}\n  mechanic/scheduler/daily\n{% endif %}",
  "script": "{% comment %}\n  Preferred option order:\n\n  {{ options.days_since_last_order__required_number }}\n  {{ options.tag_customers_when_last_order_is_after__boolean }}\n  {{ options.tag_customers_when_last_order_is_before__boolean }}\n  {{ options.customer_tag__required }}\n{% endcomment %}\n\n{% if options.tag_customers_when_last_order_is_after__boolean and options.tag_customers_when_last_order_is_before__boolean %}\n  {% error \"Choose only one of 'Tag customers when last order is after' or 'Tag customers when last order is before' :)\" %}\n{% elsif options.tag_customers_when_last_order_is_after__boolean == false and options.tag_customers_when_last_order_is_before__boolean == false %}\n  {% error \"Choose either 'Tag customers when last order is after' or 'Tag customers when last order is before'\" %}\n{% endif %}\n\n{% if event.topic == \"mechanic/user/trigger\" or event.topic contains \"mechanic/scheduler/\" %}\n  {% capture bulk_operation_query %}\n    query {\n      customers(\n        sortKey: LAST_ORDER_DATE\n        query: \"orders_count:>0\"\n      ) {\n        edges {\n          node {\n            id\n            tags\n            lastOrder {\n              processedAt\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% action \"shopify\" %}\n    mutation {\n      bulkOperationRunQuery(\n        query: {{ bulk_operation_query | json }}\n      ) {\n        bulkOperation {\n          id\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% elsif event.topic == \"mechanic/shopify/bulk_operation\" %}\n  {% assign order_processed_at_interval_s = options.days_since_last_order__required_number | times: 24 | times: 60 | times: 60 %}\n  {% assign order_processed_at_threshold_s = \"now\" | date: \"%s\" | minus: order_processed_at_interval_s %}\n  {% assign order_processed_at_threshold_human = order_processed_at_threshold_s | date: \"%Y-%m-%d %H:%M %:z\" %}\n\n  {% log %}{{ \"Threshold for tagging customers: \" | append: order_processed_at_threshold_human | json }}{% endlog %}\n\n  {% if event.preview %}\n    {% assign bulkOperation = hash %}\n    {% assign bulkOperation[\"objects\"] = array %}\n    {% assign bulkOperation[\"objects\"][0] = hash %}\n    {% assign bulkOperation[\"objects\"][0][\"id\"] = \"gid://shopify/Customer/1234567890\" %}\n    {% assign bulkOperation[\"objects\"][0][\"tags\"] = \"\" %}\n    {% assign bulkOperation[\"objects\"][0][\"lastOrder\"] = hash %}\n\n    {% if options.tag_customers_when_last_order_is_after__boolean %}\n      {% assign bulkOperation[\"objects\"][0][\"lastOrder\"][\"processedAt\"] = order_processed_at_threshold_s | plus: 1 | date: \"%FT%T%:z\" %}\n    {% elsif options.tag_customers_when_last_order_is_before__boolean %}\n      {% assign bulkOperation[\"objects\"][0][\"lastOrder\"][\"processedAt\"] = order_processed_at_threshold_s | minus: 1 | date: \"%FT%T%:z\" %}\n    {% endif %}\n  {% endif %}\n\n  {% assign customers = bulkOperation.objects %}\n\n  {% for customer in customers %}\n    {% if customer.lastOrder == nil %}\n      {% continue %}\n    {% endif %}\n\n    {% assign customer_should_be_tagged = false %}\n\n    {% assign customer_last_order_processed_at_s = customer.lastOrder.processedAt | date: \"%s\" | times: 1 %}\n\n    {% if options.tag_customers_when_last_order_is_after__boolean and customer_last_order_processed_at_s >= order_processed_at_threshold_s %}\n      {% assign customer_should_be_tagged = true %}\n    {% elsif options.tag_customers_when_last_order_is_before__boolean and customer_last_order_processed_at_s <= order_processed_at_threshold_s %}\n      {% assign customer_should_be_tagged = true %}\n    {% endif %}\n\n    {% assign customer_tags = customer.tags %}\n    {% assign customer_is_tagged = false %}\n    {% if customer_tags contains options.customer_tag__required %}\n      {% assign customer_is_tagged = true %}\n    {% endif %}\n\n    {% if customer_should_be_tagged and customer_is_tagged %}\n      {% comment %}no-op{% endcomment %}\n    {% elsif customer_should_be_tagged and customer_is_tagged == false %}\n      {% action \"shopify\" %}\n        mutation {\n          tagsAdd(\n            id: {{ customer.id | json }}\n            tags: {{ options.customer_tag__required | json }}\n          ) {\n            node {\n              ... on Customer {\n                id\n                email\n                tags\n                lastOrder {\n                  name\n                  processedAt\n                }\n              }\n            }\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% elsif customer_should_be_tagged == false and customer_is_tagged %}\n      {% action \"shopify\" %}\n        mutation {\n          tagsRemove(\n            id: {{ customer.id | json }}\n            tags: {{ options.customer_tag__required | json }}\n          ) {\n            node {\n              ... on Customer {\n                id\n                email\n                tags\n                lastOrder {\n                  name\n                  processedAt\n                }\n              }\n            }\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% elsif customer_should_be_tagged == false and customer_is_tagged == false %}\n      {% comment %}no-op{% endcomment %}\n    {% endif %}\n  {% endfor %}\n{% endif %}",
  "docs": "Running daily, hourly, or manually, this task scans all customers and tags them based on the date of their last order. Choose between tagging customers whose orders are before x days ago, or after x days ago.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Auto-Tag",
    "Customers",
    "Loyalty"
  ]
}
