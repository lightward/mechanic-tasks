{
  "name": "Send email alerts by event topic",
  "options": {
    "emails_to_notify__array_required": null,
    "general_email_subject__required": "ALERT",
    "append_event_topic_to_email_subject__boolean": true,
    "event_topics_and_email_bodies__keyval_multiline_required": {
      "shopify/products/create": "Hi,\n\nProduct {{ product.id }} was created\n\nView the details in Shopify:\nOBJECT_LINK",
      "shopify/customers/create": "Hi\n\nCustomer {{ customer.id }} was created\n\nView the details in Shopify:\nOBJECT_LINK"
    }
  },
  "subscriptions": [
    "shopify/products/create",
    "shopify/customers/create"
  ],
  "subscriptions_template": "{{ options.event_topics_and_email_bodies__keyval_multiline_required | keys | join: newline }}",
  "script": "{% comment %}\n  Preferred option order:\n\n  {{ options.emails_to_notify__array_required }}\n  {{ options.general_email_subject__required }}\n  {{ options.append_event_topic_to_email_subject__boolean }}\n  {{ options.event_topics_and_email_bodies__keyval_multiline_required }}\n{% endcomment %}\n\n{% assign email_recipients = options.emails_to_notify__array_required %}\n\n{% for keyval in options.event_topics_and_email_bodies__keyval_multiline_required %}\n  {% assign configured_event_topic = keyval.first %}\n\n  {% if event.topic == configured_event_topic %}\n    {% assign email_subject = options.general_email_subject__required %}\n    {% assign email_body = keyval.last %}\n\n    {% if options.append_event_topic_to_email_subject__boolean %}\n      {% assign email_subject = email_subject | append: \" [\" | append: configured_event_topic | append: \"]\" %}\n    {% endif %}\n\n    {% capture admin_link %}https://{{ shop.myshopify_domain }}/admin/{% endcapture %}\n\n    {% assign object_link = nil %}\n\n    {% if event.topic contains \"shopify/collections/\" %}\n      {% capture object_link %}collections/{{ collection.id | default: 1234567890 }}{% endcapture %}\n\n    {% elsif event.topic contains \"shopify/customers/\" %}\n      {% capture object_link %}customers/{{ customer.id | default: 1234567890 }}{% endcapture %}\n\n    {% elsif event.topic contains \"shopify/draft_orders/\" %}\n      {% capture object_link %}draft_orders/{{ draft_order.id | default: 1234567890 }}{% endcapture %}\n\n    {% elsif event.topic contains \"shopify/fulfillment_events/\" %}\n      {% capture object_link %}orders/{{ fulfillment_event.order.id | default: 1234567890 }}{% endcapture %}\n\n    {% elsif event.topic contains \"shopify/fulfillments/\" %}\n      {% capture object_link %}orders/{{ fulfillment.order.id | default: 1234567890 }}{% endcapture %}\n\n    {% elsif event.topic contains \"shopify/orders/\" %}\n      {% capture object_link %}orders/{{ order.id | default: order_edit.order.id | default: 1234567890 }}{% endcapture %}\n\n    {% elsif event.topic contains \"shopify/products/\" %}\n      {% capture object_link %}products/{{ product.id | default: 1234567890 }}{% endcapture %}\n\n    {% elsif event.topic contains \"shopify/refunds/\" %}\n      {% capture object_link %}orders/{{ refund.order.id | default: 1234567890 }}{% endcapture %}\n\n    {% elsif event.topic contains \"shopify/themes/\" %}\n      {% capture object_link %}themes/{{ theme.id | default: 1234567890 }}{% endcapture %}\n    {% endif%}\n\n    {% if object_link != blank %}\n      {% assign object_link = admin_link | append: object_link %}\n    {% else %}\n      {% assign object_link = \"[<small>Object link could not be generated</small>]\" %}\n    {% endif %}\n\n    {% assign email_body = email_body | replace: \"OBJECT_LINK\", object_link %}\n\n    {% action \"email\" %}\n      {\n        \"to\": {{ email_recipients | join: \", \" | json }},\n        \"subject\": {{ email_subject | json }},\n        \"body\": {{ email_body | unindent | newline_to_br | json }},\n        \"from_display_name\": {{ shop.name | json }}\n      }\n    {% endaction %}\n  {% endif %}\n{% endfor %}",
  "docs": "This task allows you to receive an email alert for any event topic supported by Mechanic. Configure the task with a list of email addresses to notify, an email subject, and one or more event topics, each paired with an email body that supports liquid output tags for the main object of each event (e.g. *shopify/products/create* can use attributes like `{{ product.id }}` or `{{ product.title }}`)\n\nThe task comes preloaded with the customers and products create event topics, along with sample email bodies. Configure to taste :) The full list of supported event topics can be found [here](https://docs.usemechanic.com/article/416-all-event-topics).\n\nNote:\n- The task will replace the __OBJECT_LINK__ string within the email body if present (and where it makes sense to do so) with an admin link to the Shopify object related to the event topic.\n- Some event topics, like *shopify/products/update* and *shopify/inventory_levels/update*, can generate **a lot** of emails, so they should be used with caution.\n- When using the *shopify/orders/edited* event topic, the original order can be referenced using `{{ order_edit.order }}`.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": []
}
