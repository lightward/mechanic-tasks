{
  "name": "Automatically cancel orders with certain risk indicators",
  "options": {
    "required_risk_indicator_messages__array_required": [

    ],
    "cancellation_reason": null,
    "ignore_unpaid_orders__boolean": null,
    "attempt_to_void_or_refund_payment_for_cancelled_orders__boolean": null,
    "email_customer_when_cancelling__boolean": null,
    "add_this_order_tag_when_cancelling": null
  },
  "subscriptions": [
    "shopify/orders/updated"
  ],
  "subscriptions_template": "shopify/orders/updated",
  "script": "{% if event.preview %}\n  {% capture order_json %}\n    {\n      \"id\": 1234567890,\n      \"admin_graphql_api_id\": \"gid://shopify/Order/1234567890\",\n      \"cancelled_at\": null,\n      \"financial_status\": \"paid\",\n      \"risks\": [\n        {% for message in options.required_risk_indicator_messages__array_required %}\n          {\n            \"message\": {{ message | json }}\n          }{% unless forloop.last %},{% endunless %}\n        {% endfor %}\n      ]\n    }\n  {% endcapture %}\n\n  {% assign order = order_json | parse_json %}\n{% endif %}\n\n{% assign cancellation_reason = options.cancellation_reason | default: \"other\" %}\n{% assign valid_cancellation_reasons = \"customer,inventory,fraud,declined,other\" | split: \",\" %}\n{% unless valid_cancellation_reasons contains cancellation_reason %}\n  {% error %}\n    {{ \"Cancellation reason \" | append: cancellation_reason | append: \" - must be one of 'customer', 'inventory', 'fraud', 'declined', or 'other'.\" | json }}\n  {% enderror %}\n{% endunless %}\n\n{% assign order_qualifies = true %}\n\n{% if order.cancelled_at != blank %}\n  {% assign order_qualifies = false %}\n{% elsif options.ignore_unpaid_orders__boolean and order.financial_status == \"pending\" %}\n   {% assign order_qualifies = false %}\n{% else %}\n  {% assign found_risk_messages = order.risks | map: \"message\" | sort %}\n  {% assign required_risk_messages = options.required_risk_indicator_messages__array_required | sort %}\n\n  {% for message in required_risk_messages %}\n    {% unless found_risk_messages contains message %}\n      {% assign order_qualifies = false %}\n      {% break %}\n    {% endunless %}\n  {% endfor %}\n\n  {% if found_risk_messages == empty %}\n    {% log \"This order had no risks. Skipping.\" %}\n  {% elsif order_qualifies == false and found_risk_messages != empty %}\n    {% log message: \"Found some risk messages, but not all the ones that are required. Skipping.\", found_risk_messages: found_risk_messages, required_risk_messages: required_risk_messages %}\n  {% endif %}\n{% endif %}\n\n{% if order_qualifies %}\n  {% if options.attempt_to_void_or_refund_payment_for_cancelled_orders__boolean %}\n    {% capture query %}\n      query {\n        order(id: {{ order.admin_graphql_api_id | json }}) {\n          suggestedRefund(suggestFullRefund: true) {\n            amountSet {\n              shopMoney {\n                amount\n                currencyCode\n              }\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = query | shopify %}\n\n    {% if event.preview %}\n      {% capture result_json %}\n        {\n          \"data\": {\n            \"order\": {\n              \"suggestedRefund\": {\n                \"amountSet\": {\n                  \"shopMoney\": {\n                    \"amount\": \"12.34\",\n                    \"currencyCode\": \"USD\"\n                  }\n                }\n              }\n            }\n          }\n        }\n      {% endcapture %}\n\n      {% assign result = result_json | parse_json %}\n    {% endif %}\n\n    {% assign suggested_refund = result.data.order.suggestedRefund.amountSet.shopMoney %}\n  {% else %}\n    {% assign suggested_refund = nil %}\n  {% endif %}\n\n  {% action \"shopify\" %}\n    [\n      \"post\",\n      \"/admin/orders/{{ order.id | json }}/cancel.json\",\n      {\n        {% if suggested_refund %}\n          \"amount\": {{ suggested_refund.amount | json }},\n          \"currency\": {{ suggested_refund.currencyCode | json }},\n        {% endif %}\n        \"reason\": {{ cancellation_reason | json }},\n        \"email\": {{ options.email_customer_when_cancelling__boolean | json }}\n      }\n    ]\n  {% endaction %}\n\n  {% if options.add_this_order_tag_when_cancelling != blank %}\n    {% action \"shopify\" %}\n      mutation {\n        tagsAdd(\n          id: {{ order.admin_graphql_api_id | json }}\n          tags: {{ options.add_this_order_tag_when_cancelling | json }}\n        ) {\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endif %}\n{% endif %}",
  "docs": null,
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false
}
