{
  "docs": "Use this task to receive immediate email notifications whenever inventory/stock levels are adjusted, whether manually or as a result of a transfer or customer order.\n\nPlease note: Mechanic will start sending emails the _second_ time inventory is adjusted for a particular item.\n\nThe following \"replacement\" variables are defined in the task code for usage within the email subject and body. If you wish to include any other additional information, then you will either need to modify the task code to create additional variables, or use a [GraphQL query directly in the task option field](https://learn.mechanic.dev/resources/converting-tasks-from-shopify-rest-to-graphql/conversion-resource-lookups-in-task-option-fields).\n- AVAILABLE\n- DIFFERENCE\n- INVENTORY_HISTORY_LINK\n- LOCATION_NAME\n- MANAGE_VARIANT_LINK\n- SKU\n- TITLE",
  "halt_action_run_sequence_on_error": false,
  "name": "Receive email alerts when inventory levels change",
  "online_store_javascript": null,
  "options": {
    "email_recipient__email_required": "",
    "email_subject__required": "DIFFERENCE inventory for SKU TITLE",
    "email_body__required_multiline": "Currently available inventory: AVAILABLE\nChanged by: DIFFERENCE\nLocation: LOCATION_NAME\n\nINVENTORY_HISTORY_LINK\nMANAGE_VARIANT_LINK\n\nThanks,\n{{ shop.name }}"
  },
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "script": "{% assign email_recipient = options.email_recipient__email_required %}\n{% assign email_subject = options.email_subject__required %}\n{% assign email_body = options.email_body__required_multiline %}\n\n{% if event.preview %}\n  {% capture inventory_level_json %}\n    {\n      \"inventory_item_id\": 1234567890,\n      \"location_id\": 1234567890,\n      \"available\": 5,\n      \"admin_graphql_api_id\": \"gid://shopify/InventoryLevel/1234567890?inventory_item_id=1234567890\"\n    }\n  {% endcapture %}\n\n  {% assign inventory_level = inventory_level_json | parse_json %}\n{% endif %}\n\n{% assign cache_key = \"inventory_level:\" | append: inventory_level.inventory_item_id | append: \"/\" | append: inventory_level.location_id %}\n\n{% assign previous_available = cache[cache_key] %}\n\n{% if event.preview %}\n  {% assign previous_available = 9 %}\n{% endif %}\n\n{% action \"cache\", \"set\", cache_key, inventory_level.available %}\n\n{% if previous_available == blank %}\n  {% break %}\n{% endif %}\n\n{% assign available_difference = inventory_level.available | minus: previous_available %}\n\n{% if available_difference >= 0 %}\n  {% assign available_difference = \"+\" | append: available_difference %}\n{% endif %}\n\n{% comment %}\n  -- get additional data to be used in email content substitutions\n{% endcomment %}\n\n{% capture query %}\n  query {\n    inventoryLevel(id: {{ inventory_level.admin_graphql_api_id | json }}) {\n      location {\n        name\n      }\n      item {\n        inventoryHistoryUrl\n        sku\n        variant {\n          legacyResourceId\n          displayName\n          product {\n            legacyResourceId\n          }\n        }\n      }\n    }\n  }\n{% endcapture %}\n\n{% assign result = query | shopify %}\n\n{% if event.preview %}\n  {% capture result_json %}\n    {\n      \"data\": {\n        \"inventoryLevel\": {\n          \"location\": {\n            \"name\": \"Warehouse A\"\n          },\n          \"item\": {\n            \"inventoryHistoryUrl\": \"https://preview-sample.myshopify.com/admin/products/inventory/1234567890/inventory_history\",\n            \"sku\": \"WDGT123\",\n            \"variant\": {\n              \"legacyResourceId\": \"1234567890\",\n              \"displayName\": \"Widget - Default Title\",\n              \"product\": {\n                \"legacyResourceId\": \"987654321\"\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = result_json | parse_json %}\n{% endif %}\n\n{% assign location_name = result.data.inventoryLevel.location.name %}\n{% assign sku = result.data.inventoryLevel.item.sku %}\n{% assign title = result.data.inventoryLevel.item.variant.displayName | remove: \" - Default Title\" %}\n{% assign variant_id = result.data.inventoryLevel.item.variant.legacyResourceId %}\n{% assign product_id = result.data.inventoryLevel.item.variant.product.legacyResourceId %}\n\n{%- capture inventory_history_link -%}\n  <a href=\"{{ result.data.inventoryLevel.item.inventoryHistoryUrl }}?location_id={{ inventory_level.location_id }}\">View inventory history</a>\n{%- endcapture -%}\n\n{%- capture manage_variant_link -%}\n  <a href=\"{{ shop.admin_url }}products/{{ product_id }}/variants/{{ variant_id }}\">Manage this variant</a>\n{%- endcapture -%}\n\n{% assign email_subject\n  = email_subject\n  | replace: \"DIFFERENCE\", available_difference\n  | replace: \"SKU\", sku\n  | replace: \"TITLE\", title\n%}\n\n{% assign email_body\n  = email_body\n  | replace: \"AVAILABLE\", inventory_level.available\n  | replace: \"DIFFERENCE\", available_difference\n  | replace: \"INVENTORY_HISTORY_LINK\", inventory_history_link\n  | replace: \"LOCATION_NAME\", location_name\n  | replace: \"MANAGE_VARIANT_LINK\", manage_variant_link\n%}\n\n{% action \"email\" %}\n  {\n    \"to\": {{ email_recipient | json }},\n    \"subject\": {{ email_subject | strip | json }},\n    \"body\": {{ email_body | strip | newline_to_br | json }},\n    \"reply_to\": {{ shop.customer_email | json }},\n    \"from_display_name\": {{ shop.name | json }}\n  }\n{% endaction %}\n",
  "subscriptions": [
    "shopify/inventory_levels/update",
    "shopify/inventory_levels/connect"
  ],
  "subscriptions_template": "shopify/inventory_levels/update\nshopify/inventory_levels/connect",
  "tags": [
    "Alert",
    "Email",
    "Inventory"
  ]
}
