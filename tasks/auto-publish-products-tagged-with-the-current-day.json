{
  "docs": "Use this task to automatically roll out your products on specific days of the week. This task runs every midnight, in your shop's local timezone, and it scans your catalog for unpublished products tagged with the current day of the week (e.g. \"Monday\", \"tuesday\", etc).\n\nYou can also run this task manually, to publish any unpublished products tagged with the current day of the week.",
  "halt_action_run_sequence_on_error": false,
  "name": "Auto-publish products tagged with the current day",
  "online_store_javascript": null,
  "options": {},
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "script": "{% assign day_of_week_lowercase = \"now\" | date: \"%A\" | downcase %}\n\n{% comment %}\n  -- get online store publication ID\n  -- Note: title filter does work for app catalog titles, so have to get all publications\n{% endcomment %}\n\n{% capture query %}\n  query {\n    publications(\n      first: 250\n      catalogType:APP\n    ) {\n      nodes {\n        id\n        catalog {\n          ... on AppCatalog {\n            apps(first: 1) {\n              nodes {\n                title\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n{% endcapture %}\n\n{% assign result = query | shopify %}\n\n{% if event.preview %}\n  {% capture result_json %}\n    {\n      \"data\": {\n        \"publications\": {\n          \"nodes\": [\n            {\n              \"id\": \"gid://shopify/Publication/1234567890\",\n              \"catalog\": {\n                \"apps\": {\n                  \"nodes\": [\n                    {\n                      \"title\": \"Online Store\"\n                    }\n                  ]\n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = result_json | parse_json %}\n{% endif %}\n\n{% assign online_store_publication_id = nil %}\n\n{% for publication in result.data.publications.nodes %}\n  {% assign publication_name = publication.catalog.apps.nodes.first.title %}\n\n  {% if publication_name == \"Online Store\" %}\n    {% assign online_store_publication_id = publication.id %}\n  {% endif %}\n{% endfor %}\n\n{% comment %}\n  -- get all unpublished products with the day of week tag (tag search filter is case-insensitive, but using lowercase for tag verification in results)\n{% endcomment %}\n\n{%- capture search_query -%}\n  -published_at:* tag:{{ day_of_week_lowercase | json }}\n{%- endcapture -%}\n\n{% assign cursor = nil %}\n{% assign products = array %}\n\n{% for n in (1..100) %}\n  {% capture query %}\n    query {\n      products(\n        first: 250\n        after: {{ cursor | json }}\n        query: {{ search_query | json }}\n      ) {\n        pageInfo {\n          hasNextPage\n          endCursor\n        }\n        nodes {\n          id\n          tags\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n      {\n        \"data\": {\n          \"products\": {\n            \"nodes\": [\n              {\n                \"id\": \"gid://shopify/Product/1234567890\",\n                \"tags\": {{ array | push: day_of_week_lowercase | json }}\n              }\n            ]\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n\n  {% assign products = products | concat: result.data.products.nodes %}\n\n  {% if result.data.products.pageInfo.hasNextPage %}\n    {% assign cursor = result.data.products.pageInfo.endCursor %}\n  {% else %}\n    {% break %}\n  {% endif %}\n{% endfor %}\n\n{% if products == blank %}\n  {% log \"No unpublished products qualified to be published on this task run.\" %}\n{% endif %}\n\n{% for product in products %}\n  {% comment %}\n    -- validate the product does indeed have the day of week tag exactly, since the tag query filter returns partial matches\n  {% endcomment %}\n\n  {% assign product_tags_lowercase\n    = product.tags\n    | json\n    | downcase\n    | parse_json\n  %}\n\n  {% if product_tags_lowercase contains day_of_week_lowercase %}\n    {% action \"shopify\" %}\n      mutation {\n        publishablePublish(\n          id: {{ product.id | json }}\n          input: {\n            publicationId: {{ online_store_publication_id | json }}\n          }\n        ) {\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endif %}\n{% endfor %}\n",
  "subscriptions": [
    "mechanic/scheduler/daily",
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "mechanic/scheduler/daily\nmechanic/user/trigger",
  "tags": [
    "Products",
    "Publish",
    "Tag",
    "Watch"
  ]
}
