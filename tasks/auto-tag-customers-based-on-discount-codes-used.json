{
  "docs": "Use this task to easily identify customers who used certain discount codes. This task runs automatically on incoming orders, and can be run manually to tag customers based on historical orders. Optionally, choose to remove tags, instead of adding them.\n\nThis task runs automatically on incoming orders. Run this task manually to scan your store's order history, tagging customers based on historical orders.",
  "halt_action_run_sequence_on_error": false,
  "name": "Auto-tag customers based on discount codes used",
  "online_store_javascript": null,
  "options": {
    "discount_codes_and_tags__keyval_required": {},
    "untag_customers_instead_of_tagging_them__boolean": null,
    "allow_partial_matches_when_checking_for_discount_codes__boolean": null
  },
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "script": "{% assign discount_codes_and_tags = options.discount_codes_and_tags__keyval_required %}\n{% assign untag_customers_instead_of_tagging_them = options.untag_customers_instead_of_tagging_them__boolean %}\n{% assign allow_partial = options.allow_partial_matches_when_checking_for_discount_codes__boolean %}\n\n{% if event.topic == \"shopify/orders/create\" %}\n  {% comment %}\n    -- for new orders, only check discounts on that order, not all of a customer's orders\n  {% endcomment %}\n\n  {% capture query %}\n    query {\n      order(id: {{ order.admin_graphql_api_id | json }}) {\n        discountCodes\n        customer {\n          id\n          tags\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n      {\n        \"data\": {\n          \"order\": {\n            \"discountCodes\": {{ discount_codes_and_tags | keys | json }},\n            \"customer\": {\n              \"id\": \"gid://shopify/Customer/1234567890\"\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n\n  {% assign order = result.data.order %}\n  {% assign customer = order.customer %}\n\n  {% if order.discountCodes == blank %}\n    {% log \"No discount codes for this order; nothing to do.\" %}\n    {% break %}\n  {% endif %}\n\n  {% assign order_discount_codes_downcase\n    = order.discountCodes\n    | json\n    | downcase\n    | parse_json\n  %}\n\n  {% assign customer_tags_downcase\n    = customer.tags\n    | json\n    | downcase\n    | parse_json\n  %}\n\n  {% assign tags_to_add = array %}\n  {% assign tags_to_remove = array %}\n\n  {% comment %}\n    -- use downcased strings for code and tag comparisons; however, add/remove tags using the configured values\n  {% endcomment %}\n\n  {% for keyval in discount_codes_and_tags %}\n    {% assign discount_code_downcase = keyval[0] | downcase %}\n    {% assign tag_downcase = keyval[1] | downcase %}\n\n    {% if allow_partial %}\n      {% for order_discount_code_downcase in order_discount_codes_downcase %}\n        {% if order_discount_code_downcase contains discount_code_downcase %}\n          {% if untag_customers_instead_of_tagging_them %}\n            {% if customer_tags_downcase contains tag_downcase %}\n              {% assign tags_to_remove = tags_to_remove | push: keyval[1] %}\n            {% endif %}\n\n          {% else %}\n            {% unless customer_tags_downcase contains tag_downcase %}\n              {% assign tags_to_add = tags_to_add | push: keyval[1] %}\n            {% endunless %}\n          {% endif %}\n\n          {% break %}\n        {% endif %}\n      {% endfor %}\n\n    {% elsif order_discount_codes_downcase contains discount_code_downcase %}\n      {% if untag_customers_instead_of_tagging_them %}\n        {% if customer_tags_downcase contains tag_downcase %}\n          {% assign tags_to_remove = tags_to_remove | push: keyval[1] %}\n        {% endif %}\n\n      {% else %}\n        {% unless customer_tags_downcase contains tag_downcase %}\n          {% assign tags_to_add = tags_to_add | push: keyval[1] %}\n        {% endunless %}\n      {% endif %}\n    {% endif %}\n  {% endfor %}\n\n  {% if tags_to_add != blank %}\n    {% action \"shopify\" %}\n      mutation {\n        tagsAdd(\n          id: {{ customer.id | json }}\n          tags: {{ tags_to_add | json }}\n        ) {\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endif %}\n\n  {% if tags_to_remove != blank %}\n    {% action \"shopify\" %}\n      mutation {\n        tagsRemove(\n          id: {{ customer.id | json }}\n          tags: {{ tags_to_remove | json }}\n        ) {\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endif %}\n\n{% elsif event.topic == \"mechanic/user/trigger\" %}\n  {% comment %}\n    -- get all customers who have placed an order, and each of their orders where one or more discount codes were used\n  {% endcomment %}\n\n  {% capture bulk_operation_query %}\n    query {\n      customers(query: \"orders_count:>0\") {\n        edges {\n          node {\n            __typename\n            id\n            tags\n            orders(query: \"discount_code:*\") {\n              edges {\n                node {\n                  __typename\n                  discountCodes\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% action \"shopify\" %}\n    mutation {\n      bulkOperationRunQuery(\n        query: {{ bulk_operation_query | json }}\n      ) {\n        bulkOperation {\n          id\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n\n{% elsif event.topic == \"mechanic/shopify/bulk_operation\" %}\n  {% if event.preview %}\n    {% capture jsonl_string %}\n      {\"__typename\": \"Customer\",\"id\": \"gid://shopify/Customer/1234567890\"}\n      {\"__typename\": \"Order\",\"discountCodes\":{{ discount_codes_and_tags | keys | json }},\"__parentId\":\"gid://shopify/Customer/1234567890\"}\n      {\"__typename\": \"Customer\",\"id\": \"gid://shopify/Customer/2345678901\",\"tags\":{{ discount_codes_and_tags | values | json }}}\n      {\"__typename\": \"Order\",\"discountCodes\":{{ discount_codes_and_tags | keys | json }},\"__parentId\":\"gid://shopify/Customer/2345678901\"}\n    {% endcapture %}\n\n    {% assign bulkOperation = hash %}\n    {% assign bulkOperation[\"objects\"] = jsonl_string | parse_jsonl %}\n  {% endif %}\n\n  {% assign customers = bulkOperation.objects | where: \"__typename\", \"Customer\" %}\n  {% assign orders = bulkOperation.objects | where: \"__typename\", \"Order\" %}\n\n  {% comment %}\n    -- loop through customers to see which qualify for tag updates\n  {% endcomment %}\n\n  {% for customer in customers %}\n    {% assign customer_orders = orders | where: \"__parentId\", customer.id %}\n\n    {% if customer_orders == blank %}\n      {% continue %}\n    {% endif %}\n\n    {% assign customer_discount_codes_downcase = array %}\n\n    {% for customer_order in customer_orders %}\n      {% assign customer_discount_codes_downcase\n        = customer_order.discountCodes\n        | json\n        | downcase\n        | parse_json\n        | concat: customer_discount_codes_downcase\n        | uniq\n      %}\n    {% endfor %}\n\n    {% assign customer_tags_downcase\n      = customer.tags\n      | json\n      | downcase\n      | parse_json\n    %}\n\n    {% assign tags_to_add = array %}\n    {% assign tags_to_remove = array %}\n\n    {% comment %}\n      -- use downcased strings for code and tag comparisons; however, add/remove tags using the configured values\n    {% endcomment %}\n\n    {% for keyval in discount_codes_and_tags %}\n      {% assign discount_code_downcase = keyval[0] | downcase %}\n      {% assign tag_downcase = keyval[1] | downcase %}\n\n      {% if allow_partial %}\n        {% for customer_discount_code_downcase in customer_discount_codes_downcase %}\n          {% if customer_discount_code_downcase contains discount_code_downcase %}\n            {% if untag_customers_instead_of_tagging_them %}\n              {% if customer_tags_downcase contains tag_downcase %}\n                {% assign tags_to_remove = tags_to_remove | push: keyval[1] %}\n              {% endif %}\n\n            {% else %}\n              {% unless customer_tags_downcase contains tag_downcase %}\n                {% assign tags_to_add = tags_to_add | push: keyval[1] %}\n              {% endunless %}\n            {% endif %}\n\n            {% break %}\n          {% endif %}\n        {% endfor %}\n\n      {% elsif customer_discount_codes_downcase contains discount_code_downcase %}\n        {% if untag_customers_instead_of_tagging_them %}\n          {% if customer_tags_downcase contains tag_downcase %}\n            {% assign tags_to_remove = tags_to_remove | push: keyval[1] %}\n          {% endif %}\n\n        {% else %}\n          {% unless customer_tags_downcase contains tag_downcase %}\n            {% assign tags_to_add = tags_to_add | push: keyval[1] %}\n          {% endunless %}\n        {% endif %}\n      {% endif %}\n    {% endfor %}\n\n    {% if tags_to_add != blank %}\n      {% action \"shopify\" %}\n        mutation {\n          tagsAdd(\n            id: {{ customer.id | json }}\n            tags: {{ tags_to_add | uniq | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endif %}\n\n    {% if tags_to_remove != blank %}\n      {% action \"shopify\" %}\n        mutation {\n          tagsRemove(\n            id: {{ customer.id | json }}\n            tags: {{ tags_to_remove | uniq | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endif %}\n  {% endfor %}\n{% endif %}\n",
  "subscriptions": [
    "shopify/orders/create",
    "mechanic/user/trigger",
    "mechanic/shopify/bulk_operation"
  ],
  "subscriptions_template": "shopify/orders/create\nmechanic/user/trigger\nmechanic/shopify/bulk_operation",
  "tags": [
    "Auto-Tag",
    "Customers",
    "Discounts"
  ]
}
