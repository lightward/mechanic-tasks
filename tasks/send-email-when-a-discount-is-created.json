{
  "docs": "Use this task to send email notifications whenever discounts are created in your shop. Optionally, you may choose to monitor when specific apps create discounts.\n\nEach notification will provide a summary of the discount with an admin link back to the full discount detail page.",
  "halt_action_run_sequence_on_error": false,
  "name": "Send email when a discount is created",
  "online_store_javascript": null,
  "options": {
    "email_receipients__array_required": null,
    "app_names_to_monitor__array": null
  },
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "preview_event_definitions": [],
  "script": "{% assign email_recipients = options.email_receipients__array_required %}\n{% assign app_names_to_monitor = options.app_names_to_monitor__array %}\n\n{% if event.topic == \"shopify/discounts/create\" or event.topic == \"shopify/discounts/update\" %}\n  {% comment %}\n    -- data from the webhook is sparse, so query additional discount data to be included in the notification\n  {% endcomment %}\n\n  {% capture query %}\n    query {\n      discountNode(id: {{ discount.admin_graphql_api_id | json }}) {\n        id\n        events(\n          first: 1\n          query: \"verb:create\"\n        ) {\n          nodes {\n            id\n            appTitle\n          }\n        }\n        discount {\n          __typename\n          ... on DiscountAutomaticBasic {\n            combinesWith {\n              productDiscounts\n              orderDiscounts\n              shippingDiscounts\n            }\n            createdAt\n            discountClass\n            endsAt\n            startsAt\n            status\n            summary\n            title\n          }\n          ... on DiscountCodeBasic {\n            combinesWith {\n              productDiscounts\n              orderDiscounts\n              shippingDiscounts\n            }\n            createdAt\n            discountClass\n            endsAt\n            startsAt\n            status\n            summary\n            title\n            usageLimit\n          }\n          ... on DiscountAutomaticBxgy {\n            combinesWith {\n              productDiscounts\n              orderDiscounts\n              shippingDiscounts\n            }\n            createdAt\n            customerBuys {\n              items {\n                __typename\n              }\n            }\n            customerGets {\n              items {\n                __typename\n              }\n            }\n            endsAt\n            startsAt\n            status\n            summary\n            title\n          }\n          ... on DiscountCodeBxgy {\n            combinesWith {\n              productDiscounts\n              orderDiscounts\n              shippingDiscounts\n            }\n            createdAt\n            customerBuys {\n              items {\n                __typename\n              }\n            }\n            customerGets {\n              items {\n                __typename\n              }\n            }\n            endsAt\n            startsAt\n            status\n            summary\n            title\n            usageLimit\n          }\n          ... on DiscountAutomaticFreeShipping {\n            combinesWith {\n              productDiscounts\n              orderDiscounts\n              shippingDiscounts\n            }\n            createdAt\n            endsAt\n            startsAt\n            status\n            summary\n            title\n          }\n          ... on DiscountCodeFreeShipping {\n            combinesWith {\n              productDiscounts\n              orderDiscounts\n              shippingDiscounts\n            }\n            createdAt\n            endsAt\n            startsAt\n            status\n            summary\n            title\n            usageLimit\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n      {\n        \"data\": {\n          \"discountNode\": {\n            \"id\": \"gid://shopify/DiscountNode/1234567890\",\n            \"events\": {\n              \"nodes\": [\n                {\n                  \"appTitle\": {{ app_names_to_monitor.first | json }}\n                }\n              ]\n            },\n            \"discount\": {\n              \"__typename\": \"DiscountCodeBasic\",\n              \"combinesWith\": {\n                \"productDiscounts\": false,\n                \"orderDiscounts\": false,\n                \"shippingDiscounts\": true\n              },\n              \"discountClass\": \"PRODUCT\",\n              \"endsAt\": \"2024-10-31T07:59:59Z\",\n              \"startsAt\": \"2024-10-01T08:00:00Z\",\n              \"summary\": \"30% off Widget • Minimum quantity of 3 • Applies once per order\",\n              \"title\": \"PREVIEW-CODE\",\n              \"usageLimit\": 100\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n\n  {% unless event.preview %}\n    {% log discount_node: result.data.discountNode %}\n  {% endunless %}\n\n  {% assign discount = result.data.discountNode.discount %}\n  {% assign app_title = result.data.discountNode.events.nodes.first.appTitle %}\n  {% assign discount_type = discount.__typename %}\n\n  {% comment %}\n    -- ignore custom discount types and filter by app names if configured\n  {% endcomment %}\n\n  {% if discount_type == \"DiscountAutomaticApp\" or discount_type == \"DiscountCodeApp\" %}\n    {% log\n      message: \"This task does not support app-generated, custom discount types.\",\n      discount_type: discount_type,\n      app_title: app_title\n    %}\n    {% break %}\n\n  {% elsif app_names_to_monitor != blank %}\n    {% unless app_names_to_monitor contains app_title %}\n      {% log\n        message: \"This discount was created by an app that is not in the 'App names to monitor' list.\",\n        app_title: app_title,\n        app_names_to_monitor: app_names_to_monitor\n      %}\n      {% break %}\n    {% endunless %}\n  {% endif %}\n\n  {% comment %}\n    -- create human-readable output from various field types and values\n  {% endcomment %}\n\n  {% if discount_type contains \"Automatic\" %}\n    {% assign discount_method = \"Automatic\" %}\n\n  {% elsif discount_type contains \"Code\" %}\n    {% assign discount_method = \"Code\" %}\n\n    {% comment %}\n      -- customer limits are included in the summary field, so only handle total usage limits here\n    {% endcomment %}\n\n    {% if discount.usageLimit %}\n      {%- capture maximum_discount_uses -%}\n        Limit of {{ discount.usageLimit }} total use{% if discount.usageLimit > 1 %}s{% endif %}\n      {%- endcapture -%}\n    {% else %}\n      {% assign maximum_discount_uses = \"No total usage limits\" %}\n    {% endif %}\n  {% endif %}\n\n  {% case discount_type %}\n    {% when \"DiscountAutomaticBasic\" or \"DiscountCodeBasic\" %}\n      {% assign discount_type_output = discount.discountClass | capitalize %}\n\n    {% when \"DiscountAutomaticBxgy\" or \"DiscountCodeBxgy\" %}\n      {% assign discount_type_output = \"Buy X Get Y\" %}\n\n    {% when \"DiscountAutomaticFreeShipping\" or \"DiscountCodeFreeShipping\" %}\n      {% assign discount_type_output = \"Free Shipping\" %}\n  {% endcase %}\n\n  {% comment %}\n    -- all discount types support combining with other discounts\n  {% endcomment %}\n\n  {% assign combines_with = array %}\n\n  {% if discount.combinesWith.productDiscounts %}\n    {% assign combines_with = combines_with | push: \"product\" %}\n  {% endif %}\n\n  {% if discount.combinesWith.orderDiscounts %}\n    {% assign combines_with = combines_with | push: \"order\" %}\n  {% endif %}\n\n  {% if discount.combinesWith.shippingDiscounts %}\n    {% assign combines_with = combines_with | push: \"shipping\" %}\n  {% endif %}\n\n  {% if combines_with == blank %}\n    {% assign combines_with_output = \"Can’t combine with other discounts\" %}\n\n  {% else %}\n    {% if combines_with.size == 3 %}\n      {% capture combines_with_output -%}\n        Combines with {{ combines_with[0] }}, {{ combines_with[1] }}, and {{ combines_with[2] }} discounts\n      {%- endcapture %}\n\n    {% elsif combines_with.size == 2 %}\n      {% capture combines_with_output -%}\n        Combines with {{ combines_with[0] }} and {{ combines_with[1] }} discounts\n      {%- endcapture %}\n\n    {% else %}\n      {% capture combines_with_output -%}\n        Combines with {{ combines_with[0] }} discounts\n      {%- endcapture %}\n    {% endif %}\n  {% endif %}\n\n  {% capture active_dates -%}\n    Active from {{ discount.startsAt | date: \"%b %e\" }}{% if discount.endsAt %} to {{ discount.endsAt | date: \"%b %e\" }}{% endif %}\n  {%- endcapture %}\n\n  {% comment %}\n    -- details will vary by discount type, method, and configuration; start with shared details\n  {% endcomment %}\n\n  {% assign details = array | push: combines_with_output, active_dates %}\n\n  {% if discount_method == \"Code\" %}\n    {% assign details = details | unshift: maximum_discount_uses  %}\n  {% endif %}\n\n  {% if discount_type contains \"Bxgy\" %}\n    {% case discount.customerBuys.items.__typename %}\n      {% when \"AllDiscountItems\" %}\n        {% assign customer_buys = \"Can buy any product\" %}\n\n      {% when \"DiscountCollections\" %}\n        {% assign customer_buys = \"Must buy products from specific collections\" %}\n\n      {% when \"DiscountProducts\" %}\n        {% assign customer_buys = \"Must buy specific products\" %}\n    {% endcase %}\n\n    {% case discount.customerGets.items.__typename %}\n      {% when \"AllDiscountItems\" %}\n        {% assign customer_gets = \"Applies to all items\" %}\n\n      {% when \"DiscountCollections\" %}\n        {% assign customer_gets = \"Applies to products from specific collections\" %}\n\n      {% when \"DiscountProducts\" %}\n        {% assign customer_gets = \"Applies to specific products\" %}\n    {% endcase %}\n\n    {% assign details = details | unshift: customer_buys, customer_gets  %}\n  {% endif %}\n\n  {% comment %}\n    -- the discount summary only includes some of the details; concatenate with the details determined through logic above\n  {% endcomment %}\n\n  {% assign details = discount.summary | split: \" • \" | concat: details %}\n\n  {% unless event.preview %}\n    {% log\n      title: discount.title,\n      app_title: app_title,\n      details: details,\n      summary: discount.summary,\n      discount_class: discount.discountClass,\n      discount_type: discount_type,\n      customer_buys: customer_buys,\n      customer_gets: customer_gets,\n      maximum_discount_uses: maximum_discount_uses,\n      combines_with: combines_with\n    %}\n  {% endunless %}\n\n  {% capture email_subject %}\n    {{ discount_type_output }} discount created - {{ discount.title }}\n  {% endcapture %}\n\n  {% capture email_body %}\n    <strong>Title:</strong> {{ discount.title }}\n    <br/>\n    <strong>Method:</strong> {{ discount_method }}\n    {% if app_title != blank and app_title != \"Shopify Web\" %}\n      <br/>\n      <strong>Created by:</strong> {{ app_title }}\n    {% endif %}\n    <br/>\n    <strong>Details:</strong>\n    <ul>\n      {% for detail in details %}\n        <li>{{ detail }}</li>\n      {% endfor %}\n    </ul>\n    <br/><br/>\n    <a href='https://admin.shopify.com/store/{{ shop.myshopify_domain | remove: \".myshopify.com\" }}/discounts/{{ discount.admin_graphql_api_id | remove: \"gid://shopify/Discount/\" }}'>See the full discount configuration in Shopify admin</a>\n  {% endcapture %}\n\n  {% action \"email\" %}\n    {\n      \"to\": {{ email_recipients | json }},\n      \"subject\": {{ email_subject | json }},\n      \"body\": {{ email_body | json }},\n      \"reply_to\": {{ shop.customer_email | json }},\n      \"from_display_name\": {{ shop.name | json }}\n    }\n  {% endaction %}\n{% endif %}\n",
  "subscriptions": [
    "shopify/discounts/create"
  ],
  "subscriptions_template": "shopify/discounts/create",
  "tags": [
    "Discounts",
    "Email"
  ]
}
