{
  "docs": "Use this task to auto-reserve all of the line items for a set amount of time on qualifying new or updated draft orders. A common use case is when you have an app or service that is creating draft orders on your behalf and you want to make sure that the inventory for those orders is set aside if possible.\n\nOptionally, configure the task with one or more tags in the \"Include draft orders with any of these tags\" field, or configure the task with one or more tags in the \"Exclude draft orders with any of these tags\" field. Exclusion tags will be ignored if any inclusion tags are configured.\n\n**Important notes:**\n\n- **If no tags are configured, this task will attempt to reserve inventory on all new or updated draft orders**\n- This task does not check the inventory of any line items before reserving them\n- Line items can only be reserved at the default location configured in Shopify, since draft orders do not support location assignment\n- The 10 second delay on the draft order update subscription should be left as configured to prevent interference with draft order completion events",
  "halt_action_run_sequence_on_error": false,
  "name": "Auto-reserve draft order items for X days",
  "online_store_javascript": null,
  "options": {
    "amount_of_days_to_reserve__number_required": null,
    "include_draft_orders_with_any_of_these_tags__array": [
      "RESERVE"
    ],
    "exclude_draft_orders_with_any_of_these_tags__array": null
  },
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": true,
  "preview_event_definitions": [],
  "script": "{% assign amount_of_days_to_reserve = options.amount_of_days_to_reserve__number_required | floor %}\n{% assign inclusion_tags = options.include_draft_orders_with_any_of_these_tags__array %}\n{% assign exclusion_tags = options.exclude_draft_orders_with_any_of_these_tags__array %}\n\n{% if amount_of_days_to_reserve < 1 %}\n  {% error \"The amount of days to reserve must be a positive number.\" %}\n{% endif %}\n\n{% if inclusion_tags != blank and exclusion_tags != blank %}\n  {% log \"Exclusion tags will be ignored if any inclusion tags are configured.\" %}\n{% endif %}\n\n{% if event.topic == \"shopify/draft_orders/create\" or event.topic == \"shopify/draft_orders/update\" %}\n  {% comment %}\n    -- get draft order data\n  {% endcomment %}\n\n  {% capture query %}\n    query {\n      draftOrder(id: {{ draft_order.admin_graphql_api_id | json }}) {\n        id\n        reserveInventoryUntil\n        status\n        tags\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n      {\n        \"data\": {\n          \"draftOrder\": {\n            \"id\": \"gid://shopify/DraftOrder/1234567890\",\n            \"tags\": {{ array | push: inclusion_tags.first | json }}\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n\n  {% assign draft_order_data = result.data.draftOrder %}\n\n  {% unless draft_order_data %}\n    {% log \"Failed to fetch draft order data; skipping.\" %}\n    {% break %}\n  {% endunless %}\n\n  {% assign draft_order_tags_lowercase = draft_order_data.tags | json | downcase | parse_json %}\n\n  {% log draft_order: draft_order_data %}\n\n  {% if draft_order_data.status == \"COMPLETED\" %}\n    {% log \"This draft order has already been completed; skipping.\" %}\n    {% break %}\n  {% endif %}\n\n  {% if draft_order_data.reserveInventoryUntil != blank %}\n    {% log %}\n      \"Draft order already has a reservation date set ({{ draft_order_data.reserveInventoryUntil | date: \"%FT%T\" }}); skipping.\"\n    {% endlog %}\n    {% break %}\n  {% endif %}\n\n  {% comment %}\n    -- first check if there are any inclusion tags configured, and if not then check for exclusion tags\n  {% endcomment %}\n\n  {% if inclusion_tags != blank %}\n    {% assign draft_order_qualifies = false %}\n    {% assign inclusion_tags_lowercase = inclusion_tags | json | downcase | parse_json %}\n\n    {% for inclusion_tag_lowercase in inclusion_tags_lowercase %}\n      {% if draft_order_tags_lowercase contains inclusion_tag_lowercase %}\n        {% assign draft_order_qualifies = true %}\n        {% break %}\n      {% endif %}\n    {% endfor %}\n\n  {% elsif exclusion_tags != blank %}\n    {% assign draft_order_qualifies = true %}\n    {% assign exclusion_tags_lowercase = exclusion_tags | json | downcase | parse_json %}\n\n    {% for exclusion_tag_lowercase in exclusion_tags_lowercase %}\n      {% if draft_order_tags_lowercase contains exclusion_tag_lowercase %}\n        {% assign draft_order_qualifies = false %}\n        {% break %}\n      {% endif %}\n    {% endfor %}\n\n  {% else %}\n    {% log \"No inclusion or exclusion tags are configured; all draft orders will attempt to reserve inventory.\" %}\n    {% assign draft_order_qualifies = true %}\n  {% endif %}\n\n  {% unless draft_order_qualifies %}\n    {% log \"This draft order either does not have an inclusion tag, or it has an exclusion tag; skipping.\" %}\n    {% break %}\n  {% endunless %}\n\n  {% comment %}\n    -- calculate the reserve date to be 1 minute before midnight on the calculated reserve date (local shop time)\n    -- this follows default convention used in Shopify admin\n  {% endcomment %}\n\n  {%- capture reserve_duration -%}\n    +{{ amount_of_days_to_reserve | plus: 1 }} days\n  {%- endcapture -%}\n\n  {% assign reserve_date\n    = \"now\"\n    | date: \"%F\", advance: reserve_duration\n    | date: \"%FT%TZ\", tz: \"UTC\", advance: \"-1 minute\"\n  %}\n\n  {% log %}\n    \"Reserve until (local shop time): {{ reserve_date | date: \"%FT%T\" }}\"\n  {% endlog %}\n\n  {% comment %}\n    -- update the draft order with the reserve date\n  {% endcomment %}\n\n  {% unless draft_order_data == nil or draft_order_data.id == nil %}\n    {% action \"shopify\" %}\n    mutation {\n      draftOrderUpdate(\n        id: {{ draft_order_data.id | json }}\n        input: {\n          reserveInventoryUntil: {{ reserve_date | json }}\n        }\n      ) {\n        userErrors {\n          field\n          message\n        }\n        draftOrder {\n          name\n          reserveInventoryUntil\n        }\n      }\n    }\n    {% endaction %}\n  {% endunless %}\n{% endif %}\n",
  "subscriptions": [
    "shopify/draft_orders/create",
    "shopify/draft_orders/update+10.seconds"
  ],
  "subscriptions_template": "shopify/draft_orders/create\nshopify/draft_orders/update+10.seconds",
  "tags": [
    "Draft Orders",
    "Products",
    "Reserve"
  ]
}
