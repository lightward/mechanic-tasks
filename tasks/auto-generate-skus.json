{
  "docs": "Save time by letting this task keep your SKUs up to date, generating them based on your product handle, and the initials of each variant option. Optionally, choose to have the task skip updating variants that already have SKUs. Useful for large catalogs, or for anyone who has a consistent SKU format.\n\nPlease note: This task updates SKUs for all products, whether or not they're configured with options and variants.\n\nThis task automatically maintains SKUs by combining these elements and joining them with a dash:\n\n1. The last portion of the product handle (e.g. `503`, if your product is available at `myshop.com/products/stylish-shirt-503`)\n2. The capital letters of the variant's first option, if there is one (e.g. `H` if the option is `Heather gray`, or `HG` if the option is `Heather Gray`)\n3. The capital letters of the variant's second option, if there is one\n4. The capital letters of the variant's third option, if there is one\n\n(To use the product option's full value, instead of abbreviating it, add the option name to the \"Product options to keep unabbreviated\" list.)\n\nTo illustrate, a shirt available at `myshop.com/products/stylish-shirt-503`, with options for size and color, might have these SKUs auto-generated:\n\n* Medium, Black: `503-M-B`\n* XL, Heather gray: `503-XL-H`\n* Small, Red: `503-S-R`\n\nTo update your product handle, so as to control the first portion of generated SKUs, open the product in the Shopify admin, scroll to the bottom of the page, click the edit icon next to \"Search engine listing\", and update the \"URL handle\" field to taste. :)",
  "halt_action_run_sequence_on_error": false,
  "name": "Auto-generate SKUs",
  "online_store_javascript": null,
  "options": {
    "skip_variants_that_already_have_skus__boolean": true,
    "product_options_to_keep_unabbreviated__array": null
  },
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "script": "{% assign skip_variants_that_already_have_skus = options.skip_variants_that_already_have_skus__boolean %}\n{% assign product_options_to_keep_unabbreviated = options.product_options_to_keep_unabbreviated__array %}\n\n{% assign allowed_characters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\" %}\n\n{% assign sku_base = product.handle | split: \"-\" | last | upcase %}\n\n{% if event.preview %}\n  {% assign sku_base = \"503\" %}\n{% endif %}\n\n{% assign cursor = nil %}\n{% assign variants = array %}\n\n{% for n in (1..8) %}\n  {% capture query %}\n    query {\n      product(id: {{ product.admin_graphql_api_id | json }}) {\n        id\n        handle\n        variants(\n          first: 250\n          after: {{ cursor | json }}\n        ) {\n          pageInfo {\n            hasNextPage\n            endCursor\n          }\n          nodes {\n            inventoryItem {\n              id\n            }\n            sku\n            selectedOptions {\n              name\n              value\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n      {\n        \"data\": {\n          \"product\": {\n            \"variants\": {\n              \"nodes\": [\n                {\n                  \"inventoryItem\": {\n                    \"id\": \"gid://shopify/InventoryItem/1234567890\"\n                  },\n                  {% unless skip_variants_that_already_have_skus %}\"sku\": \"503-XL-G\",{% endunless %}\n                  \"selectedOptions\": [\n                    {\n                      \"name\": \"Size\",\n                      \"value\": \"XL\"\n                    },\n                    {\n                      \"name\": \"Color\",\n                      \"value\": \"Heather Grey\"\n                    }\n                  ]\n                }\n              ]\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n\n  {% assign variants = variants | concat: result.data.product.variants.nodes %}\n\n  {% if result.data.product.variants.pageInfo.hasNextPage %}\n    {% assign cursor = result.data.product.variants.pageInfo.endCursor %}\n  {% else %}\n    {% break %}\n  {% endif %}\n{% endfor %}\n\n{% for variant in variants %}\n  {% if skip_variants_that_already_have_skus and variant.sku != blank %}\n    {% log\n      message: \"variant already has a sku; skipping\",\n      original_sku: variant.sku\n    %}\n    {% continue %}\n  {% endif %}\n\n  {% assign variant_sku_generated = sku_base %}\n\n  {% for selected_option in variant.selectedOptions %}\n    {% if product_options_to_keep_unabbreviated contains selected_option.name %}\n      {% assign variant_sku_generated = variant_sku_generated | append: \"-\" | append: selected_option.value %}\n\n    {% else %}\n      {% assign variant_option_abbreviation = \"\" %}\n      {% assign variant_option_characters = selected_option.value | split: \"\" %}\n\n      {% for variant_option_character in variant_option_characters %}\n        {% if allowed_characters contains variant_option_character %}\n          {% assign variant_option_abbreviation = variant_option_abbreviation | append: variant_option_character %}\n        {% endif %}\n      {% endfor %}\n\n      {% if variant_option_abbreviation == blank %}\n        {% assign variant_option_abbreviation = variant_option_characters[0] | upcase %}\n      {% endif %}\n\n      {% assign variant_sku_generated = variant_sku_generated | append: \"-\" | append: variant_option_abbreviation %}\n    {% endif %}\n  {% endfor %}\n\n  {% if variant_sku_generated != variant.sku %}\n    {% log\n      message: \"updating sku\",\n      original_sku: variant.sku,\n      generated_sku: variant_sku_generated\n    %}\n\n    {% comment %}\n      -- as of the 2024-07 API, SKUs are updated on inventory items instead of variants\n    {% endcomment %}\n\n    {% action \"shopify\" %}\n      mutation {\n        inventoryItemUpdate(\n          id: {{ variant.inventoryItem.id | json }}\n          input: {\n            sku: {{ variant_sku_generated | json }}\n          }\n        ) {\n          inventoryItem {\n            variant {\n              id\n              displayName\n              sku\n            }\n          }\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endif %}\n{% endfor %}\n",
  "subscriptions": [
    "shopify/products/create",
    "shopify/products/update"
  ],
  "subscriptions_template": "shopify/products/create\nshopify/products/update",
  "tags": [
    "SKU"
  ]
}
