{
  "name": "Email a CSV export of orders",
  "options": {
    "search_query_for_orders": "fulfillment_status:unshipped",
    "ignore_orders_with_this_tag": "exported",
    "add_this_tag_after_export": "exported",
    "export_email_recipient__email_required": "",
    "export_email_subject__required": "Unfulfilled orders for {{ \"now\" | date: \"%Y-%m-%d\" }}",
    "export_email_body__required_multiline": "Hello,\n\nPlease see the attachment for currently unfulfilled orders.\n\nThanks,\nMechanic, for {{ shop.name }}",
    "export_csv_filename__required": "unfulfilled-orders-{{ \"now\" | date: \"%Y-%m-%d\" }}",
    "run_export_nightly__boolean": false
  },
  "subscriptions": [
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "mechanic/user/trigger\n{% if options.run_export_nightly__boolean %}mechanic/scheduler/daily{% endif %}",
  "script": "{% assign cursor = nil %}\n{% assign order_ids = array %}\n\n{% for n in (0..100) %}\n  {% capture query %}\n    query {\n      orders(\n        first: 250\n        query: {{ options.search_query_for_orders | default: \"\" | json }}\n        after: {{ cursor | json }}\n      ) {\n        pageInfo {\n          hasNextPage\n        }\n        edges {\n          cursor\n          node {\n            id\n            tags\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% for edge in result.data.orders.edges %}\n    {% if options.ignore_orders_with_this_tag != blank and edge.node.tags contains options.ignore_orders_with_this_tag %}\n      {% continue %}\n    {% endif %}\n\n    {% assign order_ids[order_ids.size] = edge.node.id %}\n  {% endfor %}\n\n  {% if result.data.orders.pageInfo.hasNextPage %}\n    {% assign cursor = result.data.orders.edges.last.cursor %}\n  {% else %}\n    {% break %}\n  {% endif %}\n{% endfor %}\n\n{% assign csv = array %}\n{% assign csv[0] = \"Customer ID,First Order Date,Customer E-mail,Shipping First Name,Shipping Last Name,Shipping Address 1,Shipping Address 2,Shipping City,Shipping Province,Shipping Country,Shipping Zip,Shipping Phone,Billing First Name,Billing Last Name,Billing Address 1,Billing Address 2,Billing City,Billing Province,Billing Country,Billing Zip,Billing Phone,Current Purchase Date,Product ID,Product Title,Variant ID,Variant Title,Tags,Quantity,Price,SKU,Shipping Code,Shipping Name\" | split: \",\" %}\n\n{% for order_id in order_ids %}\n  {% capture query %}\n    query {\n      order(id: {{ order_id | json }}) {\n        id\n        tags\n        name\n        processedAt\n        shippingAddress {\n          firstName\n          lastName\n          address1\n          address2\n          city\n          province\n          country\n          zip\n          phone\n        }\n        billingAddress {\n          firstName\n          lastName\n          address1\n          address2\n          city\n          province\n          country\n          zip\n          phone\n        }\n        customer {\n          legacyResourceId\n          email\n          orders(\n            first: 1\n            sortKey: PROCESSED_AT\n          ) {\n            edges {\n              node {\n                processedAt\n              }\n            }\n          }\n        }\n        lineItems(first: 150) {\n          edges {\n            node {\n              product {\n                legacyResourceId\n                title\n                tags\n              }\n              variant {\n                legacyResourceId\n                title\n              }\n              customAttributes {\n                key\n                value\n              }\n              quantity\n              discountedTotalSet {\n                shopMoney {\n                  amount\n                  currencyCode\n                }\n              }\n              sku\n            }\n          }\n        }\n        shippingLine {\n          title\n          shippingRateHandle\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n  {% assign order = result.data.order %}\n\n  {% for lineItemEdge in order.lineItems.edges %}\n    {% assign row = array %}\n\n    {% assign lineItem = lineItemEdge.node %}\n\n    {% comment %}Customer ID{% endcomment %}\n    {% assign row[row.size] = order.customer.legacyResourceId %}\n\n    {% comment %}First Order Date{% endcomment %}\n    {% assign row[row.size] = order.customer.orders.edges[0].node.processedAt %}\n\n    {% comment %}Customer E-mail{% endcomment %}\n    {% assign row[row.size] = order.customer.email %}\n\n    {% comment %}Shipping First Name{% endcomment %}\n    {% assign row[row.size] = order.shippingAddress.firstName %}\n\n    {% comment %}Shipping Last Name{% endcomment %}\n    {% assign row[row.size] = order.shippingAddress.lastName %}\n\n    {% comment %}Shipping Address 1{% endcomment %}\n    {% assign row[row.size] = order.shippingAddress.address1 %}\n\n    {% comment %}Shipping Address 2{% endcomment %}\n    {% assign row[row.size] = order.shippingAddress.address2 %}\n\n    {% comment %}Shipping City{% endcomment %}\n    {% assign row[row.size] = order.shippingAddress.city %}\n\n    {% comment %}Shipping Province{% endcomment %}\n    {% assign row[row.size] = order.shippingAddress.province %}\n\n    {% comment %}Shipping Country{% endcomment %}\n    {% assign row[row.size] = order.shippingAddress.country %}\n\n    {% comment %}Shipping Zip{% endcomment %}\n    {% assign row[row.size] = order.shippingAddress.zip %}\n\n    {% comment %}Shipping Phone{% endcomment %}\n    {% assign row[row.size] = order.shippingAddress.phone %}\n\n    {% comment %}Billing First Name{% endcomment %}\n    {% assign row[row.size] = order.billingAddress.firstName %}\n\n    {% comment %}Billing Last Name{% endcomment %}\n    {% assign row[row.size] = order.billingAddress.lastName %}\n\n    {% comment %}Billing Address 1{% endcomment %}\n    {% assign row[row.size] = order.billingAddress.address1 %}\n\n    {% comment %}Billing Address 2{% endcomment %}\n    {% assign row[row.size] = order.billingAddress.address2 %}\n\n    {% comment %}Billing City{% endcomment %}\n    {% assign row[row.size] = order.billingAddress.city %}\n\n    {% comment %}Billing Province{% endcomment %}\n    {% assign row[row.size] = order.billingAddress.province %}\n\n    {% comment %}Billing Country{% endcomment %}\n    {% assign row[row.size] = order.billingAddress.country %}\n\n    {% comment %}Billing Zip{% endcomment %}\n    {% assign row[row.size] = order.billingAddress.zip %}\n\n    {% comment %}Billing Phone{% endcomment %}\n    {% assign row[row.size] = order.billingAddress.phone %}\n\n    {% comment %}Current Purchase Date{% endcomment %}\n    {% assign row[row.size] = order.processedAt %}\n\n    {% comment %}Product ID{% endcomment %}\n    {% assign row[row.size] = lineItem.product.legacyResourceId %}\n\n    {% comment %}Product Title{% endcomment %}\n    {% assign row[row.size] = lineItem.product.title %}\n\n    {% comment %}Variant ID{% endcomment %}\n    {% assign row[row.size] = lineItem.variant.legacyResourceId %}\n\n    {% comment %}Variant Title{% endcomment %}\n    {% assign row[row.size] = lineItem.variant.title %}\n\n    {% comment %}Tags{% endcomment %}\n    {% assign row[row.size] = lineItem.product.tags | join: \", \" %}\n\n    {% comment %}Quantity{% endcomment %}\n    {% assign row[row.size] = lineItem.quantity %}\n\n    {% comment %}Price{% endcomment %}\n    {% assign row[row.size] = lineItem.discountedTotalSet.shopMoney.amount %}\n\n    {% comment %}SKU{% endcomment %}\n    {% assign row[row.size] = lineItem.sku %}\n\n    {% comment %}Shipping Code{% endcomment %}\n    {% assign row[row.size] = order.shippingLine.shippingRateHandle %}\n\n    {% comment %}Shipping Name{% endcomment %}\n    {% assign row[row.size] = order.shippingLine.title %}\n\n    {% assign csv[csv.size] = row %}\n\n    {% if options.add_this_tag_after_export != blank %}\n      {% action \"shopify\" %}\n        mutation {\n          tagsAdd(\n            id: {{ order_id | json }}\n            tags: {{ options.add_this_tag_after_export | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endif %}\n  {% endfor %}\n{% endfor %}\n\n{% if event.preview or csv.size > 1 %}\n  {% action \"email\" %}\n    {\n      \"from_display_name\": {{ shop.name | json }},\n      \"to\": {{ options.export_email_recipient__email_required | json }},\n      \"subject\": {{ options.export_email_subject__required | json }},\n      \"body\": {{ options.export_email_body__required_multiline | strip | newline_to_br | json }},\n      \"attachments\": {\n        {{ options.export_csv_filename__required | append: \".csv\" | json }}: {{ csv | csv | json }}\n      }\n    }\n  {% endaction %}\n{% endif %}\n\n{% if event.preview %}\n  {% if options.add_this_tag_after_export != blank %}\n    {% action \"shopify\" %}\n      mutation {\n        tagsAdd(\n          id: \"gid://shopify/Order/1234567890\"\n          tags: {{ options.add_this_tag_after_export | json }}\n        ) {\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endif %}\n{% endif %}",
  "docs": "Use this task to generate and email a CSV of orders, including one row per line item. Filter with a search query or by tags, and auto-tag orders as they're exported. Run the export on demand, and/or nightly. This task is also useful as a template for further development.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "CSV",
    "Email",
    "Export",
    "Orders"
  ]
}
