{
  "name": "Report Toaster: ShipStation Integration",
  "options": {
    "api_username__required": null,
    "api_password__required": null
  },
  "subscriptions": [
    "shopify/orders/fulfilled",
    "mechanic/actions/perform",
    "mechanic/user/text"
  ],
  "subscriptions_template": "shopify/orders/fulfilled\nmechanic/actions/perform\nmechanic/user/text",
  "script": "{% comment %}\n  Preferred option order:\n\n  {{ options.api_username__required }}\n  {{ options.api_password__required }}\n{% endcomment %}\n\n{% if event.topic == \"shopify/orders/fulfilled\" or event.topic == \"mechanic/user/text\" or event.preview %}\n\n  {% assign authorization_header = options.api_username__required | append: \":\" | append: options.api_password__required | base64 | prepend: \"Basic \" %}\n\n  {% if event.preview %}\n    {% assign order_number = 12345 %}\n  {% elsif event.topic == \"shopify/orders/fulfilled\" %}\n    {% assign order_number = order.name %}\n  {% elsif event.topic == \"mechanic/user/text\" %}\n    {% assign order_number = event.data %}\n  {% endif %}\n\n  {% if order_number != blank %}\n    {% assign order_number = order_number | remove: \"#\" %}\n    {% action \"http\" %}\n      {\n        \"method\": \"get\",\n        \"url\": {{ \"https://ssapi.shipstation.com/shipments?orderNumber=\" | append: order_number | json }},\n        \"headers\": {\n          \"Authorization\": {{ authorization_header | json }}\n        },\n        \"meta\": {\n          \"order_number\": {{ order_number | json }}\n        }\n      }\n    {% endaction %}\n  {% endif %}\n{% endif %}\n\n{% if event.preview or event.topic == \"mechanic/actions/perform\" and action.type == \"http\" %}\n\n  {% if event.preview %}\n    {% capture shipments_json %}\n      [\n        {\n          \"shipmentId\": 28195403,\n          \"orderId\": 65695876,\n          \"orderKey\": \"4244227981505\",\n          \"userId\": \"a3cf6157-11e9-46a1-b0fc-2222322\",\n          \"customerEmail\": \"email@yahoo.com\",\n          \"orderNumber\": \"5969\",\n          \"createDate\": \"2022-01-13T04:26:37.1670000\",\n          \"shipDate\": \"2022-01-13\",\n          \"shipmentCost\": 21.02,\n          \"insuranceCost\": 0,\n          \"trackingNumber\": \"123455\",\n          \"isReturnLabel\": false,\n          \"batchNumber\": \"100527\",\n          \"carrierCode\": \"dhl_express_uk\",\n          \"serviceCode\": \"dhl_uk_express_worldwide\",\n          \"packageCode\": null,\n          \"confirmation\": null,\n          \"warehouseId\": 26351,\n          \"voided\": false,\n          \"voidDate\": null,\n          \"marketplaceNotified\": true,\n          \"notifyErrorMessage\": null,\n          \"shipTo\": {\n            \"name\": \"Somebody\",\n            \"company\": null,\n            \"street1\": \"\",\n            \"street2\": \"\",\n            \"street3\": null,\n            \"city\": \"VANCOUVER\",\n            \"state\": \"WA\",\n            \"postalCode\": \"90210\",\n            \"country\": \"US\",\n            \"phone\": \"\",\n            \"residential\": null,\n            \"addressVerified\": null\n          },\n          \"weight\": {\n            \"value\": 340,\n            \"units\": \"grams\",\n            \"WeightUnits\": 2\n          },\n          \"dimensions\": {\n            \"units\": \"inches\",\n            \"length\": 20,\n            \"width\": 10,\n            \"height\": 5\n          },\n          \"insuranceOptions\": {\n            \"provider\": null,\n            \"insureShipment\": false,\n            \"insuredValue\": 0\n          },\n          \"advancedOptions\": {\n            \"billToParty\": null,\n            \"billToAccount\": null,\n            \"billToPostalCode\": null,\n            \"billToCountryCode\": null,\n            \"storeId\": 45678\n          },\n          \"shipmentItems\": null,\n          \"labelData\": null,\n          \"formData\": null\n        }\n      ]\n    {% endcapture %}\n\n    {% assign shipments = shipments_json | parse_json %}\n  {% else %}\n    {% assign shipments = action.run.result.body.shipments %}\n  {% endif %}\n\n  {% if shipments != blank %}\n    {% for shipment in shipments %}\n      {% assign order_id = shipment.orderKey %}\n      {% assign shipping_cost = shipping_cost | plus: shipment.shipmentCost | plus: shipment.insuranceCost %}\n    {% endfor %}\n\n    {% action \"report_toaster\" %}\n      {\n        \"operation\": \"update\",\n        \"Order\": [\n          {\n            \"id\": {{ order_id | json }},\n            \"shipping_cost\": {{ shipping_cost | json }}\n          }\n        ]\n      }\n    {% endaction %}\n  {% endif %}\n{% endif %}",
  "docs": "This task integrates Report Toaster and ShipStation. On order fulfillment, Mechanic calls the ShipStation API to retrieve the shipping cost, and this cost is sent to Report Toaster.\n\nNote - the task currently makes a few assumptions:\n\n1. The task will get all shipping costs for an order once the order is completely fulfilled.\n2. The shipping cost is recorded as the shipping cost + insurance cost. You can update the task code to change this logic.\n3. ShipStation does not store the \"#\" with the order name. So the task strips this out.\n\nSee your [ShipStation settings](https://ss.shipstation.com/#/settings/api) to retrieve the API Key and Password to use in the task options.\n\nThis task can be run manually as a test by entering an order name.\n\nSee the [Mechanic documentation for Report Toaster](https://learn.mechanic.dev/platform/integrations/report-toaster) for more information on updating costs.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Costs",
    "External API",
    "Integration",
    "Report Toaster",
    "Shipping"
  ]
}
