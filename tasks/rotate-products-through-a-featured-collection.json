{
  "name": "Rotate products through a featured collection",
  "options": {
    "product_ids_to_be_featured__number_array_required": null,
    "featured_collection_id__number_required": null,
    "number_of_products_to_feature_at_once__required_number": null,
    "manage_product_publishing__boolean": null,
    "maximum_number_of_times_to_feature_a_product__number": null,
    "tag_to_add_after_a_product_has_been_featured_for_the_last_time": null,
    "run_hourly__boolean": null,
    "run_daily_at_midnight__boolean": null,
    "price_multiplier_for_featured_products__number": null
  },
  "subscriptions": [
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "mechanic/user/trigger\r\n{% if options.run_hourly__boolean %}mechanic/scheduler/hourly{% endif %}\r\n{% if options.run_daily_at_midnight__boolean %}mechanic/scheduler/daily{% endif %}",
  "script": "{% assign product_ids_to_be_featured = options.product_ids_to_be_featured__number_array_required %}\n{% assign number_of_product_ids = product_ids_to_be_featured.size %}\n{% assign featured_collection_id = options.featured_collection_id__number_required %}\n{% assign number_of_products_to_feature_at_once = options.number_of_products_to_feature_at_once__required_number | round %}\n{% assign manage_product_publishing = options.manage_product_publishing__boolean %}\n{% assign max_feature_times = options.maximum_number_of_times_to_feature_a_product__number %}\n{% assign price_multiplier = options.price_multiplier_for_featured_products__number %}\n{% assign inverse_price_multiplier = nil %}\n{% if price_multiplier != blank %}\n  {% assign inverse_price_multiplier = 1.0 | divided_by: price_multiplier %}\n{% endif %}\n\n{% if event.preview %}\n  {\n    \"action\": {\n      \"type\": \"shopify\",\n      \"options\": [\n        \"create\",\n        \"collect\",\n        {\n          \"product_id\": 1234567890,\n          \"collection_id\": 1234567890,\n          \"position\": 0\n        }\n      ]\n    }\n  }\n\n  {% assign product_updates = \"\" %}\n\n  {% assign tags_to_save = nil %}\n  {% if max_feature_times != blank and options.tag_to_add_after_a_product_has_been_featured_for_the_last_time != blank %}\n    {% assign tags_to_save = options.tag_to_add_after_a_product_has_been_featured_for_the_last_time %}\n  {% endif %}\n\n  {% if tags_to_save %}\n    {% capture product_updates %}\n      {% if product_updates != blank %}{{ product_updates }}, {% endif %}\n      \"tags\": {{ tags_to_save | json }}\n    {% endcapture %}\n  {% endif %}\n\n  {% if manage_product_publishing %}\n    {% capture product_updates %}\n      {% if product_updates != blank %}{{ product_updates }}, {% endif %}\n      \"published\": true\n    {% endcapture %}\n  {% endif %}\n\n  {% if price_multiplier != blank %}\n    {% capture product_updates %}\n      {% if product_updates != blank %}{{ product_updates }}, {% endif %}\n      \"variants\": [\n        {\n          \"id\": 1234567890,\n          \"price\": {{ 10.0 | times: price_multiplier | json }}\n        }\n      ]\n    {% endcapture %}\n  {% endif %}\n\n  {% if product_updates != blank %}\n    {\n      \"action\": {\n        \"type\": \"shopify\",\n        \"options\": [\n          \"update\",\n          [\"product\", 1234567890],\n          {\n            {{ product_updates }}\n          }\n        ]\n      }\n    }\n  {% endif %}\n\n  {% if max_feature_times != blank %}\n    {\n      \"action\": {\n        \"type\": \"shopify\",\n        \"options\": [\n          \"create\",\n          \"metafield\",\n          {\n            \"owner_resource\": \"product\",\n            \"owner_id\": 1234567890,\n            \"namespace\": \"mechanic\",\n            \"key\": \"feature_count\",\n            \"value_type\": \"integer\",\n            \"value\": 1\n          }\n        ]\n      }\n    }\n  {% endif %}\n{% else %}\n  {% assign featured_collection = shop.collections[featured_collection_id] %}\n  {% assign currently_featured_collects = featured_collection.collects %}\n\n  {% if featured_collection == nil %}\n    {% capture message %}Collection {{ featured_collection_id | json }} not found - not going to do any work.{% endcapture %}\n    {\"log\": {{ message | json }}}\n  {% else %}\n    {% for collect in currently_featured_collects %}\n      {\n        \"action\": {\n          \"type\": \"shopify\",\n          \"options\": [\n            \"delete\",\n            [\"collect\", {{ collect.id | json }}]\n          ]\n        }\n      }\n\n      {% assign product = shop.products[collect.product_id] %}\n      {% assign product_updates = \"\" %}\n\n      {% assign tags_to_save = nil %}\n      {% if max_feature_times != blank and options.tag_to_add_after_a_product_has_been_featured_for_the_last_time != blank %}\n        {% assign current_feature_count = product.metafields.mechanic.feature_count | default: 0 %}\n        {% if current_feature_count >= max_feature_times %}\n          {% assign tags_to_save = product.tags | add_tag: options.tag_to_add_after_a_product_has_been_featured_for_the_last_time %}\n        {% endif %}\n      {% endif %}\n\n      {% if tags_to_save %}\n        {% capture product_updates %}\n          {% if product_updates != blank %}{{ product_updates }}, {% endif %}\n          \"tags\": {{ tags_to_save | json }}\n        {% endcapture %}\n      {% endif %}\n\n      {% if manage_product_publishing %}\n        {% capture product_updates %}\n          {% if product_updates != blank %}{{ product_updates }}, {% endif %}\n          \"published\": false\n        {% endcapture %}\n      {% endif %}\n\n      {% if inverse_price_multiplier != blank %}\n        {% capture product_updates %}\n          {% if product_updates != blank %}{{ product_updates }}, {% endif %}\n          \"variants\": [\n            {% for variant in product.variants %}\n              {\n                \"id\": {{ variant.id | json }},\n                \"price\": {{ variant.price | times: inverse_price_multiplier | json }}\n              }\n              {% unless forloop.last %},{% endunless %}\n            {% endfor %}\n          ]\n        {% endcapture %}\n      {% endif %}\n\n      {% if product_updates != blank %}\n        {\n          \"action\": {\n            \"type\": \"shopify\",\n            \"options\": [\n              \"update\",\n              [\"product\", {{ product.id | json }}],\n              {\n                {{ product_updates }}\n              }\n            ]\n          }\n        }\n      {% endif %}\n    {% endfor %}\n\n    {% assign last_featured_index = -1 %}\n    {% for collect in currently_featured_collects %}\n      {% for product_id_to_be_featured in product_ids_to_be_featured %}\n        {% if product_id_to_be_featured == collect.product_id and forloop.index0 > last_featured_index %}\n          {% assign last_featured_index = forloop.index0 %}\n        {% endif %}\n      {% endfor %}\n    {% endfor %}\n\n    {% if last_featured_index == -1 %}\n      {\"log\": \"No matches found between the featured collection and the configured product ID list, so we're going to start by featuring the first product(s) in the list.\"}\n    {% elsif product_ids_to_be_featured[last_featured_index] == product_ids_to_be_featured.last %}\n      {\"log\": \"We were previously at the end of the feature list; beginning again at the beginning\"}\n      {% assign last_featured_index = -1 %}\n    {% endif %}\n\n    {% for n in (1..number_of_products_to_feature_at_once) %}\n      {% assign product_index_to_be_featured = last_featured_index | plus: n %}\n      {% assign product_id_to_be_featured = product_ids_to_be_featured[product_index_to_be_featured] %}\n\n      {% if product_id_to_be_featured == blank %}\n        {\"log\": \"Reached the end of the product ID list - no more products to feature.\"}\n        {% break %}\n      {% endif %}\n\n      {% if max_feature_times != blank %}\n        {% assign current_feature_count = shop.products[product_id_to_be_featured].metafields.mechanic.feature_count | default: 0 %}\n        {% if current_feature_count >= max_feature_times %}\n          {% capture message %}Product {{ product_id_to_be_featured }} has already been published {{ current_feature_count }} time(s); skipping{% endcapture %}\n          {\"log\": {{ message | json }}}\n          {% continue %}\n        {% endif %}\n      {% endif %}\n\n      {\n        \"action\": {\n          \"type\": \"shopify\",\n          \"options\": [\n            \"create\",\n            \"collect\",\n            {\n              \"product_id\": {{ product_id_to_be_featured | json }},\n              \"collection_id\": {{ featured_collection_id | json }},\n              \"position\": {{ n | json }}\n            }\n          ]\n        }\n      }\n\n      {% assign product_updates = \"\" %}\n\n      {% if manage_product_publishing %}\n        {% capture product_updates %}\n          {% if product_updates != blank %}{{ product_updates }}, {% endif %}\n          \"published\": true\n        {% endcapture %}\n      {% endif %}\n\n      {% if price_multiplier != blank %}\n        {% capture product_updates %}\n          {% if product_updates != blank %}{{ product_updates }}, {% endif %}\n          \"variants\": [\n            {% for variant in shop.products[product_id_to_be_featured].variants %}\n              {\n                \"id\": {{ variant.id | json }},\n                \"price\": {{ variant.price | times: price_multiplier | json }}\n              }\n              {% unless forloop.last %},{% endunless %}\n            {% endfor %}\n          ]\n        {% endcapture %}\n      {% endif %}\n\n      {% if product_updates != blank %}\n        {\n          \"action\": {\n            \"type\": \"shopify\",\n            \"options\": [\n              \"update\",\n              [\"product\", {{ product_id_to_be_featured | json }}],\n              {\n                {{ product_updates }}\n              }\n            ]\n          }\n        }\n      {% endif %}\n\n      {% if max_feature_times != blank %}\n        {\n          \"action\": {\n            \"type\": \"shopify\",\n            \"options\": [\n              \"create\",\n              \"metafield\",\n              {\n                \"owner_resource\": \"product\",\n                \"owner_id\": {{ product_id_to_be_featured | json }},\n                \"namespace\": \"mechanic\",\n                \"key\": \"feature_count\",\n                \"value_type\": \"integer\",\n                \"value\": {{ current_feature_count | plus: 1 | json }}\n              }\n            ]\n          }\n        }\n      {% endif %}\n    {% endfor %}\n  {% endif %}\n{% endif %}",
  "docs": "This task features products on a schedule, optionally publishing/unpublishing as they're featured/unfeatured. Use this task to make available exclusive products on the hourly/daily/etc, or simply to showcase a rotating selection of your best products.\n\nConfigure this task by adding a list of product IDs to feature, in the order you'd like them to be featured, and setting the \"Featured collection ID\" to the ID of whatever collection you'd like this task to manage.* This task will feature a configurable number of products at a time, rotating through the list from top to bottom, beginning again at the top of the list when the final products are featured.\r\n\r\nFeel free to add new IDs to the list over time, but don't remove IDs for products that are currently published! This task figures out what products are next, by looking up the currently-published products in the configured ID list.\r\n\r\nEnable \"Manage product publishing\" to have this task publish products when they're featured, and unpublish products when they're done being featured.\r\n\r\nEnable \"Run hourly\" or \"Run daily at midnight\" to have this task run automatically. Otherwise, use the \"Run task\" button to run this task on demand.\r\n\r\nEnable \"Maximum number of times to feature a product\" to control how many times Mechanic will feature a product over its lifetime.\r\n\r\nConfigure \"Price multiplier for featured products\" to control pricing adjustments to apply only when a product is featured. For example, a multiplier of `0.5` would result in a product being featured for 50% off, being restored to its normal price when it is no longer featured. (This task will update the price for each of a product's variants, even if there is only one, but it will not modify any \"compare at\" prices.)\r\n\r\n*To find IDs for your products or collections, navigate to the product or collection in the Shopify admin area, and use the number at the very end of the URL in your browser's address bar.\r\n\r\nFor example, a product located at example.myshopify.com/admin/products/1234567890 would have a product ID of 1234567890.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Collections",
    "Featured",
    "Products"
  ]
}
