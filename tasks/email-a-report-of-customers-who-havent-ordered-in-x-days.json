{
  "name": "Email a report of customers who haven't ordered in X days",
  "options": {
    "required_customer_tag__required": null,
    "include_customers_who_have_not_placed_an_order_in_this_many_days__number_required": null,
    "email_subject_prefix__required": null,
    "email_recipient__required_email": null,
    "send_email_anyway_if_no_customers_are_found__boolean": null,
    "send_email_daily__boolean": null,
    "send_email_every_monday__boolean": null
  },
  "subscriptions": [
    "mechanic/shopify/bulk_operation",
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "mechanic/shopify/bulk_operation\n\nmechanic/user/trigger\n\n{% if options.send_email_daily__boolean %}\n  mechanic/scheduler/daily\n{% endif %}\n\n{% if options.send_email_every_monday__boolean %}\n  mechanic/scheduler/monday\n{% endif %}",
  "script": "{% if event.topic == \"mechanic/user/trigger\" or event.topic contains \"mechanic/scheduler/\" %}\n  {% capture bulk_operation_query %}\n    query {\n      customers(\n        query: {{ options.required_customer_tag__required | json | prepend: \"orders_count:>=1 AND tag:\" | json }}\n      ) {\n        edges {\n          node {\n            displayName\n            email\n            id\n            legacyResourceId\n\n            lastOrder {\n              createdAt\n              legacyResourceId\n              name\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% action \"shopify\" %}\n    mutation {\n      bulkOperationRunQuery(\n        query: {{ bulk_operation_query | json }}\n      ) {\n        bulkOperation {\n          id\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% elsif event.topic == \"mechanic/shopify/bulk_operation\" %}\n  {% assign now_s = \"now\" | date: \"%s\" | times: 1 %}\n  {% assign interval_d = options.include_customers_who_have_not_placed_an_order_in_this_many_days__number_required %}\n  {% assign interval_s = interval_d | times: 24 | times: 60 | times: 60 %}\n  {% assign order_time_threshold_s = now_s | minus: interval_s %}\n\n  {% if interval_d <= 0 %}\n    {% error \"The number of days must be greater than 0. :)\" %}\n  {% endif %}\n\n  {% if event.preview %}\n    {% capture objects_json %}\n      [\n        {\n          \"displayName\": \"Alpha Beta\",\n          \"email\": \"customer@example.com\",\n          \"id\": \"gid://shopify/Customer/1234567890\",\n          \"legacyResourceId\": \"1234567890\",\n          \"lastOrder\": {\n            \"createdAt\": {{ now_s | minus: interval_s | minus: 432000 | date: \"%Y-%m-%dT%H:%M:%SZ\" | json }},\n            \"legacyResourceId\": \"1234567890\",\n            \"name\": \"#1000\"\n          }\n        }\n      ]\n    {% endcapture %}\n\n    {% assign bulkOperation = hash %}\n    {% assign bulkOperation[\"objects\"] = objects_json | parse_json %}\n  {% endif %}\n\n  {% assign qualifying_customers = array %}\n\n  {% for customer in bulkOperation.objects %}\n    {% assign order_time_s = customer.lastOrder.createdAt | date: \"%s\" | times: 1 %}\n    {% if order_time_s < order_time_threshold_s %}\n      {% assign qualifying_customers[qualifying_customers.size] = customer %}\n    {% endif %}\n  {% endfor %}\n\n  {% capture email_subject %}\n    {{ options.email_subject_prefix__required }} {{ qualifying_customers.size }} {{ qualifying_customers.size | pluralize: \"customer\", \"customers\" }} found\n  {% endcapture %}\n\n  {% if qualifying_customers != empty %}\n    {% capture email_body %}\n      <p>Hello,</p>\n      <p>\n        Filtering for customers tagged {{ options.required_customer_tag__required | json }},\n        the following {{ qualifying_customers.size }} {{ qualifying_customers.size | pluralize: \"customer was\", \"customers were\" }}\n        found to have not placed an order in the last {{ interval_d }} {{ interval_d | pluralize: \"day\", \"days\" }}:\n      </p>\n      <ul>\n        {% for customer in qualifying_customers %}\n          {% assign lastOrder_days_ago = customer.lastOrder.createdAt | date: \"%s\" | times: 1 | minus: now_s | times: -1 | divided_by: 60 | divided_by: 60 | divided_by: 24 %}\n          <li>\n            <a href=\"https://{{ shop.domain }}/admin/customers/{{ customer.legacyResourceId }}\">{{ customer.displayName | default: \"(unnamed)\" }}</a>\n            ({{ customer.email | default: \"(no email)\" }})\n            <br>\n            Last ordered on {{ customer.lastOrder.createdAt | date: \"%Y-%m-%d\" }},\n            {{ lastOrder_days_ago }} {{ lastOrder_days_ago | pluralize: \"day\", \"days\" }} ago\n            â€“ <a href=\"https://{{ shop.domain }}/admin/orders/{{ customer.lastOrder.legacyResourceId }}\">{{ customer.lastOrder.name }}</a>\n          </li>\n        {% endfor %}\n      </ul>\n      <p>Thanks,<br>- Mechanic, for {{ shop.name }}</p>\n    {% endcapture %}\n\n    {% action \"email\" %}\n      {\n        \"to\": {{ options.email_recipient__required_email | json }},\n        \"subject\": {{ email_subject | strip | json }},\n        \"body\": {{ email_body | json }},\n        \"reply_to\": {{ shop.customer_email | json }},\n        \"from_display_name\": {{ shop.name | json }}\n      }\n    {% endaction %}\n  {% elsif options.send_email_anyway_if_no_customers_are_found__boolean %}\n    {% capture email_body %}\n      Hello,\n\n      We didn't find any customers (tagged {{ options.required_customer_tag__required | json }}) having zero orders placed in the last {{ interval_d }} day(s).\n\n      Thanks,\n      - Mechanic, for {{ shop.name }}\n    {% endcapture %}\n\n    {% action \"email\" %}\n      {\n        \"to\": {{ options.email_recipient__required_email | json }},\n        \"subject\": {{ email_subject | strip | json }},\n        \"body\": {{ email_body | unindent | strip | newline_to_br | json }},\n        \"reply_to\": {{ shop.customer_email | json }},\n        \"from_display_name\": {{ shop.name | json }}\n      }\n    {% endaction %}\n  {% endif %}\n{% endif %}",
  "docs": "Use this task to request or schedule an email digest of customers, having a certain tag, who haven't placed an order in a certain number of days.\n\nRun this task manually to request a report immediately, or configure the task to run automatically on a schedule.\r\n\r\n[YouTube: Watch the development video!](https://youtu.be/y1fV3aQrS1g)",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false
}
