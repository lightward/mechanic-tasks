{
  "name": "Auto-tag products based on their product type",
  "options": {
    "product_types_and_tags__required_keyval": null,
    "remove_product_tags_in_this_list_when_they_do_not_apply__boolean": null
  },
  "subscriptions": [
    "shopify/products/create",
    "shopify/products/update",
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "shopify/products/create\nshopify/products/update\nmechanic/user/trigger",
  "script": "{% assign products = array %}\n\n{% if event.topic contains \"shopify/products/\" %}\n  {% if event.preview %}\n    {% capture product_json %}\n      {\n        \"admin_graphql_api_id\": \"gid://shopify/Product/1234567890\",\n        \"tags\": \"\",\n        \"product_type\": {{ options.product_types_and_tags__required_keyval.first.first | json }}\n      }\n    {% endcapture %}\n\n    {% assign product = product_json | parse_json %}\n  {% endif %}\n\n  {% assign product_node = hash %}\n  {% assign product_node[\"id\"] = product.admin_graphql_api_id %}\n  {% assign product_node[\"tags\"] = product.tags | split: \", \" %}\n  {% assign product_node[\"productType\"] = product.product_type %}\n  {% assign products[0] = product_node %}\n{% elsif event.topic == \"mechanic/user/trigger\" %}\n  {% assign cursor = nil %}\n  {% assign total_inventory = 0 %}\n\n  {% for n in (0..100) %}\n    {% capture query %}\n      query {\n        products(\n          first: 250\n          after: {{ cursor | json }}\n        ) {\n          pageInfo {\n            hasNextPage\n          }\n          edges {\n            cursor\n            node {\n              id\n              tags\n              productType\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = query | shopify %}\n\n    {% if event.preview %}\n      {% capture result_json %}\n        {\n          \"data\": {\n            \"products\": {\n              \"edges\": [\n                {\n                  \"node\": {\n                    \"id\": \"gid://shopify/Product/4354268561469\",\n                    \"tags\": [],\n                    \"productType\": {{ options.product_types_and_tags__required_keyval.first.first | json }}\n                  }\n                }\n              ]\n            }\n          }\n        }\n      {% endcapture %}\n\n      {% assign result = result_json | parse_json %}\n    {% endif %}\n\n    {% for product_edge in result.data.products.edges %}\n      {% assign product_node = product_edge.node %}\n      {% assign products[products.size] = product_node %}\n    {% endfor %}\n\n    {% if result.data.products.pageInfo.hasNextPage %}\n      {% assign cursor = result.data.products.edges.last.cursor %}\n    {% else %}\n      {% break %}\n    {% endif %}\n  {% endfor %}\n{% endif %}\n\n{% for product in products %}\n  {% assign deserved_tags = array %}\n  {% assign tags_to_add = array %}\n  {% assign tags_to_remove = array %}\n\n  {% assign tags_for_product_type = options.product_types_and_tags__required_keyval[product.productType] | split: \",\" %}\n  {% for tag in tags_for_product_type %}\n    {% assign stripped_tag = tag | strip %}\n    {% assign deserved_tags[deserved_tags.size] = stripped_tag %}\n    {% unless product.tags contains stripped_tag or tags_to_add contains stripped_tag %}\n      {% assign tags_to_add[tags_to_add.size] = stripped_tag %}\n    {% endunless %}\n  {% endfor %}\n\n  {% if options.remove_product_tags_in_this_list_when_they_do_not_apply__boolean %}\n    {% for pair in options.product_types_and_tags__required_keyval %}\n      {% assign a_product_type = pair[0] %}\n      {% assign tags_for_a_product_type = pair[1] | split: \",\" %}\n\n      {% for tag in tags_for_a_product_type %}\n        {% assign stripped_tag = tag | strip %}\n        {% if product.tags contains stripped_tag %}\n          {% unless deserved_tags contains stripped_tag or tags_to_remove contains stripped_tag %}\n            {% assign tags_to_remove[tags_to_remove.size] = stripped_tag %}\n          {% endunless %}\n        {% endif %}\n      {% endfor %}\n    {% endfor %}\n  {% endif %}\n\n  {% if tags_to_add != empty or tags_to_remove != empty %}\n    {% log product: product, tags_to_add: tags_to_add, tags_to_remove: tags_to_remove %}\n\n    {% action \"shopify\" %}\n      mutation {\n        {% if tags_to_add != empty %}\n          tagsAdd(\n            id: {{ product.id | json }}\n            tags: {{ tags_to_add | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        {% endif %}\n        {% if tags_to_remove != empty %}\n          tagsRemove(\n            id: {{ product.id | json }}\n            tags: {{ tags_to_remove | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        {% endif %}\n      }\n    {% endaction %}\n  {% endif %}\n{% endfor %}",
  "docs": null,
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false
}
