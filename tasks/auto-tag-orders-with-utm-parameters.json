{
  "name": "Auto-tag orders with UTM parameters",
  "options": {
    "tag_with_utm_campaign__boolean": null,
    "tag_with_utm_content__boolean": null,
    "tag_with_utm_medium__boolean": null,
    "tag_with_utm_source__boolean": null,
    "tag_with_utm_term__boolean": null
  },
  "subscriptions": [
    "shopify/orders/create",
    "mechanic/user/trigger",
    "mechanic/shopify/bulk_operation"
  ],
  "subscriptions_template": "shopify/orders/create\nmechanic/user/trigger\nmechanic/shopify/bulk_operation",
  "script": "{% comment %}\n  {{ options.tag_with_utm_campaign__boolean }}\n  {{ options.tag_with_utm_content__boolean }}\n  {{ options.tag_with_utm_medium__boolean }}\n  {{ options.tag_with_utm_source__boolean }}\n  {{ options.tag_with_utm_term__boolean }}\n{% endcomment %}\n\n{% assign orders = array %}\n\n{% if event.topic contains \"shopify/orders/\" %}\n  {% capture query %}\n    query {\n      order(id: {{ order.admin_graphql_api_id | json }}) {\n        id\n        name\n        tags\n        customerJourneySummary {\n          moments(first: 250) {\n            edges {\n              node {\n                ... on CustomerVisit {\n                  utmParameters {\n                    campaign\n                    content\n                    medium\n                    source\n                    term\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n      {\n        \"data\": {\n          \"order\": {\n            \"id\": \"gid://shopify/Order/1234567890\",\n            \"name\": \"#1234\",\n            \"tags\": [],\n            \"customerJourneySummary\": {\n              \"moments\": {\n                \"edges\": [\n                  {\n                    \"node\": {\n                      \"utmParameters\": {\n                        \"campaign\": \"Google Shopping\",\n                        \"content\": \"shoppingcontent\",\n                        \"medium\": \"cpc\",\n                        \"source\": \"google\",\n                        \"term\": \"shoppingterm\"\n                      }\n                    }\n                  }\n                ]\n              }\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n\n  {% assign orders[orders.size] = result.data.order %}\n\n{% elsif event.topic == \"mechanic/user/trigger\" %}\n  {% capture bulk_operation_query %}\n    query {\n      orders {\n        edges {\n          node {\n            __typename\n            id\n            name\n            tags\n            customerJourneySummary {\n              moments {\n                edges {\n                  node {\n                    __typename\n                    ... on CustomerVisit {\n                      utmParameters {\n                        campaign\n                        content\n                        medium\n                        source\n                        term\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% action \"shopify\" %}\n    mutation {\n      bulkOperationRunQuery(\n        query: {{ bulk_operation_query | json }}\n      ) {\n        bulkOperation {\n          id\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% elsif event.topic == \"mechanic/shopify/bulk_operation\" %}\n  {% if event.preview %}\n    {% capture bulkOperation_objects_json %}\n      {\"__typename\":\"Order\",\"id\":\"gid:\\/\\/shopify\\/Order\\/1234567890\",\"name\":\"#1234\",\"tags\":[],\"customerJourneySummary\":{}}\n      {\"__typename\":\"CustomerVisit\",\"utmParameters\":{\"campaign\":\"New Campaign 001\",\"content\":null,\"medium\":\"email\",\"source\":\"newsletter\",\"term\":null},\"__parentId\":\"gid:\\/\\/shopify\\/Order\\/1234567890\"}\n      {\"__typename\":\"CustomerVisit\",\"utmParameters\":{\"campaign\":\"New Campaign 001\",\"content\":\"cta_link\",\"medium\":\"email\",\"source\":\"drip\",\"term\":\"automation+shopify\"},\"__parentId\":\"gid:\\/\\/shopify\\/Order\\/1234567890\"}\n    {% endcapture %}\n\n    {% assign bulkOperation = hash %}\n    {% assign bulkOperation[\"objects\"] = bulkOperation_objects_json | parse_jsonl %}\n  {% endif %}\n\n  {% assign orders = bulkOperation.objects | where: \"__typename\", \"Order\" %}\n{% endif %}\n\n{% assign parameter_names = \"campaign,content,medium,source,term\" | split: \",\" %}\n\n{% for order in orders %}\n  {% assign tags_to_add = array %}\n\n  {% if event.topic contains \"shopify/orders/\" %}\n    {% assign parameter_sets = order.customerJourneySummary.moments.edges | map: \"node\" | map: \"utmParameters\" %}\n  {% elsif event.topic == \"mechanic/shopify/bulk_operation\" %}\n    {% assign parameter_sets = bulkOperation.objects | where: \"__typename\", \"CustomerVisit\" | where: \"__parentId\", order.id | map: \"utmParameters\" %}\n  {% endif %}\n\n  {% for parameter_set in parameter_sets %}\n    {% for parameter_name in parameter_names %}\n      {% assign key = \"tag_with_utm_\" | append: parameter_name | append: \"__boolean\" %}\n\n      {% if options[key] == false or parameter_set[parameter_name] == blank %}\n        {% continue %}\n      {% elsif order.tags contains parameter_set[parameter_name] %}\n        {% log message: \"Order already has this parameter value as a tag\", order_id: order.id, order_name: order.name, order_tags: order.tags, parameter_name: parameter_name, parameter_value: parameter_set[parameter_name] %}\n        {% continue %}\n      {% endif %}\n\n      {% assign tags_to_add[tags_to_add.size] = parameter_set[parameter_name] %}\n    {% endfor %}\n  {% endfor %}\n\n  {% if tags_to_add != blank %}\n    {% action \"shopify\" %}\n      mutation {\n        tagsAdd(\n          id: {{ order.id | json }}\n          tags: {{ tags_to_add | uniq | json }}\n        ) {\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endif %}\n{% endfor %}",
  "docs": "This task automatically tags incoming orders with the UTM campaign, content, medium, source, and/or term associated with the customer's visit. Run this task manually to tag your existing orders.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false
}
