{
  "name": "Tag customers on the anniversary of their first order",
  "options": {
    "customer_tag_to_apply__required": null,
    "customer_search_query": null,
    "days_to_wait_before_tagging__number": null,
    "use_account_creation_date_instead_of_first_order_date__boolean": false
  },
  "subscriptions": [
    "mechanic/user/trigger",
    "mechanic/scheduler/daily",
    "mechanic/shopify/bulk_operation"
  ],
  "subscriptions_template": "mechanic/user/trigger\nmechanic/scheduler/daily\nmechanic/shopify/bulk_operation",
  "script": "{% assign customer_tag_to_apply = options.customer_tag_to_apply__required %}\n{% assign search_query = options.customer_search_query %}\n{% assign days_to_wait_before_tagging = options.days_to_wait_before_tagging__number %}\n{% assign use_account_creation_date = options.use_account_creation_date_instead_of_first_order_date__boolean %}\n\n{% assign origin_threshold = \"now - 1 year\" | date: \"%Y-%m-%d\" %}\n\n{% if days_to_wait_before_tagging > 0 %}\n  {% assign seconds_to_wait_before_tagging = days_to_wait_before_tagging | times: 86400 %}\n  {% assign origin_threshold = origin_threshold | date: \"%s\" | minus: seconds_to_wait_before_tagging | date: \"%Y-%m-%d\" %}\n{% endif %}\n\n{% if event.topic == \"mechanic/user/trigger\" or event.topic contains \"mechanic/scheduler/\" %}\n  {% capture bulk_operation_query %}\n    query {\n      customers(\n        query: {{ search_query | json }}\n      ) {\n        edges {\n          node {\n            __typename\n            id\n            createdAt\n            tags\n            orders(\n              sortKey: PROCESSED_AT\n              query: {{ \"processed_at:<=\" | append: origin_threshold | json }}\n            ) {\n              edges {\n                node {\n                  __typename\n                  id\n                  processedAt\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% action \"shopify\" %}\n    mutation {\n      bulkOperationRunQuery(\n        query: {{ bulk_operation_query | json }}\n      ) {\n        bulkOperation {\n          id\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n\n{% elsif event.topic == \"mechanic/shopify/bulk_operation\" %}\n  {% if event.preview %}\n    {% capture bulkOperation_objects_jsonl %}\n      {\"__typename\":\"Customer\",\"id\":\"gid:\\/\\/shopify\\/Customer\\/1234567890\",\"createdAt\":{{ origin_threshold | json }},\"tags\":null}\n      {\"__typename\":\"Order\",\"id\":\"gid:\\/\\/shopify\\/Order\\/1234567890\",\"processedAt\":{{ origin_threshold | json }},\"__parentId\":\"gid:\\/\\/shopify\\/Customer\\/1234567890\"}\n    {% endcapture %}\n\n    {% assign bulkOperation = hash %}\n    {% assign bulkOperation[\"objects\"] = bulkOperation_objects_jsonl | parse_jsonl %}\n  {% endif %}\n\n  {% assign customers = bulkOperation.objects | where: \"__typename\", \"Customer\" %}\n  {% assign orders = bulkOperation.objects | where: \"__typename\", \"Order\" %}\n\n  {% for customer in customers %}\n    {% assign should_be_tagged = false %}\n\n    {% if use_account_creation_date %}\n      {% if customer.createdAt <= origin_threshold %}\n        {% assign should_be_tagged = true %}\n      {% endif %}\n\n    {% else %}\n      {% assign customer_orders = orders | where: \"__parentId\", customer.id %}\n\n      {% if customer_orders != blank %}\n        {% assign should_be_tagged = true %}\n      {% endif %}\n    {% endif %}\n\n    {% if customer.tags contains customer_tag_to_apply %}\n      {% unless should_be_tagged %}\n        {% action \"shopify\" %}\n          mutation {\n            tagsRemove(\n              id: {{ customer.id | json }}\n              tags: {{ customer_tag_to_apply | json }}\n            ) {\n              userErrors {\n                field\n                message\n              }\n            }\n          }\n        {% endaction %}\n      {% endunless %}\n\n    {% else %}\n      {% if should_be_tagged %}\n        {% action \"shopify\" %}\n          mutation {\n            tagsAdd(\n              id: {{ customer.id | json }}\n              tags: {{ customer_tag_to_apply | json }}\n            ) {\n              userErrors {\n                field\n                message\n              }\n            }\n          }\n        {% endaction %}\n      {% endif %}\n    {% endif %}\n  {% endfor %}\n{% endif %}",
  "docs": "Running daily, or manually, this task scans all customers and tags them if their __first__ order was a year or more ago. Alternatively, you may choose to tag customers if their account was created at least a year ago.\n\nOptionally, you may choose whether to wait a certain amount of days before tagging (i.e. a year + X days afterwards), and to configure a \"Customer search query\" with the same search query you might use in the Shopify admin area. For example:\n* Use `tag:VIP` for customers with the VIP tag\n* Use `accepts_marketing:true` for customers subscribed to email marketing\n* Use `total_spent:>=100` for customers who have spent more than 100 in the local shop currency",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Customers",
    "Tag"
  ]
}
