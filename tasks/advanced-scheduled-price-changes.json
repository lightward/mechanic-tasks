{
  "docs": "This advanced task allows you to schedule price change events for your store, useful for seasonal and flash sales. To use this task, configure a price change event using the task options, save the task and run it manually, and then enter a keyword of **schedule** in the dialog that appears. An email summary with the price change event ID will be sent upon successful scheduling.\n\n#### This task supports these keyword actions:\n\n- **schedule** - Validates and schedules a new price change event using the current task configuration.\n- **list** - Logs out (in Mechanic) all configured price change events (of any status).\n- **email** - Emails a summary of all configured price change events (of any status).\n- **cancel** - Cancels a specific scheduled or ongoing price change event. The cancel keyword must be followed by a space and the _price change event ID_.\n- **reset** - Clears all price change events (of any status) from the shop metafield, and reverts the prices on any variants that have a price change event applied.\n\n#### Key features of this task:\n\n- Ability to schedule overlapping price change events\n- Ability to cancel an ongoing event\n- Ability to add collections that contain more than 1000 products\n- Ability to discount more than 20k products\n- Supports percentage, fixed price, and fixed discount options for products AND collections\n- Option to include specific SKUs in a list with a specific discount for the whole list\n- Option to exclude SKUs from any discount qualification\n- Option to exclude products by tag from any discount qualification\n- Option to have (or not have) compare at prices set to original prices for the duration of an event\n\n#### Price change event configuration notes\n\n- The event start and end datetimes must be valid dates in the form of _YYYY-MM-DD HH:MM_ (24 hour clock). The field date and time picker will enforce this constraint.\n- Collection handles and discounts are entered as key value pairs, with the collection handle on the left and the discount for it on the right.\n- If any SKUs are specifically included, then a SKU discount must be set to apply to them.\n- Discount formats:\n  - Percentage - This must be an integer between 1 and 99, followed immediately by % (e.g. 20%)\n  - Fixed price - Any positive integer or float will be considered the fixed price that all applicable items will be discounted to (e.g. 123.45)\n  - Fixed discount - Any negative integer or float will be considered the discount to be substracted from the price of all applicable items (e.g. -25)\n- Priority of discount assignment when a variant qualifies for multiple discounts within a price change event:\n  - Exclusions (by SKU or product tag) will always override inclusion\n  - SKU inclusion list\n  - Collection membership in order of configuration\n\n#### Important Notes:\n\n- An email notification will be sent for every price change event scheduled, started, completed, and cancelled. If an email is not received as expected, then the task run logs should be reviewed.\n- Price change events that affect a very large number of variants will take some time to process all of the price updates. The notification emails are sent after all variant prices have been updated.\n- Just saving the task configuration will not schedule (or validate) a price change event. This must be done with the \"schedule\" keyword when run manually.\n- This task only manages variant prices. Product and theme publishing are not handled by this task.\n- Variants that are already part of an ongoing price change event will not be modified if targeted by a new price change event.\n- The \"Do not restore prices on reset\" option may be used when clearing out older price change events if there is a concern of reverting old pricing.",
  "halt_action_run_sequence_on_error": false,
  "name": "Advanced: Scheduled Price Changes",
  "online_store_javascript": null,
  "options": {
    "notification_email_recipients__array_required": null,
    "event_start__datetime_futureonly_required": null,
    "event_end__datetime_futureonly_required": null,
    "set_compare_at_prices_to_original_price_during_event__boolean": false,
    "collection_handles_and_discounts__keyval": null,
    "skus_to_include__array": null,
    "sku_discount": null,
    "exclude_products_tagged_with__array": null,
    "skus_to_exclude__array": null,
    "do_not_restore_prices_on_reset__boolean": false
  },
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "script": "{% assign action_keywork = value %}\n{% assign email_recipients = options.notification_email_recipients__array_required %}\n{% assign event_start_datetime = options.event_start__datetime_futureonly_required %}\n{% assign event_end_datetime = options.event_end__datetime_futureonly_required %}\n{% assign set_compare_at_prices = options.set_compare_at_prices_to_original_price_during_event__boolean %}\n{% assign collection_handles_and_discounts = options.collection_handles_and_discounts__keyval %}\n{% assign skus_to_include = options.skus_to_include__array %}\n{% assign sku_discount = options.sku_discount %}\n{% assign exclude_products_tagged_with = options.exclude_products_tagged_with__array %}\n{% assign skus_to_exclude = options.skus_to_exclude__array %}\n{% assign do_not_restore_prices_on_reset = options.do_not_restore_prices_on_reset__boolean %}\n\n{%- capture task_admin_link -%}\n  <a href=\"{{ shop.admin_url }}apps/mechanic/tasks/{{ task.id }}\">{{ task.name }}</a>\n{%- endcapture -%}\n\n{% comment %}\n  -- query for shop data on every task run, since it will be needed for each valid action keyword and custom event\n{% endcomment %}\n\n{% capture query %}\n  query {\n    shop {\n      id\n      name\n      contactEmail\n      metafield(key: \"mechanic.price_change_events\") {\n        jsonValue\n      }\n    }\n  }\n{% endcapture %}\n\n{% assign result = query | shopify %}\n\n{% if event.preview %}\n  {% capture result_json %}\n    {\n      \"data\": {\n        \"shop\": {\n          \"id\": \"gid://shopify/Shop/1234567890\",\n          \"name\": \"Shoplify\",\n          \"contactEmail\": \"info@example.com\",\n          \"metafield\": {\n            \"jsonValue\": {\n              \"price_change_event__1234567890\": {\n                \"status\": \"scheduled\",\n                \"start\": \"2025-12-30 08:00\",\n                \"end\": \"2025-12-31 20:00\",\n                \"set_compare_at_prices\": true,\n                \"collection_handles_and_discounts\": {\n                  \"collection-alpha\": \"20%\",\n                  \"collection-beta\": \"-10\",\n                  \"collection-gamma\": \"20\"\n                },\n                \"skus_to_include\": [],\n                \"sku_discount\": \"\",\n                \"skus_to_exclude\": [],\n                \"exclude_products_tagged_with\": [\n                  \"clearance\"\n                ]\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = result_json | parse_json %}\n{% endif %}\n\n{% assign shop = result.data.shop %}\n{% assign price_change_events = shop.metafield.jsonValue | default: hash %}\n\n{% if event.topic == \"mechanic/user/text\" %}\n  {% comment %}\n    -- check text entry to see what action to take\n  {% endcomment %}\n\n  {% assign action_keyword = event.data | downcase %}\n\n  {% if event.preview %}\n    {% assign action_keyword = \"schedule\" %}\n  {% endif %}\n\n  {% case action_keyword %}\n    {% when \"schedule\" %}\n      {% comment %}\n        -- NOTE: run scheduling logic here instead of in custom event like most other keywords, so user gets immediate feedback on any configuration errors\n      {% endcomment %}\n\n      {% assign now_s = \"now\" | date: \"%s\" %}\n      {% assign start_datetime_s = event_start_datetime | date: \"%s\" %}\n      {% assign end_datetime_s = event_end_datetime | date: \"%s\" %}\n\n      {% if start_datetime_s <= now_s or start_datetime_s >= end_datetime_s %}\n        {% unless event.preview %}\n          {% error \"The event start and end dates must be future dates and the start date must be before the end date. Please re-enter them  and try scheduling the event again.\" %}\n          {% break %}\n        {% endunless %}\n      {% endif %}\n\n      {% comment %}\n        -- validate discount entry formats: XX% (percentage discount), X.XX (fixed price), or -X.XX (fixed discount)\n      {% endcomment %}\n\n      {% assign discounts = collection_handles_and_discounts | values | default: array %}\n\n      {% if skus_to_include != blank and sku_discount == blank %}\n        {% unless event.preview %}\n          {% error \"A SKU discount must be configured when specific SKUs are included.\" %}\n          {% break %}\n        {% endunless %}\n      {% endif %}\n\n      {% if sku_discount != blank %}\n        {% assign discounts = discounts | push: sku_discount %}\n      {% endif %}\n\n      {% for discount in discounts %}\n        {% if discount contains \"%\" %}\n          {% assign discount_percentage = discount | times: 1 %}\n          {% assign discount_string = discount_percentage | append: \"%\" %}\n\n          {% if discount != discount_string %}\n            {% unless event.preview %}\n              {% error\n                message: \"Percentage discount entry incorrect. Please update the task configuration (per the task documentation) and try scheduling the event again.\",\n                discount: discount\n              %}\n              {% break %}\n            {% endunless %}\n          {% endif %}\n\n          {% if discount_percentage <= 0 or discount_percentage >= 100 %}\n            {% unless event.preview %}\n              {% error\n                message: \"Percentage discount entries should contain an number between 0 and 100. Please update the task configuration (per the task documentation) and try scheduling the event again.\",\n                discount: discount\n              %}\n              {% break %}\n            {% endunless %}\n          {% endif %}\n\n        {% else %}\n          {% assign discount_absolute = discount | times: 1 | abs %}\n\n          {% if discount_absolute == 0 %}\n            {% unless event.preview %}\n              {% error\n                message: \"Fixed price and fixed discount entries must contain an absolute number > 0. Please update the task configuration (per the task documentation) and try scheduling the event again.\",\n                discount: discount\n              %}\n              {% break %}\n            {% endunless %}\n          {% endif %}\n        {% endif %}\n      {% endfor %}\n\n      {% assign price_change_event = hash %}\n\n      {% assign price_change_event[\"status\"] = \"scheduled\" %}\n      {% assign price_change_event[\"start\"] = start_datetime_s | date: \"%FT%H:%M%z\" %}\n      {% assign price_change_event[\"end\"] = end_datetime_s | date: \"%FT%H:%M%z\" %}\n      {% assign price_change_event[\"set_compare_at_prices\"] = set_compare_at_prices %}\n      {% assign price_change_event[\"collection_handles_and_discounts\"] = collection_handles_and_discounts %}\n      {% assign price_change_event[\"skus_to_include\"] = skus_to_include %}\n      {% assign price_change_event[\"sku_discount\"] = sku_discount %}\n      {% assign price_change_event[\"skus_to_exclude\"] = skus_to_exclude %}\n      {% assign price_change_event[\"exclude_products_tagged_with\"] = exclude_products_tagged_with %}\n\n      {% log\n        task_options: task.options,\n        price_change_event: price_change_event\n      %}\n\n      {% assign price_change_event_id = event.id | default: task.id %}\n\n      {% assign price_change_events[price_change_event_id] = price_change_event %}\n\n      {% action \"shopify\" %}\n        mutation {\n          metafieldsSet(\n            metafields: [\n              {\n                ownerId: {{ shop.id | json }}\n                namespace: \"mechanic\"\n                key: \"price_change_events\"\n                value: {{ price_change_events | json | json }}\n                type: \"json\"\n              }\n            ]\n          ) {\n            metafields {\n              id\n              namespace\n              key\n              type\n              jsonValue\n              owner {\n                ... on Shop {\n                  id\n                  name\n                  myshopifyDomain\n                }\n              }\n            }\n            userErrors {\n              code\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n\n      {% comment %}\n        -- schedule start and end events\n      {% endcomment %}\n\n      {% action \"event\" %}\n        {\n          \"topic\": \"user/price_changes/start\",\n          \"task_id\": {{ task.id | json }},\n          \"run_at\": {{ start_datetime_s | json }},\n          \"data\": {\n            \"price_change_event_id\": {{ price_change_event_id | json }}\n          }\n        }\n      {% endaction %}\n\n      {% action \"event\" %}\n        {\n          \"topic\": \"user/price_changes/end\",\n          \"task_id\": {{ task.id | json }},\n          \"run_at\": {{ end_datetime_s | json }},\n          \"data\": {\n            \"price_change_event_id\": {{ price_change_event_id | json }}\n          }\n        }\n      {% endaction %}\n\n      {% capture email_subject %}New price change event scheduled ({{ price_change_event_id }}){% endcapture %}\n\n      {% capture email_body %}\n        A new price change event has been scheduled, from the {{ task_admin_link }} task within the Mechanic app.\n\n        <strong>Price change event ID:</strong> {{ price_change_event_id }}\n        <strong>Status:</strong> {{ price_change_event[\"status\"] }}\n        <strong>Event start:</strong> {{ price_change_event[\"start\"] | date: \"%FT%H:%M%z\" }}\n        <strong>Event end:</strong> {{ price_change_event[\"end\"] | date: \"%FT%H:%M%z\" }}\n        <strong>Set compare at price to original price during event:</strong> {{ price_change_event[\"set_compare_at_prices\"] }}\n        <strong>Collection handles and discounts:</strong>\n        {% for keyval in price_change_event[\"collection_handles_and_discounts\"] -%}\n        - {{ keyval[0] }}: {{ keyval[1] }}\n        {% else -%}\n          n/a\n        {%- endfor %}\n        <strong>SKUs to include:</strong> {{ price_change_event[\"skus_to_include\"] | join: \", \" | default: \"n/a\" }}\n        <strong>SKU discount:</strong> {{ price_change_event[\"sku_discount\"] | default: \"n/a\" }},\n        <strong>SKUs to exclude:</strong> {{ price_change_event[\"skus_to_exclude\"] | join: \", \" | default: \"n/a\" }}\n        <strong>Exclude products tagged with:</strong> {{ price_change_event[\"exclude_products_tagged_with\"] | join: \", \" | default: \"n/a\" }}\n\n        <em><strong>Note:</strong> To cancel this event while it is still scheduled or ongoing, use the \"cancel\" keyword along with the price change event ID when running the task.</em>\n      {% endcapture %}\n\n      {% action \"email\" %}\n        {\n          \"to\": {{ email_recipients | json }},\n          \"subject\": {{ email_subject | json }},\n          \"body\": {{ email_body | newline_to_br | json }},\n          \"reply_to\": {{ shop.contactEmail | json }},\n          \"from_display_name\": {{ shop.name | json }}\n        }\n      {% endaction %}\n\n    {% when \"list\" %}\n      {% action \"echo\" price_change_events: price_change_events %}\n\n    {% when \"email\" %}\n      {% if price_change_events == blank %}\n        {% assign email_body = \"There are currently no configured price change events\" %}\n\n      {% else %}\n        {% capture email_body %}\n          Currently configured price change events, using the {{ task_admin_link }} task within the Mechanic app.\n\n          {% for price_change_event in price_change_events -%}\n            {%- assign price_change_event_id = price_change_event[0] -%}\n            {%- assign price_change_event_data = price_change_event[1] -%}\n            <strong>Price change event ID:</strong> {{ price_change_event_id }}\n            <strong>Status:</strong> {{ price_change_event_data[\"status\"] }}\n            <strong>Event start:</strong> {{ price_change_event_data[\"start\"] | date: \"%FT%H:%M%z\" }}\n            <strong>Event end:</strong> {{ price_change_event_data[\"end\"] | date: \"%FT%H:%M%z\" }}\n            <strong>Set compare at price to original price during event:</strong> {{ price_change_event_data[\"set_compare_at_prices\"] }}\n            <strong>Collection handles and discounts:</strong>\n            {% for keyval in price_change_event_data[\"collection_handles_and_discounts\"] -%}\n            - {{ keyval[0] }}: {{ keyval[1] }}\n            {% else -%}\n              n/a\n            {%- endfor %}\n            <strong>SKUs to include:</strong> {{ price_change_event_data[\"skus_to_include\"] | join: \", \" | default: \"n/a\" }}\n            <strong>SKU discount:</strong> {{ price_change_event_data[\"sku_discount\"] | default: \"n/a\" }},\n            <strong>SKUs to exclude:</strong> {{ price_change_event_data[\"skus_to_exclude\"] | join: \", \" | default: \"n/a\" }}\n            <strong>Exclude products tagged with:</strong> {{ price_change_event_data[\"exclude_products_tagged_with\"] | join: \", \" | default: \"n/a\" }}\n            <hr />\n          {%- endfor %}\n        {% endcapture %}\n      {% endif %}\n\n      {% action \"email\" %}\n        {\n          \"to\": {{ email_recipients | json }},\n          \"subject\": \"All price change events as of {{ \"now\" | date: \"%F\" }}\",\n          \"body\": {{ email_body | newline_to_br | json }},\n          \"reply_to\": {{ shop.contactEmail | json }},\n          \"from_display_name\": {{ shop.name | json }}\n        }\n      {% endaction %}\n\n    {% when \"reset\" %}\n      {% action \"event\" %}\n        {\n          \"topic\": \"user/price_changes/reset\",\n          \"task_id\": {{ task.id | json }}\n        }\n      {% endaction %}\n\n    {% else %}\n      {% if action_keyword contains \"cancel\" %}\n        {% assign price_change_event_id = action_keyword | remove: \"cancel \" %}\n        {% assign price_change_event = price_change_events[price_change_event_id] %}\n\n        {% if price_change_event == blank %}\n          {% error \"Keyword of 'cancel' entered with an invalid price change event ID. Run task with 'list' keyword to see a list of all configured price change events.\" %}\n          {% break %}\n        {% endif %}\n\n        {% if price_change_event.status == \"scheduled\" %}\n          {% comment %}\n            -- price change event has not started, so can just update it to cancelled and when the start/end events run they will ignore this event\n          {% endcomment %}\n\n          {% assign price_change_event[\"status\"] = \"cancelled\" %}\n          {% assign price_change_events[price_change_event_id] = price_change_event %}\n\n          {% action \"shopify\" %}\n            mutation {\n              metafieldsSet(\n                metafields: [\n                  {\n                    ownerId: {{ shop.id | json }}\n                    namespace: \"mechanic\"\n                    key: \"price_change_events\"\n                    value: {{ price_change_events | json | json }}\n                    type: \"json\"\n                  }\n                ]\n              ) {\n                metafields {\n                  id\n                  namespace\n                  key\n                  type\n                  jsonValue\n                  owner {\n                    ... on Shop {\n                      id\n                      name\n                      myshopifyDomain\n                    }\n                  }\n                }\n                userErrors {\n                  code\n                  field\n                  message\n                }\n              }\n            }\n          {% endaction %}\n\n          {% capture email_subject %}Scheduled price change event has been cancelled ({{ price_change_event_id }}){% endcapture %}\n\n          {% capture email_body %}\n            A scheduled price change event has been cancelled, from the {{ task_admin_link }} task within the Mechanic app.\n\n            <strong>Price change event ID:</strong> {{ price_change_event_id }}\n            <strong>Status:</strong> {{ price_change_event[\"status\"] }}\n            <strong>Event start:</strong> {{ price_change_event[\"start\"] | date: \"%FT%H:%M%z\" }}\n            <strong>Event end:</strong> {{ price_change_event[\"end\"] | date: \"%FT%H:%M%z\" }}\n            <strong>Set compare at price to original price during event:</strong> {{ price_change_event[\"set_compare_at_prices\"] }}\n            <strong>Collection handles and discounts:</strong>\n            {% for keyval in price_change_event[\"collection_handles_and_discounts\"] -%}\n            - {{ keyval[0] }}: {{ keyval[1] }}\n            {% else -%}\n              n/a\n            {%- endfor %}\n            <strong>SKUs to include:</strong> {{ price_change_event[\"skus_to_include\"] | join: \", \" | default: \"n/a\" }}\n            <strong>SKU discount:</strong> {{ price_change_event[\"sku_discount\"] | default: \"n/a\" }},\n            <strong>SKUs to exclude:</strong> {{ price_change_event[\"skus_to_exclude\"] | join: \", \" | default: \"n/a\" }}\n            <strong>Exclude products tagged with:</strong> {{ price_change_event[\"exclude_products_tagged_with\"] | join: \", \" | default: \"n/a\" }}\n          {% endcapture %}\n\n          {% action \"email\" %}\n            {\n              \"to\": {{ email_recipients | json }},\n              \"subject\": {{ email_subject | json }},\n              \"body\": {{ email_body | newline_to_br | json }},\n              \"reply_to\": {{ shop.contactEmail | json }},\n              \"from_display_name\": {{ shop.name | json }}\n            }\n          {% endaction %}\n\n        {% elsif price_change_event.status == \"ongoing\" %}\n          {% comment %}\n            -- price change event in progress, so we have to revert the price changes to properly cancel it\n          {% endcomment %}\n\n          {% action \"event\" %}\n            {\n              \"topic\": \"user/price_changes/end\",\n              \"task_id\": {{ task.id | json }},\n              \"data\": {\n                \"price_change_event_id\": {{ price_change_event_id | json }},\n                \"cancel\": true\n              }\n            }\n          {% endaction %}\n\n        {% else %}\n          {% action \"echo\"\n            message: \"Price change event cannot be cancelled because it does not have a status of 'scheduled' or 'ongoing'\",\n            price_change_event: price_change_event\n          %}\n        {% endif %}\n\n      {% else %}\n        {% error\n          message: \"Unrecognized action keyword. Action keyword must be one of 'schedule', 'list', 'email', 'cancel', or 'reset\",\n          action_keyword: action_keyword\n        %}\n      {% endif %}\n  {% endcase %}\n\n{% elsif event.topic == \"user/price_changes/start\" %}\n  {% assign price_change_event_id = event.data.price_change_event_id %}\n  {% assign price_change_event = price_change_events[price_change_event_id] %}\n\n  {% if event.preview %}\n    {% assign price_change_event_id = \"01234567-89ab-cdef\" %}\n\n    {% capture price_change_event_json %}\n      {\n        \"status\": \"scheduled\",\n        \"start\": {{ \"now + 1 day\" | date: \"%FT%H:%M%z\" | json }},\n        \"end\": {{ \"now + 2 days\" | date: \"%FT%H:%M%z\" | json }},\n        \"set_compare_at_prices\": false,\n        \"collection_handles_and_discounts\": {\n          \"alpha-beta-gamma\": \"10%\",\n          \"sticks-and-stones\": \"-5.50\",\n          \"lorem-ipsum\": \"3\"\n        },\n        \"skus_to_include\": [\n          \"SKU-123\",\n          \"SKU-456\"\n        ],\n        \"sku_discount\": \"15%\",\n        \"skus_to_exclude\": [\n          \"SKU-987\"\n        ],\n        \"exclude_products_tagged_with\": [\n          \"do-not-discount\"\n        ]\n      }\n    {% endcapture %}\n\n    {% assign price_change_event = price_change_event_json | parse_json %}\n  {% endif %}\n\n  {% assign status = price_change_event.status %}\n  {% assign set_compare_at_prices = price_change_event.set_compare_at_prices %}\n  {% assign collection_handles_and_discounts = price_change_event.collection_handles_and_discounts %}\n  {% assign skus_to_include = price_change_event.skus_to_include %}\n  {% assign sku_discount = price_change_event.sku_discount %}\n  {% assign exclude_products_tagged_with = price_change_event.exclude_products_tagged_with %}\n  {% assign skus_to_exclude = price_change_event.skus_to_exclude %}\n\n  {% if status != \"scheduled\" %}\n    {% log\n      message: \"This price change event does not have a status of scheduled, and thus will not start.\",\n      price_change_event: price_change_event\n    %}\n    {% break %}\n  {% endif %}\n\n  {% comment %}\n    -- get collection ids for products query\n  {% endcomment %}\n\n  {% assign in_collection_checks = array %}\n\n  {% for keyval in collection_handles_and_discounts %}\n    {% capture query %}\n      query {\n        collectionByIdentifier(\n          identifier: {\n            handle: {{ keyval[0] | json }}\n          }\n        ) {\n          id\n          handle\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = query | shopify %}\n\n    {% assign collection = result.data.collectionByIdentifier %}\n\n    {% if collection != blank %}\n      {% capture in_collection_check -%}\n        inCollection_{{ collection.handle | replace: \"-\", \"_\" }}: inCollection(id: {{ collection.id | json }})\n      {%- endcapture %}\n\n      {% assign in_collection_checks = in_collection_checks | push: in_collection_check %}\n    {% endif %}\n  {% endfor %}\n\n  {% comment %}\n    -- get all products in the shop (up to 50K), unless excluded by tag\n  {% endcomment %}\n\n  {% assign search_query = \"gift_card:false\" %}\n\n  {% for tag in exclude_products_tagged_with %}\n    {% assign search_query = tag | json | prepend: \" tag_not:\" | prepend: search_query  %}\n  {% endfor %}\n\n  {% log search_query: search_query %}\n\n  {% assign products = array %}\n  {% assign cursor = nil %}\n\n  {% for n in (1..200) %}\n    {% capture query %}\n      query {\n        products(\n          first: 250\n          after: {{ cursor | json }}\n          query: {{ search_query | json }}\n        ) {\n          pageInfo {\n            hasNextPage\n            endCursor\n          }\n          nodes {\n            id\n            title\n            tags\n            variants(first: 100) {\n              nodes {\n                id\n                displayName\n                sku\n                price\n                compareAtPrice\n                metafield(key: \"mechanic.price_change_event\") {\n                  jsonValue\n                }\n              }\n            }\n            {{ in_collection_checks | join: newline }}\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = query | shopify %}\n\n    {% if event.preview %}\n      {% capture result_json %}\n        {\n          \"data\": {\n            \"products\": {\n              \"nodes\": [\n                {\n                  \"id\": \"gid://shopify/Product/1234567890\",\n                  \"variants\": {\n                    \"nodes\": [\n                      {\n                        \"id\": \"gid://shopify/ProductVariant/1234567890\",\n                        \"sku\": \"ACME-BRICK-RED\",\n                        \"price\": \"10.00\",\n                        \"compareAtPrice\": \"15.00\",\n                        \"metafield\": null\n                      }\n                    ]\n                  },\n                  \"inCollection_{{ collection_handles_and_discounts.first.first | replace: \"-\", \"_\" | default: \"sample\" }}\": true\n                }\n              ]\n            }\n          }\n        }\n      {% endcapture %}\n\n      {% assign result = result_json | parse_json %}\n    {% endif %}\n\n    {% assign products = products | concat: result.data.products.nodes %}\n\n    {% if result.data.products.pageInfo.hasNextPage %}\n      {% assign cursor = result.data.products.pageInfo.endCursor %}\n    {% else %}\n      {% break %}\n    {% endif %}\n  {% endfor %}\n\n  {% comment %}\n    -- process products to see which qualify for metafield and variant updates\n  {% endcomment %}\n\n  {% assign metafield_set_inputs = array %}\n  {% assign variant_inputs_by_product = hash %}\n\n  {% for product in products %}\n    {% comment %}\n      -- For each product, match to a collection discount if applicable, then, if needed, loop through variants to see if there are any overrides\n    {% endcomment %}\n\n    {% assign product_level_discount = nil %}\n\n    {% for keyval in collection_handles_and_discounts %}\n      {% assign in_collection_label\n        = \"inCollection_\"\n        | append: keyval[0]\n        | replace: \"-\", \"_\"\n      %}\n\n      {% if product[in_collection_label] %}\n        {% assign product_level_discount = keyval[1] %}\n        {% break %}\n      {% endif %}\n    {% endfor %}\n\n    {% if product_level_discount == blank and skus_to_include == blank and skus_to_exclude == blank %}\n      {% comment %}\n        -- skip the product if it is not in a configured collection and there are no inclusion/exclusion SKUs configured\n      {% endcomment %}\n\n      {% continue %}\n    {% endif %}\n\n    {% for variant in product.variants.nodes %}\n      {% if skus_to_exclude != blank and skus_to_exclude contains variant.sku %}\n        {% log\n          message: \"This variant was excluded by SKU\",\n          variant: variant\n        %}\n        {% continue %}\n      {% endif %}\n\n      {% if variant.metafield != blank %}\n        {% log\n          message: \"This variant is already part of a price change event; skipping.\",\n          variant: variant\n        %}\n        {% continue %}\n      {% endif %}\n\n      {% assign discount_to_apply = product_level_discount %}\n\n      {% if skus_to_include != blank and skus_to_include contains variant.sku %}\n        {% assign discount_to_apply = sku_discount %}\n      {% endif %}\n\n      {% if discount_to_apply == blank %}\n        {% continue %}\n      {% endif %}\n\n      {% comment %}\n        -- make sure prices are strings when being passed in GraphQL mutations\n      {% endcomment %}\n\n      {% assign price_to_set = nil %}\n      {% assign compare_at_price_to_set = nil %}\n\n      {% if discount_to_apply contains \"%\" %}\n        {% assign price_to_set\n          = discount_to_apply\n          | remove: \"%\"\n          | minus: 100\n          | abs\n          | times: variant.price\n          | divided_by: 100\n          | round: 2\n          | append: \"\"\n        %}\n\n      {% elsif discount_to_apply contains \"-\" %}\n        {% assign price_to_set\n          = variant.price\n          | plus: discount_to_apply\n          | at_least: 0.0\n          | append: \"\"\n        %}\n\n      {% else %}\n        {% assign price_to_set = discount_to_apply | append: \"\" %}\n      {% endif %}\n\n      {% if set_compare_at_prices %}\n        {% assign compare_at_price_to_set = variant.price %}\n      {% endif %}\n\n      {% log\n        product: product.title,\n        product_level_discount: product_level_discount,\n        variant: variant.displayName,\n        discount_to_apply: discount_to_apply,\n        price_to_set: price_to_set,\n        compare_at_price_to_set: compare_at_price_to_set\n      %}\n\n      {% assign price_change_event_data = hash %}\n      {% assign price_change_event_data[\"price_change_event_id\"] = price_change_event_id %}\n      {% assign price_change_event_data[\"discount_to_apply\"] = discount_to_apply %}\n      {% assign price_change_event_data[\"original_price\"] = variant.price %}\n      {% assign price_change_event_data[\"price_to_set\"] = price_to_set %}\n\n      {% if set_compare_at_prices %}\n        {% assign price_change_event_data[\"original_compare_at_price\"] = variant.compareAtPrice %}\n        {% assign price_change_event_data[\"compare_at_price_to_set\"] = compare_at_price_to_set %}\n      {% endif %}\n\n      {% assign metafield_set_input = hash %}\n      {% assign metafield_set_input[\"ownerId\"] = variant.id %}\n      {% assign metafield_set_input[\"namespace\"] = \"mechanic\" %}\n      {% assign metafield_set_input[\"key\"] = \"price_change_event\" %}\n      {% assign metafield_set_input[\"type\"] = \"json\" %}\n      {% assign metafield_set_input[\"value\"] = price_change_event_data | json %}\n      {% assign metafield_set_inputs = metafield_set_inputs | push: metafield_set_input %}\n\n      {% assign variant_input = hash %}\n      {% assign variant_input[\"id\"] = variant.id %}\n      {% assign variant_input[\"price\"] = price_to_set %}\n\n      {% if set_compare_at_prices %}\n        {% assign variant_input[\"compareAtPrice\"] = variant.price %}\n      {% endif %}\n\n      {% assign variant_inputs_by_product[product.id]\n        = variant_inputs_by_product[product.id]\n        | default: array\n        | push: variant_input\n      %}\n    {% endfor %}\n  {% endfor %}\n\n  {% comment %}\n    -- set metafields and then update variants in bulk\n  {% endcomment %}\n\n  {% if metafield_set_inputs != blank %}\n    {% assign groups_of_metafield_set_inputs = metafield_set_inputs | in_groups_of: 25, fill_with: false %}\n\n    {% for group_of_metafield_set_inputs in groups_of_metafield_set_inputs %}\n      {% action \"shopify\" %}\n        mutation {\n          metafieldsSet(\n            metafields: {{ group_of_metafield_set_inputs | graphql_arguments }}\n          ) {\n            metafields {\n              id\n              namespace\n              key\n              type\n              jsonValue\n              owner {\n                ... on ProductVariant {\n                  id\n                  displayName\n                }\n              }\n            }\n            userErrors {\n              code\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endfor %}\n  {% endif %}\n\n  {% for keyval in variant_inputs_by_product %}\n    {% action \"shopify\" %}\n      mutation {\n        productVariantsBulkUpdate(\n          productId: {{ keyval[0] | json }}\n          variants: {{ keyval[1] | graphql_arguments }}\n        ) {\n          product {\n            id\n            title\n            tags\n          }\n          productVariants {\n            id\n            displayName\n            sku\n            price\n            compareAtPrice\n          }\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endfor %}\n\n  {% comment %}\n    -- update the price change event\n  {% endcomment %}\n\n  {% assign price_change_event[\"status\"] = \"ongoing\" %}\n  {% assign price_change_events[price_change_event_id] = price_change_event %}\n\n  {% action \"shopify\" %}\n    mutation {\n      metafieldsSet(\n        metafields: [\n          {\n            ownerId: {{ shop.id | json }}\n            namespace: \"mechanic\"\n            key: \"price_change_events\"\n            value: {{ price_change_events | json | json }}\n            type: \"json\"\n          }\n        ]\n      ) {\n        metafields {\n          id\n          namespace\n          key\n          type\n          jsonValue\n          owner {\n            ... on Shop {\n              id\n              name\n              myshopifyDomain\n            }\n          }\n        }\n        userErrors {\n          code\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n\n  {% capture email_subject %}A scheduled price change event has started ({{ price_change_event_id }}){% endcapture %}\n\n  {% capture email_body %}\n    A scheduled price change event has started, using the {{ task_admin_link }} task within the Mechanic app.\n\n    <strong>Price change event ID:</strong> {{ price_change_event_id }}\n    <strong>Status:</strong> {{ price_change_event[\"status\"] }}\n    <strong>Event start:</strong> {{ price_change_event[\"start\"] | date: \"%FT%H:%M%z\" }}\n    <strong>Event end:</strong> {{ price_change_event[\"end\"] | date: \"%FT%H:%M%z\" }}\n    <strong>Set compare at price to original price during event:</strong> {{ price_change_event[\"set_compare_at_prices\"] }}\n    <strong>Collection handles and discounts:</strong>\n    {% for keyval in price_change_event[\"collection_handles_and_discounts\"] -%}\n    - {{ keyval[0] }}: {{ keyval[1] }}\n    {% else -%}\n      n/a\n    {%- endfor %}\n    <strong>SKUs to include:</strong> {{ price_change_event[\"skus_to_include\"] | join: \", \" | default: \"n/a\" }}\n    <strong>SKU discount:</strong> {{ price_change_event[\"sku_discount\"] | default: \"n/a\" }},\n    <strong>SKUs to exclude:</strong> {{ price_change_event[\"skus_to_exclude\"] | join: \", \" | default: \"n/a\" }}\n    <strong>Exclude products tagged with:</strong> {{ price_change_event[\"exclude_products_tagged_with\"] | join: \", \" | default: \"n/a\" }}\n\n    <em><strong>Note:</strong> To cancel this event while it is ongoing, use the \"cancel\" keyword along with the price change event ID when running the task.</em>\n  {% endcapture %}\n\n  {% action \"email\" %}\n    {\n      \"to\": {{ email_recipients | json }},\n      \"subject\": {{ email_subject | json }},\n      \"body\": {{ email_body | newline_to_br | json }},\n      \"reply_to\": {{ shop.contactEmail | json }},\n      \"from_display_name\": {{ shop.name | json }}\n    }\n  {% endaction %}\n\n{% elsif event.topic == \"user/price_changes/end\" %}\n  {% assign price_change_event_id = event.data.price_change_event_id %}\n  {% assign price_change_event = price_change_events[price_change_event_id] %}\n  {% assign set_compare_at_prices = price_change_event.set_compare_at_prices %}\n\n  {% if event.preview %}\n    {% assign price_change_event_id = \"01234567-89ab-cdef\" %}\n    {% assign price_change_event = hash %}\n    {% assign price_change_event[\"status\"] = \"ongoing\" %}\n  {% endif %}\n\n  {% if event.data.cancel %}\n    {% comment %}\n      -- go ahead and cancel, as status was already checked to be \"scheduled\" prior to custom event call\n    {% endcomment %}\n\n    {% assign price_change_event[\"status\"] = \"cancelled\" %}\n\n  {% else %}\n    {% comment %}\n      -- since this was a scheduled run, need to make sure the event status is \"ongoing\" before reverting changes\n    {% endcomment %}\n\n    {% if price_change_event.status != \"ongoing\" %}\n      {% log\n        message: \"This price change event does not have a status of 'ongoing', and thus will not be reverted.\",\n        price_change_event: price_change_event\n      %}\n      {% break %}\n    {% endif %}\n\n    {% assign price_change_event[\"status\"] = \"completed\" %}\n  {% endif %}\n\n  {% comment %}\n    -- To revert the price change event, check every variant in the shop to see if the metafield exists and contains this price change event ID\n  {% endcomment %}\n\n  {% assign products = array %}\n  {% assign cursor = nil %}\n\n  {% for n in (1..200) %}\n    {% capture query %}\n      query {\n        products(\n          first: 250\n          after: {{ cursor | json }}\n          query: \"gift_card:false\"\n        ) {\n          pageInfo {\n            hasNextPage\n            endCursor\n          }\n          nodes {\n            id\n            title\n            tags\n            variants(first: 100) {\n              nodes {\n                id\n                displayName\n                sku\n                price\n                compareAtPrice\n                metafield(key: \"mechanic.price_change_event\") {\n                  jsonValue\n                }\n              }\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = query | shopify %}\n\n    {% if event.preview %}\n      {% capture result_json %}\n        {\n          \"data\": {\n            \"products\": {\n              \"nodes\": [\n                {\n                  \"id\": \"gid://shopify/Product/1234567890\",\n                  \"variants\": {\n                    \"nodes\": [\n                      {\n                        \"id\": \"gid://shopify/ProductVariant/1234567890\",\n                        \"sku\": \"ACME-BRICK-RED\",\n                        \"price\": \"7.50\",\n                        \"compareAtPrice\": \"10.00\",\n                        \"metafield\": {\n                          \"id\": \"gid://shopify/Metafield/9876543210\",\n                          \"jsonValue\": {\n                            \"price_change_event_id\": \"01234567-89ab-cdef\",\n                            \"discount_to_apply\": \"25%\",\n                            \"original_price\": \"10.00\",\n                            \"price_to_set\": \"7.50\",\n                            \"original_compare_at_price\": \"15.00\",\n                            \"compare_at_price_to_set\": \"7.50\"\n                          }\n                        }\n                      }\n                    ]\n                  }\n                }\n              ]\n            }\n          }\n        }\n      {% endcapture %}\n\n      {% assign result = result_json | parse_json %}\n    {% endif %}\n\n    {% assign products = products | concat: result.data.products.nodes %}\n\n    {% if result.data.products.pageInfo.hasNextPage %}\n      {% assign cursor = result.data.products.pageInfo.endCursor %}\n    {% else %}\n      {% break %}\n    {% endif %}\n  {% endfor %}\n\n  {% comment %}\n    -- process products to see which qualify for metafield deletion and variant price reversion\n  {% endcomment %}\n\n  {% assign metafield_delete_inputs = array %}\n  {% assign variant_inputs_by_product = hash %}\n\n  {% for product in products %}\n    {% assign variants_with_metafield = product.variants.nodes | where: \"metafield\" %}\n\n    {% for variant in variants_with_metafield %}\n      {% assign price_change_event_data = variant.metafield.jsonValue %}\n\n      {% unless price_change_event_data.price_change_event_id == price_change_event_id %}\n        {% log\n          message: \"This variant is part of a separate price change event; skipping.\",\n          variant: variant\n        %}\n        {% continue %}\n      {% endunless %}\n\n      {% assign metafield_delete_input = hash %}\n      {% assign metafield_delete_input[\"ownerId\"] = variant.id %}\n      {% assign metafield_delete_input[\"namespace\"] = \"mechanic\" %}\n      {% assign metafield_delete_input[\"key\"] = \"price_change_event\" %}\n      {% assign metafield_delete_inputs = metafield_delete_inputs | push: metafield_delete_input %}\n\n      {% assign variant_input = hash %}\n      {% assign variant_input[\"id\"] = variant.id %}\n\n      {% assign original_price = price_change_event_data.original_price | append: \"\" %}\n      {% assign original_compare_at_price = price_change_event_data.original_compare_at_price | append: \"\" %}\n\n      {% if original_price != variant.price %}\n        {% assign variant_input[\"price\"] = original_price %}\n      {% endif %}\n\n      {% comment %}\n        -- revert compare at price if the option was enabled for the event; this includes reverting to null if applicable\n      {% endcomment %}\n\n      {% if price_change_event[\"set_compare_at_prices\"] %}\n        {% if original_compare_at_price != variant.compareAtPrice %}\n          {% assign variant_input[\"compareAtPrice\"] = original_compare_at_price | default: nil %}\n        {% endif %}\n      {% endif %}\n\n      {% if variant_input[\"price\"] or variant_input[\"compareAtPrice\"] %}\n        {% assign variant_inputs_by_product[product.id]\n          = variant_inputs_by_product[product.id]\n          | default: array\n          | push: variant_input\n        %}\n      {% endif %}\n    {% endfor %}\n  {% endfor %}\n\n  {% comment %}\n    -- update variants in bulk and then delete the price change event metafields\n  {% endcomment %}\n\n  {% for keyval in variant_inputs_by_product %}\n    {% action \"shopify\" %}\n      mutation {\n        productVariantsBulkUpdate(\n          productId: {{ keyval[0] | json }}\n          variants: {{ keyval[1] | graphql_arguments }}\n        ) {\n          product {\n            id\n            title\n            tags\n          }\n          productVariants {\n            id\n            displayName\n            sku\n            price\n            compareAtPrice\n          }\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endfor %}\n\n  {% if metafield_delete_inputs != blank %}\n    {% assign groups_of_metafield_delete_inputs = metafield_delete_inputs | in_groups_of: 250, fill_with: false %}\n\n    {% for group_of_metafield_delete_inputs in groups_of_metafield_delete_inputs %}\n      {% action \"shopify\" %}\n        mutation {\n          metafieldsDelete(\n            metafields: {{ group_of_metafield_delete_inputs | graphql_arguments }}\n          ) {\n            deletedMetafields {\n              ownerId\n              namespace\n              key\n            }\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endfor %}\n  {% endif %}\n\n  {% comment %}\n    -- update the price change event\n  {% endcomment %}\n\n  {% assign price_change_events[price_change_event_id] = price_change_event %}\n\n  {% action \"shopify\" %}\n    mutation {\n      metafieldsSet(\n        metafields: [\n          {\n            ownerId: {{ shop.id | json }}\n            namespace: \"mechanic\"\n            key: \"price_change_events\"\n            value: {{ price_change_events | json | json }}\n            type: \"json\"\n          }\n        ]\n      ) {\n        metafields {\n          id\n          namespace\n          key\n          type\n          value\n          owner {\n            ... on Shop {\n              id\n              name\n              myshopifyDomain\n            }\n          }\n        }\n        userErrors {\n          code\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n\n  {% comment %}\n    -- send email notification about the price change event status change\n  {% endcomment %}\n\n  {% capture email_subject %}A price change event has been {{ price_change_event[\"status\"] }} ({{ price_change_event_id }}){% endcapture %}\n\n  {% capture email_body %}\n    A price change event has been {{ price_change_event[\"status\"] }}, using the {{ task_admin_link }} task within the Mechanic app.\n\n    <strong>Price change event ID:</strong> {{ price_change_event_id }}\n    <strong>Status:</strong> {{ price_change_event[\"status\"] }}\n    <strong>Event start:</strong> {{ price_change_event[\"start\"] | date: \"%FT%H:%M%z\" }}\n    <strong>Event end:</strong> {{ price_change_event[\"end\"] | date: \"%FT%H:%M%z\" }}\n    <strong>Set compare at price to original price during event:</strong> {{ price_change_event[\"set_compare_at_prices\"] }}\n    <strong>Collection handles and discounts:</strong>\n    {% for keyval in price_change_event[\"collection_handles_and_discounts\"] -%}\n    - {{ keyval[0] }}: {{ keyval[1] }}\n    {% else -%}\n      n/a\n    {%- endfor %}\n    <strong>SKUs to include:</strong> {{ price_change_event[\"skus_to_include\"] | join: \", \" | default: \"n/a\" }}\n    <strong>SKU discount:</strong> {{ price_change_event[\"sku_discount\"] | default: \"n/a\" }},\n    <strong>SKUs to exclude:</strong> {{ price_change_event[\"skus_to_exclude\"] | join: \", \" | default: \"n/a\" }}\n    <strong>Exclude products tagged with:</strong> {{ price_change_event[\"exclude_products_tagged_with\"] | join: \", \" | default: \"n/a\" }}\n  {% endcapture %}\n\n  {% action \"email\" %}\n    {\n      \"to\": {{ email_recipients | json }},\n      \"subject\": {{ email_subject | json }},\n      \"body\": {{ email_body | newline_to_br | json }},\n      \"reply_to\": {{ shop.contactEmail | json }},\n      \"from_display_name\": {{ shop.name | json }}\n    }\n  {% endaction %}\n\n{% elsif event.topic == \"user/price_changes/reset\" %}\n  {% comment %}\n    -- To reset price change events, check every variant in the shop to see if the price change event metafield exists\n  {% endcomment %}\n\n  {% assign products = array %}\n  {% assign cursor = nil %}\n\n  {% for n in (1..200) %}\n    {% capture query %}\n      query {\n        products(\n          first: 250\n          after: {{ cursor | json }}\n          query: \"gift_card:false\"\n        ) {\n          pageInfo {\n            hasNextPage\n            endCursor\n          }\n          nodes {\n            id\n            title\n            tags\n            variants(first: 100) {\n              nodes {\n                id\n                displayName\n                sku\n                price\n                compareAtPrice\n                metafield(key: \"mechanic.price_change_event\") {\n                  jsonValue\n                }\n              }\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = query | shopify %}\n\n    {% if event.preview %}\n      {% capture result_json %}\n        {\n          \"data\": {\n            \"products\": {\n              \"nodes\": [\n                {\n                  \"id\": \"gid://shopify/Product/1234567890\",\n                  \"variants\": {\n                    \"nodes\": [\n                      {\n                        \"id\": \"gid://shopify/ProductVariant/1234567890\",\n                        \"sku\": \"ACME-BRICK-RED\",\n                        \"price\": \"7.50\",\n                        \"compareAtPrice\": \"10.00\",\n                        \"metafield\": {\n                          \"id\": \"gid://shopify/Metafield/9876543210\",\n                          \"jsonValue\": {\n                            \"price_change_event_id\": \"01234567-89ab-cdef\",\n                            \"discount_to_apply\": \"25%\",\n                            \"original_price\": \"10.00\",\n                            \"price_to_set\": \"7.50\",\n                            \"original_compare_at_price\": \"15.00\",\n                            \"compare_at_price_to_set\": \"7.50\"\n                          }\n                        }\n                      }\n                    ]\n                  }\n                }\n              ]\n            }\n          }\n        }\n      {% endcapture %}\n\n      {% assign result = result_json | parse_json %}\n    {% endif %}\n\n    {% assign products = products | concat: result.data.products.nodes %}\n\n    {% if result.data.products.pageInfo.hasNextPage %}\n      {% assign cursor = result.data.products.pageInfo.endCursor %}\n    {% else %}\n      {% break %}\n    {% endif %}\n  {% endfor %}\n\n  {% comment %}\n    -- process products to see which qualify for metafield deletion and variant price reversion\n  {% endcomment %}\n\n  {% assign metafield_delete_inputs = array %}\n  {% assign variant_inputs_by_product = hash %}\n  {% assign variants_with_prices_to_not_reset = array %}\n\n  {% for product in products %}\n    {% assign variants_with_metafield = product.variants.nodes | where: \"metafield\" %}\n\n    {% for variant in variants_with_metafield %}\n      {% assign price_change_event_data = variant.metafield.jsonValue %}\n\n      {% assign metafield_delete_input = hash %}\n      {% assign metafield_delete_input[\"ownerId\"] = variant.id %}\n      {% assign metafield_delete_input[\"namespace\"] = \"mechanic\" %}\n      {% assign metafield_delete_input[\"key\"] = \"price_change_event\" %}\n      {% assign metafield_delete_inputs = metafield_delete_inputs | push: metafield_delete_input %}\n\n      {% if do_not_restore_prices_on_reset %}\n        {% assign variants_with_prices_to_not_reset = variants_with_prices_to_not_reset | push: variant %}\n        {% continue %}\n      {% endif %}\n\n      {% assign variant_input = hash %}\n      {% assign variant_input[\"id\"] = variant.id %}\n\n      {% assign original_price = price_change_event_data.original_price | append: \"\" %}\n      {% assign original_compare_at_price = price_change_event_data.original_compare_at_price | append: \"\" %}\n\n      {% if original_price != variant.price %}\n        {% assign variant_input[\"price\"] = original_price %}\n      {% endif %}\n\n      {% if original_compare_at_price != blank and original_compare_at_price != variant.compareAtPrice %}\n        {% assign variant_input[\"compareAtPrice\"] = original_compare_at_price %}\n      {% endif %}\n\n      {% if variant_input[\"price\"] or variant_input[\"compareAtPrice\"] %}\n        {% assign variant_inputs_by_product[product.id]\n          = variant_inputs_by_product[product.id]\n          | default: array\n          | push: variant_input\n        %}\n      {% endif %}\n    {% endfor %}\n  {% endfor %}\n\n  {% comment %}\n    -- update variant prices in bulk (unless opting not to) and then delete the price change event metafields\n  {% endcomment %}\n\n  {% if do_not_restore_prices_on_reset %}\n    {% log\n      do_not_restore_prices_on_reset: do_not_restore_prices_on_reset,\n      variants_with_prices_to_not_reset: variants_with_prices_to_not_reset\n    %}\n\n  {% else %}\n    {% for keyval in variant_inputs_by_product %}\n      {% action \"shopify\" %}\n        mutation {\n          productVariantsBulkUpdate(\n            productId: {{ keyval[0] | json }}\n            variants: {{ keyval[1] | graphql_arguments }}\n          ) {\n            product {\n              id\n              title\n              tags\n            }\n            productVariants {\n              id\n              displayName\n              sku\n              price\n              compareAtPrice\n            }\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endfor %}\n  {% endif %}\n\n  {% if metafield_delete_inputs != blank %}\n    {% assign groups_of_metafield_delete_inputs = metafield_delete_inputs | in_groups_of: 250, fill_with: false %}\n\n    {% for group_of_metafield_delete_inputs in groups_of_metafield_delete_inputs %}\n      {% action \"shopify\" %}\n        mutation {\n          metafieldsDelete(\n            metafields: {{ group_of_metafield_delete_inputs | graphql_arguments }}\n          ) {\n            deletedMetafields {\n              ownerId\n              namespace\n              key\n            }\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endfor %}\n  {% endif %}\n\n  {% comment %}\n    -- delete the price change events shop metafield if needed\n  {% endcomment %}\n\n  {% if shop.metafield != blank %}\n    {% action \"shopify\" %}\n      mutation {\n        metafieldsDelete(\n          metafields: [\n            {\n              ownerId: {{ shop.id | json }}\n              namespace: \"mechanic\"\n              key: \"price_change_events\"\n            }\n          ]\n        ) {\n          deletedMetafields {\n            ownerId\n            namespace\n            key\n          }\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endif %}\n\n  {% comment %}\n    -- send email notification about the price change events reset\n  {% endcomment %}\n\n  {% capture email_subject %}All price change events have been cleared{% endcapture %}\n\n  {% capture email_body %}\n    {% if do_not_restore_prices_on_reset %}\n      All price change events have been cleared, using the {{ task_admin_link }} task within the Mechanic app.\n    {% else %}\n      All price change events have been cleared and related prices reset, using the {{ task_admin_link }} task within the Mechanic app.\n    {% endif %}\n  {% endcapture %}\n\n  {% action \"email\" %}\n    {\n      \"to\": {{ email_recipients | json }},\n      \"subject\": {{ email_subject | json }},\n      \"body\": {{ email_body | newline_to_br | json }},\n      \"reply_to\": {{ shop.contactEmail | json }},\n      \"from_display_name\": {{ shop.name | json }}\n    }\n  {% endaction %}\n{% endif %}\n",
  "subscriptions": [
    "mechanic/user/text",
    "user/price_changes/start",
    "user/price_changes/end",
    "user/price_changes/reset"
  ],
  "subscriptions_template": "mechanic/user/text\nuser/price_changes/start\nuser/price_changes/end\nuser/price_changes/reset",
  "tags": [
    "Advanced",
    "Discounts",
    "Price",
    "Products",
    "Sale",
    "Schedule"
  ]
}
