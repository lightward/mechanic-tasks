{
  "name": "Find all Duplicate SKU's",
  "options": {},
  "subscriptions": [
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "mechanic/user/trigger",
  "script": "{% if event.preview %}\n  {% capture result_json %}\n    {\n      \"data\": {\n        \"productVariants\": {\n          \"edges\": [\n            {\n              \"node\": {\n                \"id\": \"gid://shopify/ProductVariant/1234567890\",\n                \"sku\": \"sku-123\"\n              }\n            },\n            {\n              \"node\": {\n                \"id\": \"gid://shopify/ProductVariant/2345678901\",\n                \"sku\": \"sku-123\"\n              }\n            }\n          ]\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = result_json | parse_json %}\n{% endif %}\n\n{% assign mappings = hash %}\n{% assign dups = hash %}\n{% assign cursor = nil %}\n\n{% for i in (0..500) %}\n\n  {% assign after = i | times: 250 %}\n  {% capture query %}\n  query {\n    productVariants(first:250, after: {{ cursor | json }}) {\n      pageInfo {\n        hasNextPage\n      }\n      edges {\n        node {\n          id\n          sku\n        }\n        cursor\n      }\n    }\n  }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n  {% assign cursor = result.data.productVariants.edges.last.cursor %}\n\n  {% assign productVariants = result.data.productVariants.edges | map: \"node\" %}\n\n  {% for pv in productVariants %}\n    {% if pv.sku == null or pv.sku == empty %}\n      {% continue %}\n    {% endif %}\n    {% assign existingPv = mappings[pv.sku] %}\n    {% if existingPv %}\n      {% if existingPv != pv.id %}\n        {% assign dups[pv.sku] = true %}\n      {% endif %}\n    {% else %}\n      {% assign mappings[pv.sku] = pv.id %}\n    {% endif %}\n  {% endfor %}\n\n  {% unless result.data.productVariants.pageInfo.hasNextPage %}\n    {% break %}\n  {% endunless %}\n\n{% endfor %}\n\n{% action \"echo\" dups %}",
  "docs": "This task scans your entire product library for Duplicate SKU's and reports any duplictaes it finds. \nCurrent limitations are 500 iterations of 250 variants (125,000 variants). \nThe report only contains one version of each SKU.\nEmpty SKUs will aslo appear once.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false
}
