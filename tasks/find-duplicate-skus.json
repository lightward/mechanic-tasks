{
  "name": "Find duplicate SKUs",
  "options": {
    "exclude_inventory_not_tracked__boolean": true
  },
  "subscriptions": [
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "mechanic/user/trigger",
  "script": "{% assign skus_by_variant_id = hash %}\n{% assign cursor = nil %}\n\n{% for i in (0..500) %}\n  {% capture query %}\n    query {\n      productVariants(\n        first: 250\n        after: {{ cursor | json }}\n      ) {\n        pageInfo {\n          hasNextPage\n        }\n        edges {\n          node {\n            id\n            sku\n            inventoryItem {\n              tracked\n            }\n          }\n          cursor\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n      {\n        \"data\": {\n          \"productVariants\": {\n            \"edges\": [\n              {\n                \"node\": {\n                  \"id\": \"gid://shopify/ProductVariant/1234567890\",\n                  \"sku\": \"sku123\",\n                  \"inventoryItem\": {\n                    \"tracked\": true\n                  }\n                }\n              },\n              {\n                \"node\": {\n                  \"id\": \"gid://shopify/ProductVariant/2345678901\",\n                  \"sku\": \"sku123\",\n                  \"inventoryItem\": {\n                    \"tracked\": true\n                  }\n                }\n              }\n            ]\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n  \n  {% assign cursor = result.data.productVariants.edges.last.cursor %}\n  {% assign productVariants = result.data.productVariants.edges | map: \"node\" %}\n\n  {% for variant in productVariants %}\n    {% if variant.sku == blank %}\n      {% continue %}\n    {% endif %}\n\n    {% if options.exclude_products_that_do_not_track_inventory__boolean %}\n      {% if variant.inventoryItem.tracked == false %}\n        {% continue %}\n      {% endif %}\n    {% endif %}\n\n    {% assign skus_by_variant_id[variant.id] = variant.sku %}\n  {% endfor %}\n\n  {% unless result.data.productVariants.pageInfo.hasNextPage %}\n    {% break %}\n  {% endunless %}\n{% endfor %}\n\n{% assign all_skus = skus_by_variant_id | values %}\n{% assign unique_skus = all_skus | uniq %}\n\n{% if all_skus.size == unique_skus.size %}\n  {% comment %}\n    No exact duplicate SKUs, so let's end execution early\n  {% endcomment %}\n  {% log message: \"No duplicate SKUs found! :)\" %}\n  {% break %}\n{% endif %}\n\n{% assign variant_ids_by_duplicate_sku = hash %}\n\n{% for pair in skus_by_variant_id %}\n  {% assign variant_id = pair[0] %}\n  {% assign sku = pair[1] %}\n\n  {% assign sku_count = all_skus | where: sku | size %}\n\n  {% if sku_count == 0 %}\n    {% continue %}\n  {% endif %}\n\n  {% assign variant_ids_by_duplicate_sku[sku] = variant_ids_by_duplicate_sku[sku] | default: array | push: variant_id %}\n{% endfor %}\n\n{% assign duplicate_sku_count = variant_ids_by_duplicate_sku | size %}\n{% log message: \"Found duplicate SKU(s)\", duplicate_sku_count: duplicate_sku_count, variant_ids_by_duplicate_sku: variant_ids_by_duplicate_sku %}",
  "docs": "This task scans your entire product list, looking for duplicate SKUs using exact matching, and returning the list of duplicate SKUs (and the associated product variant IDs) if any are found.\n\nNote: SKUs that are identical apart from being uppercase/lowercase, for example, do not count as exact matches, and would not be considered duplicates by this task.\n\nThis report will only scan a store's first 125,000 product variants.\n\n\"Exclude products that do not track inventory\" will exclude any product whose inventory is not tracked in Shopify.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Products",
    "SKU"
  ]
}
