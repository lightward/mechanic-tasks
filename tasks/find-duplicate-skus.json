{
  "name": "Find all Exact Duplicate SKUs",
  "options": {
    "exclude_inventory_not_tracked__boolean": true
  },
  "subscriptions": [
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "mechanic/user/trigger",
  "script": "{% assign mappings = hash %}\n{% assign dups = hash %}\n{% assign cursor = nil %}\n\n{% for i in (0..500) %}\n\n  {% assign after = i | times: 250 %}\n  {% capture query %}\n  query {\n    productVariants(first:250, after: {{ cursor | json }}) {\n      pageInfo {\n        hasNextPage\n      }\n      edges {\n        node {\n          id\n          sku\n          inventoryItem{\n          tracked\n          }\n        }\n        cursor\n      }\n    }\n  }\n  {% endcapture %}\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n    {\n      \"data\": {\n        \"productVariants\": {\n          \"edges\": [\n            {\n              \"node\": {\n                \"id\": \"gid://shopify/ProductVariant/1234567890\",\n                \"sku\": \"sku123\",\n                \"inventoryItem\": {\n                  \"tracked\": \"true\"\n                }\n              }\n            },\n            {\n              \"node\": {\n                \"id\": \"gid://shopify/ProductVariant/123456789\",\n                \"sku\": \"sku123\",\n                \"inventoryItem\": {\n                  \"tracked\": \"true\"\n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n    {% endcapture %}\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n  \n  {% assign cursor = result.data.productVariants.edges.last.cursor %}\n  {% assign productVariants = result.data.productVariants.edges | map: \"node\" %}\n\n  {% for pv in productVariants %}\n    {% if pv.sku == null or pv.sku == empty %}\n      {% continue %}\n    {% endif %}\n    {% if options.exclude_inventory_not_tracked__boolean == true %}\n      {% if pv.inventoryItem.tracked == false %}\n        {% continue %}\n      {% endif %}\n    {% endif %}\n    {% assign existingPv = mappings[pv.sku] %}\n    {% if existingPv %}\n      {% if existingPv != pv.id %}\n        {% assign dups[pv.sku] = true %}\n      {% endif %}\n    {% else %}\n      {% assign mappings[pv.sku] = pv.id %}\n    {% endif %}\n  {% endfor %}\n\n  {% unless result.data.productVariants.pageInfo.hasNextPage %}\n    {% break %}\n  {% endunless %}\n\n{% endfor %}\n\n{% assign skus = productVariants | map:\"sku\" %}\n{% assign uniqskus = skus | uniq %}\n{% if skus.size == uniqskus.size %}\n  {% comment %}No exact duplicate SKUS {% endcomment %}\n  {%break %}\n{% endif %}\n\n{% action \"echo\" dups %}",
  "docs": "This task scans your entire product library for Exact Match Duplicate SKU's and outputs a list of duplicate SKU's found.\nThe report only contains one version of each SKU.\nThe report is limited to 500 iterations of 250 variants (125,000 variants). \nEmpty SKUs will appear once.\n\n\"Exclude inventory not tracked\" will exclude any product thats inventory is not tracked in Shopify.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Products",
    "SKU"
  ]
}
