{
  "docs": "Automatically prompt customers to activate their customer accounts, after placing an order in your store, by triggering a customizable Shopify-powered email. Useful if your online store unlocks special offers, functionality, or content after making a purchase. Optionally, only send invitations if the customer has a certain tag and/or has ordered a product with a specific tag.\n\nThis task works by asking Shopify to send along an invitation email, using the subject and body that you configure here. The email will use your Shopify account's \"Customer account invite\" email template, available in the \"Notifications\" area of your Shopify settings.\n\n**Note:** Because this task triggers a Shopify-powered email, and because this email already uses a Shopify template, the actual message body is optional. (If provided, HTML and CSS are not supported.) And, there's no need to add in an invitation link yourself â€“ this will be taken care of by the Shopify email template as well.\n\n",
  "halt_action_run_sequence_on_error": false,
  "name": "Auto-invite customers after an order",
  "online_store_javascript": null,
  "options": {
    "only_invite_if_the_customer_has_not_yet_been_invited__boolean": false,
    "only_invite_if_the_customer_has_this_tag": "",
    "only_invite_if_the_order_contains_a_product_with_this_tag": "",
    "custom_invitation_email_subject": "",
    "custom_invitation_email_message__multiline": "",
    "invitation_email_bcc__array": null
  },
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "preview_event_definitions": [],
  "script": "{% assign avoid_duplicate_invites = options.only_invite_if_the_customer_has_not_yet_been_invited__boolean %}\n{% assign invite_customer_tag = options.only_invite_if_the_customer_has_this_tag %}\n{% assign invite_product_tag = options.only_invite_if_the_order_contains_a_product_with_this_tag %}\n{% assign custom_invitation_email_subject = options.custom_invitation_email_subject %}\n{% assign custom_invitation_email_message = options.custom_invitation_email_message__multiline %}\n{% assign invitation_email_bcc = options.invitation_email_bcc__array %}\n\n{% comment %}\n  -- get customer and product details from order\n{% endcomment %}\n\n{% capture query %}\n  query {\n    order(id: {{ order.admin_graphql_api_id | json }}) {\n      id\n      name\n      customer {\n        id\n        displayName\n        email\n        state\n        tags\n      }\n      lineItems(first: 250) {\n        nodes {\n          title\n          product {\n            tags\n          }\n        }\n      }\n    }\n  }\n{% endcapture %}\n\n{% assign result = query | shopify %}\n\n{% if event.preview %}\n  {% capture result_json %}\n    {\n      \"data\": {\n        \"order\": {\n          \"id\": \"gid://shopify/Order/1234567890\",\n          \"name\": \"#1185\",\n          \"customer\": {\n            \"id\": \"gid://shopify/Customer/1234567890\",\n            \"state\": \"DISABLED\",\n            \"tags\": {{ invite_customer_tag | json }}\n          },\n          \"lineItems\": {\n            \"nodes\": [\n              {\n                \"product\": {\n                  \"tags\": {{ invite_product_tag | json }}\n                }\n              }\n            ]\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = result_json | parse_json %}\n{% endif %}\n\n{% assign order = result.data.order %}\n{% assign customer = order.customer %}\n\n{% comment %}\n  -- verify whether the customer qualifies for an invite based on configured options\n{% endcomment %}\n\n{% assign customer_qualifies = true %}\n\n{% if customer == blank or customer.state == \"ENABLED\" %}\n  {% assign customer_qualifies = false %}\n\n{% elsif avoid_duplicate_invites and customer.state == \"INVITED\" %}\n  {% assign customer_qualifies = false %}\n\n{% elsif invite_customer_tag != blank %}\n  {% assign customer_tags\n    = customer.tags\n    | json\n    | downcase\n    | parse_json\n  %}\n  {% assign tag_to_match = invite_customer_tag | strip | downcase %}\n\n  {% unless customer_tags contains tag_to_match %}\n    {% assign customer_qualifies = false %}\n  {% endunless %}\n{% endif %}\n\n{% assign order_qualifies = false %}\n\n{% if customer_qualifies %}\n  {% if invite_product_tag == blank %}\n    {% assign order_qualifies = true %}\n\n  {% else %}\n    {% for line_item in order.lineItems.nodes %}\n      {% assign product_tags\n        = line_item.product.tags\n        | json\n        | downcase\n        | parse_json\n      %}\n      {% assign tag_to_match = invite_product_tag | strip | downcase %}\n\n      {% if product_tags contains tag_to_match %}\n        {% assign order_qualifies = true %}\n        {% break %}\n      {% endif %}\n    {% endfor %}\n  {% endif %}\n{% endif %}\n\n{% if customer == blank %}\n  {% log message: \"Order does not have a customer; skipping invitation\" %}\n\n{% elsif customer_qualifies == false %}\n  {% log\n    message: \"Customer does not qualify for an invitation\",\n    customer_name: customer.displayName,\n    customer_state: customer.state,\n    customer_tags: customer.tags\n  %}\n\n{% elsif order_qualifies == false and invite_product_tag != blank %}\n  {% log\n    message: \"No qualifying product found\",\n    invite_product_tag: invite_product_tag,\n    order: order\n  %}\n{% endif %}\n\n{% if order_qualifies %}\n  {% action \"shopify\" %}\n    mutation {\n      customerSendAccountInviteEmail(\n        customerId: {{ customer.id | json }}\n        email: {\n          {% if custom_invitation_email_subject != blank %}\n            subject: {{ custom_invitation_email_subject | json }}\n          {% endif %}\n          {% if custom_invitation_email_message != blank %}\n            customMessage: {{ custom_invitation_email_message | json }}\n          {% endif %}\n          {% if invitation_email_bcc != blank %}\n            bcc: {{ invitation_email_bcc | json }}\n          {% endif %}\n        }\n      ) {\n        customer {\n          id\n          displayName\n          email\n          state\n        }\n        userErrors {\n          code\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% endif %}\n",
  "subscriptions": [
    "shopify/orders/create"
  ],
  "subscriptions_template": "shopify/orders/create",
  "tags": [
    "Email",
    "Invite",
    "Orders",
    "Retention"
  ]
}
