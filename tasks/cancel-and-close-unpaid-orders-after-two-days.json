{
  "name": "Cancel and close unpaid orders after x hours/days",
  "options": {
    "only_process_orders_having_this_tag": null,
    "ignore_orders_having_this_tag": null,
    "period_to_wait_before_checking_each_order__number_required": 1,
    "period_to_wait_is_in_hours__boolean": null,
    "period_to_wait_is_in_days__boolean": true,
    "tag_to_add_to_the_order": null,
    "void_payment_when_possible__boolean": null,
    "cancel_fulfillment_and_restock_to_default_location__boolean": null,
    "send_cancellation_email_to_customer__boolean": false,
    "test_mode__boolean": true
  },
  "subscriptions": [
    "mechanic/scheduler/daily",
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "{% if options.period_to_wait_is_in_hours__boolean %}\n  mechanic/scheduler/hourly\n{% elsif options.period_to_wait_is_in_days__boolean %}\n  mechanic/scheduler/daily\n{% endif %}\n\nmechanic/user/trigger",
  "script": "{% comment %}\n  Preferred option order\n\n  {{ options.only_process_orders_having_this_tag }}\n  {{ options.ignore_orders_having_this_tag }}\n  {{ options.period_to_wait_before_checking_each_order__number_required }}\n  {{ options.period_to_wait_is_in_hours__boolean }}\n  {{ options.period_to_wait_is_in_days__boolean }}\n  {{ options.tag_to_add_to_the_order }}\n  {{ options.void_payment_when_possible__boolean }}\n  {{ options.cancel_fulfillment_and_restock_to_default_location__boolean }}\n  {{ options.send_cancellation_email_to_customer__boolean }}\n  {{ options.test_mode__boolean }}\n{% endcomment %}\n\n{% if event.preview %}\n  {% capture orders_json %}\n    [\n      {\n        \"id\": 1234567890,\n        \"name\": \"#1234\",\n        \"admin_graphql_api_id\": \"gid://shopify/Order/1234567890\",\n        \"processed_at\": \"1990-01-01\",\n        \"tags\": {{ options.only_process_orders_having_this_tag | json }},\n        \"line_items\": [\n          {\n            \"id\": 1234567890,\n            \"fulfillable_quantity\": 5,\n            \"variant_inventory_management\": \"shopify\"\n          }\n        ]\n      }\n    ]\n  {% endcapture %}\n  {% assign orders = orders_json | parse_json %}\n{% else %}\n  {% assign orders = shop.orders.any.pending %}\n{% endif %}\n\n{% if options.test_mode__boolean %}\n  {% assign test_mode_summaries = array %}\n{% endif %}\n\n{% if options.period_to_wait_before_checking_each_order__number_required <= 0 %}\n  {% error \"Period must be positive! :)\" %}\n{% elsif options.period_to_wait_is_in_hours__boolean == false and options.period_to_wait_is_in_days__boolean == false %}\n  {% error \"Choose either 'Period to wait is in hours' or 'Period to wait is in days'.\" %}\n{% elsif options.period_to_wait_is_in_hours__boolean and options.period_to_wait_is_in_days__boolean %}\n  {% error \"Choose exactly one of 'Period to wait is in hours' or 'Period to wait is in days'. :)\" %}\n{% elsif options.period_to_wait_is_in_hours__boolean %}\n  {% assign period_unit = 60 | times: 60 %}\n{% elsif options.period_to_wait_is_in_days__boolean %}\n  {% assign period_unit = 60 | times: 60 | times: 24 %}\n{% endif %}\n\n{% assign period_s = period_unit | times: options.period_to_wait_before_checking_each_order__number_required %}\n{% assign maximum_date_s = \"now\" | date: \"%s\" | minus: period_s %}\n\n{% for order in orders %}\n  {% assign order_tags = order.tags | split: \", \" %}\n\n  {% if options.only_process_orders_having_this_tag != blank %}\n    {% unless order_tags contains options.only_process_orders_having_this_tag %}\n      {% continue %}\n    {% endunless %}\n  {% endif %}\n\n  {% if options.ignore_orders_having_this_tag != blank %}\n    {% if order_tags contains options.ignore_orders_having_this_tag %}\n      {% continue %}\n    {% endif %}\n  {% endif %}\n\n  {% assign processed_at_s = order.processed_at | default: order.created_at | date: \"%s\" | times: 1 %}\n\n  {% if processed_at_s > maximum_date_s %}\n    {% continue %}\n  {% endif %}\n\n  {% assign summary = hash %}\n  {% assign summary[\"order_name\"] = order.name %}\n  {% assign summary[\"order_id\"] = order.id %}\n  {% assign summary[\"order_processed_at\"] = processed_at_s | date: \"%FT%T%:z\" %}\n  {% assign summary[\"threshold_processed_at\"] = maximum_date_s | date: \"%FT%T%:z\" %}\n\n  {% if order.cancelled_at == blank %}\n    {% assign summary[\"qualifies_for_cancellation\"] = true %}\n  {% else %}\n    {% assign summary[\"qualifies_for_cancellation\"] = false %}\n  {% endif %}\n\n  {% if order.closed_at == blank %}\n    {% assign summary[\"qualifies_for_closing\"] = true %}\n  {% else %}\n    {% assign summary[\"qualifies_for_closing\"] = false %}\n  {% endif %}\n\n  {% assign summary[\"qualifies_for_tagging\"] = false %}\n  {% if options.tag_to_add_to_the_order != blank %}\n    {% assign order_tags = order.tags | downcase | split: \", \" %}\n    {% assign order_tag_to_match = options.tag_to_add_to_the_order | downcase | strip %}\n    {% unless order_tags contains order_tag_to_match %}\n      {% assign summary[\"qualifies_for_tagging\"] = true %}\n    {% endunless %}\n  {% endif %}\n\n  {% unless summary.qualifies_for_cancellation or summary.qualifies_for_closing or summary.qualifies_for_tagging %}\n    {% continue %}\n  {% endunless %}\n\n  {% if options.test_mode__boolean %}\n    {% assign test_mode_summaries[test_mode_summaries.size] = summary %}\n    {% continue %}\n  {% endif %}\n\n  {% log summary %}\n\n  {% if summary.qualifies_for_cancellation %}\n    {% action \"shopify\" %}\n      [\n        \"post\",\n        \"/admin/orders/{{ order.id }}/cancel.json\",\n        {\n          \"refund\": {\n            \"note\": {{ task.name | json }},\n            {% assign transaction = order.transactions.first %}\n            {% if options.void_payment_when_possible__boolean and transaction != nil %}\n              \"transactions\": [\n                {\n                  \"parent_id\": {{ transaction.id | json }},\n                  \"amount\": \"0.0\",\n                  \"kind\": \"void\",\n                  \"gateway\": {{ transaction.gateway | json }}\n                }\n              ],\n            {% endif %}\n            \"refund_line_items\": [\n              {% for line_item in order.line_items %}\n                {\n                  \"line_item_id\": {{ line_item.id | json }},\n\n                  {% if options.cancel_fulfillment_and_restock_to_default_location__boolean and line_item.variant_inventory_management == \"shopify\" %}\n                    \"restock_type\": \"cancel\",\n                    \"quantity\": {{ line_item.fulfillable_quantity | default: line_item.quantity | json }},\n                    \"location_id\": {{ shop.primary_location_id | json }}\n                  {% else %}\n                    \"restock_type\": \"no_restock\",\n                    \"quantity\": 0\n                  {% endif %}\n                }\n                {% unless forloop.last %}\n                  ,\n                {% endunless %}\n              {% endfor %}\n            ]\n          },\n          \"email\": {{ options.send_cancellation_email_to_customer__boolean | json }}\n        }\n      ]\n    {% endaction %}\n  {% endif %}\n\n  {% if summary.qualifies_for_closing or summary.qualifies_for_tagging %}\n    {% action \"shopify\" %}\n      mutation {\n        {% if summary.qualifies_for_closing %}\n          orderClose(\n            input: {\n              id: {{ order.admin_graphql_api_id | json }}\n            }\n          ) {\n            order {\n              closed\n              closedAt\n            }\n            userErrors {\n              field\n              message\n            }\n          }\n        {% endif %}\n\n        {% if summary.qualifies_for_tagging %}\n          tagsAdd(\n            id: {{ order.admin_graphql_api_id | json }}\n            tags: {{ options.tag_to_add_to_the_order | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        {% endif %}\n      }\n    {% endaction %}\n  {% endif %}\n{% endfor %}\n\n{% if options.test_mode__boolean %}\n  {% action \"echo\" orders_count: test_mode_summaries.size, order_summaries: test_mode_summaries %}\n{% endif %}",
  "docs": "Clear the clutter in your orders list, automatically! On a scheduled basis or on-demand, this task scans for orders that are more than x days or hours old, and cancels and closes/archives the order if its financial status is still marked \"pending\".\n\nThis task scans for orders that are more than X days or hours old that have a financial status of \"pending\", and ensures that they are all closed/archived and cancelled. Orders that are already closed will be cancelled, and orders that are already cancelled will be closed. Optionally, choose to add a tag to such orders, and Mechanic will ensure that all qualifying orders receive your chosen tag.\r\n\r\nRun first using test mode, to ensure expected results before running without it.\r\n\r\nIf configured with an interval in hours, this task will run hourly. If configured with an interval in days, the task will run every night at midnight, in your store's local timezone. Run this task manually to perform the scan on demand.\r\n\r\nTip: To easily see which orders this task has cancelled, fill in the \"Tag to add to the order\" option.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false
}
