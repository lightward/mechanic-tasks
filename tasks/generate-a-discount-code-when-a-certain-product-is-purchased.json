{
  "name": "Generate a discount code when a certain product is purchased",
  "options": {
    "required_product_id__number_required": null,
    "discount_collection_id__number": null,
    "discount_code_prefix": null,
    "discount_fixed_amount__number": null,
    "discount_percentage__number": "50",
    "discount_applies_to_each_line_item_individually__boolean": true,
    "discount_lifetime_in_days__number": "365",
    "email_subject__required": "Thanks for your purchase! Your discount code is DISCOUNT_CODE.",
    "email_body__multiline_required": "Thanks for your purchase! Here's your discount code: <b>DISCOUNT_CODE</b>\n\n<a href=\"https://{{ shop.domain }}/\">Start shopping now!</a>\n\nThanks,\n{{ shop.name }}",
    "discount_can_be_used_by_anyone__boolean": null
  },
  "subscriptions": [
    "shopify/orders/paid"
  ],
  "subscriptions_template": "shopify/orders/paid",
  "script": "{% comment %}\n  Options order:\n\n  {{ options.required_product_id__number_required }}\n  {{ options.discount_collection_id__number }}\n  {{ options.discount_code_prefix }}\n  {{ options.discount_fixed_amount__number }}\n  {{ options.discount_percentage__number }}\n  {{ options.discount_applies_to_each_line_item_individually__boolean }}\n  {{ options.discount_lifetime_in_days__number }}\n  {{ options.discount_can_be_used_by_anyone__boolean }}\n  {{ options.email_subject__required }}\n  {{ options.email_body__multiline_required }}\n{% endcomment %}\n\n{% if options.discount_percentage__number == blank and options.discount_fixed_amount__number == blank %}\n  {% error \"Please fill either the discount percentage or discount fixed amount.\" %}\n{% elsif options.discount_percentage__number != blank and options.discount_fixed_amount__number != blank %}\n  {% error \"Please choose between the discount percentage and discount fixed amount - only one is permitted.\" %}\n{% endif %}\n\n{% if event.preview %}\n  {% capture order_json %}\n    {\n      \"email\": \"customer@example.com\",\n      \"customer\": {\n        \"admin_graphql_api_id\": \"gid://shopify/Customer/1234567890\"\n      },\n      \"line_items\": [\n        {\n          \"id\": 1234567890,\n          \"product_id\": {{ options.required_product_id__number_required | json }},\n          \"quantity\": 1\n        }\n      ]\n    }\n  {% endcapture %}\n\n  {% assign order = order_json | parse_json %}\n{% endif %}\n\n{% for line_item in order.line_items %}\n  {% if line_item.product_id != options.required_product_id__number_required %}\n    {% continue %}\n  {% endif %}\n\n  {% if order.customer == nil %}\n    {% log \"This order has no related customer. Skipping\" %}\n    {% continue %}\n  {% endif %}\n\n  {% if order.email == blank %}\n    {% log \"This order has no email address. Skipping\" %}\n    {% continue %}\n  {% endif %}\n\n  {% for n in (1..line_item.quantity) %}\n    {% assign discount_code = line_item.id | append: n | split: \"\" | reverse | join: \"\" | slice: 0, 4 | append: order.order_number | base64 | replace: \"=\", \"\" | upcase | prepend: options.discount_code_prefix %}\n\n    {% assign email_subject = options.email_subject__required | replace: 'DISCOUNT_CODE', discount_code %}\n    {% assign email_body = options.email_body__multiline_required | replace: 'DISCOUNT_CODE', discount_code %}\n\n    {% action \"email\" %}\n      {\n        \"to\": {{ order.email | json }},\n        \"subject\": {{ email_subject | strip | json }},\n        \"body\": {{ email_body | strip | newline_to_br | json }},\n        \"reply_to\": {{ shop.customer_email | json }},\n        \"from_display_name\": {{ shop.name | json }}\n      }\n    {% endaction %}\n\n    {% action \"shopify\" %}\n      mutation {\n        priceRuleCreate(\n          priceRule: {\n            allocationMethod: {% if options.discount_applies_to_each_line_item_individually__boolean %}EACH{% else %}ACROSS{% endif %}\n            customerSelection: {\n              {% if options.discount_can_be_used_by_anyone__boolean %}\n                forAllCustomers: true\n              {% else %}\n                customerIdsToAdd: [\n                  {{ order.customer.admin_graphql_api_id | json }}\n                ]\n              {% endif %}\n            }\n            itemEntitlements: {\n              {% if options.discount_collection_id__number != blank %}\n                collectionIds: [\n                  {{ shop.collections[options.discount_collection_id__number].admin_graphql_api_id | json }}\n                ]\n              {% else %}\n                targetAllLineItems: true\n              {% endif %}\n            }\n            target: LINE_ITEM\n            title: {{ discount_code | json }}\n            validityPeriod: {\n              start: {{ \"now\" | date: \"%FT%T%:z\" | json }}\n\n              {% if options.discount_lifetime_in_days__number != blank %}\n                {% assign validity_days_s = 60 | times: 60 | times: 24 | times: options.discount_lifetime_in_days__number %}\n                end: {{ \"now\" | date: \"%s\" | plus: validity_days_s | date: \"%FT%T%:z\" | json }}\n              {% endif %}\n            }\n            value: {\n              {% if options.discount_percentage__number != blank %}\n                percentageValue: {{ options.discount_percentage__number | abs | times: -1 | json }}\n              {% endif %}\n\n              {% if options.discount_fixed_amount__number != blank %}\n                fixedAmountValue: {{ options.discount_fixed_amount__number | abs | times: -1 | append: \"\" | json }}\n              {% endif %}\n            }\n          }\n          priceRuleDiscountCode: {\n            code: {{ discount_code | json }}\n          }\n        ) {\n          priceRule {\n            id\n            allocationMethod\n            endsAt\n            target\n            summary\n          }\n          priceRuleUserErrors {\n            code\n            field\n            message\n          }\n          priceRuleDiscountCode {\n            code\n            id\n          }\n        }\n      }\n    {% endaction %}\n  {% endfor %}\n{% endfor %}",
  "docs": "This task watches for newly-paid orders, and if the configured product is purchased, sends the customer a discount code that's just for them. Optionally, configure the discounts to only apply to a certain collection of products, and to only last for a certain number of days.\n\nThis task watches for newly-paid orders, and if the configured product is purchased, sends the customer a discount code that's just for them. If a customer purchases more than one qualified product, they will receive more than one email, each containing a unique discount code.\r\n\r\n### Options\r\n\r\n* **Required product ID:** The ID of the product that the customer must purchase, in order to qualify for the discount. ([Learn how to find the product ID.](https://help.usemechanic.com/articles/2946120-how-do-i-find-an-id-for-a-product-collection-order-or-something-else))\r\n* **Discount collection ID (optional):** The ID of a specific collection of products that the discount code should be good for. ([Learn how to find the collection ID.](https://help.usemechanic.com/articles/2946120-how-do-i-find-an-id-for-a-product-collection-order-or-something-else))\r\n* **Discount code prefix (optional):** A small piece of text to add to the beginning of the generated discount code.\r\n* **Discount fixed amount:** The money value to be subtracted. If you choose this option, you cannot choose a discount percentage.\r\n* **Discount percentage:** The percentage to be subtracted. If you choose this option, you cannot choose a fixed discount amount.\r\n* **Discount applies to each line item individually:** If enabled, the discount will apply to each item ordered. If disabled, the discount will only apply once per order.\r\n* **Discount lifetime in days:** How long the discount should be active.\r\n* **Discount can be used by anyone:** If enabled, the discount code can be used by anyone. If disabled, the discount code can only be used by the purchasing customer.\r\n* **Email subject, body:** The content to email to the customer. Use \"DISCOUNT_CODE\" as a placeholder for the generated discount code.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Discounts",
    "Marketing",
    "Products",
    "Retention"
  ]
}
