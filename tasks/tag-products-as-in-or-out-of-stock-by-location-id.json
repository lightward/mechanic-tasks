{
  "name": "Tag products as in- or out-of-stock, by location ID",
  "options": {
    "tag_prefix_when_in_stock": "location-",
    "tag_suffix_when_in_stock": "-instock",
    "tag_prefix_when_out_of_stock": "location-",
    "tag_suffix_when_out_of_stock": "-outofstock",
    "run_daily__boolean": false,
    "run_hourly__boolean": false
  },
  "subscriptions": [
    "mechanic/user/trigger",
    "mechanic/shopify/bulk_operation"
  ],
  "subscriptions_template": "mechanic/user/trigger\nmechanic/shopify/bulk_operation\n\n{% if options.run_daily__boolean %}\n  mechanic/scheduler/daily\n{% elsif options.run_hourly__boolean %}\n  mechanic/scheduler/hourly\n{% endif %}",
  "script": "{% if options.tag_prefix_when_in_stock == blank and options.tag_suffix_when_in_stock == blank %}\n  {% error \"Add either a prefix or suffix for the 'in stock' tag, to distinguish it from the 'out of stock' tag.\" %}\n{% endif %}\n\n{% if options.tag_prefix_when_out_of_stock == blank and options.tag_suffix_when_out_of_stock == blank %}\n  {% error \"Add either a prefix or suffix for the 'out of stock' tag, to distinguish it from the 'in stock' tag.\" %}\n{% endif %}\n\n{% if event.topic == \"mechanic/user/trigger\" or event.topic contains \"mechanic/scheduler/\" %}\n  {% capture bulk_operation_query %}\n    query {\n      products {\n        edges {\n          node {\n            __typename\n            id\n            tags\n            variants {\n              edges {\n                node {\n                  __typename\n                  id\n                  inventoryItem {\n                    inventoryLevels {\n                      edges {\n                        node {\n                          __typename\n                          id\n                          location {\n                            id\n                          }\n                          available\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% action \"shopify\" %}\n    mutation {\n      bulkOperationRunQuery(\n        query: {{ bulk_operation_query | json }}\n      ) {\n        bulkOperation {\n          id\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% elsif event.topic == \"mechanic/shopify/bulk_operation\" %}\n  {% if event.preview %}\n    {% capture bulkOperation_objects_jsonl %}\n      {\"__typename\":\"Product\",\"id\":\"gid:\\/\\/shopify\\/Product\\/1234567890\",\"tags\":[\"In Stock_35822141538Yes\",\"Brand_Animal\",\"Colour_Black\",\"Colour_Green\",\"Colour_Purple\",\"In Stock_Yes\",\"not-sale\"]}\n      {\"__typename\":\"ProductVariant\",\"id\":\"gid:\\/\\/shopify\\/ProductVariant\\/123567890\",\"inventoryItem\":{},\"__parentId\":\"gid:\\/\\/shopify\\/Product\\/1234567890\"}\n      {\"__typename\":\"InventoryLevel\",\"id\":\"gid:\\/\\/shopify\\/InventoryLevel\\/1234567890?inventory_item_id=1234567890\",\"location\":{\"id\":\"gid:\\/\\/shopify\\/Location\\/1234567890\"},\"available\":0,\"__parentId\":\"gid:\\/\\/shopify\\/ProductVariant\\/123567890\"}\n      {\"__typename\":\"ProductVariant\",\"id\":\"gid:\\/\\/shopify\\/ProductVariant\\/2345678901\",\"inventoryItem\":{},\"__parentId\":\"gid:\\/\\/shopify\\/Product\\/1234567890\"}\n      {\"__typename\":\"InventoryLevel\",\"id\":\"gid:\\/\\/shopify\\/InventoryLevel\\/1234567890?inventory_item_id=2345678901\",\"location\":{\"id\":\"gid:\\/\\/shopify\\/Location\\/1234567890\"},\"available\":0,\"__parentId\":\"gid:\\/\\/shopify\\/ProductVariant\\/2345678901\"}\n      {\"__typename\":\"ProductVariant\",\"id\":\"gid:\\/\\/shopify\\/ProductVariant\\/3456789012\",\"inventoryItem\":{},\"__parentId\":\"gid:\\/\\/shopify\\/Product\\/1234567890\"}\n      {\"__typename\":\"InventoryLevel\",\"id\":\"gid:\\/\\/shopify\\/InventoryLevel\\/1234567890?inventory_item_id=3456789012\",\"location\":{\"id\":\"gid:\\/\\/shopify\\/Location\\/1234567890\"},\"available\":1,\"__parentId\":\"gid:\\/\\/shopify\\/ProductVariant\\/3456789012\"}\n      {\"__typename\":\"ProductVariant\",\"id\":\"gid:\\/\\/shopify\\/ProductVariant\\/4567890123\",\"inventoryItem\":{},\"__parentId\":\"gid:\\/\\/shopify\\/Product\\/1234567890\"}\n      {\"__typename\":\"InventoryLevel\",\"id\":\"gid:\\/\\/shopify\\/InventoryLevel\\/1234567890?inventory_item_id=4567890123\",\"location\":{\"id\":\"gid:\\/\\/shopify\\/Location\\/1234567890\"},\"available\":0,\"__parentId\":\"gid:\\/\\/shopify\\/ProductVariant\\/4567890123\"}\n      {\"__typename\":\"InventoryLevel\",\"id\":\"gid:\\/\\/shopify\\/InventoryLevel\\/2345678901?inventory_item_id=4567890123\",\"location\":{\"id\":\"gid:\\/\\/shopify\\/Location\\/2345678901\"},\"available\":0,\"__parentId\":\"gid:\\/\\/shopify\\/ProductVariant\\/31963081474146\"}\n      {\"__typename\":\"ProductVariant\",\"id\":\"gid:\\/\\/shopify\\/ProductVariant\\/5678901234\",\"inventoryItem\":{},\"__parentId\":\"gid:\\/\\/shopify\\/Product\\/1234567890\"}\n      {\"__typename\":\"InventoryLevel\",\"id\":\"gid:\\/\\/shopify\\/InventoryLevel\\/1234567890?inventory_item_id=5678901234\",\"location\":{\"id\":\"gid:\\/\\/shopify\\/Location\\/1234567890\"},\"available\":0,\"__parentId\":\"gid:\\/\\/shopify\\/ProductVariant\\/5678901234\"}\n      {\"__typename\":\"InventoryLevel\",\"id\":\"gid:\\/\\/shopify\\/InventoryLevel\\/2345678901?inventory_item_id=5678901234\",\"location\":{\"id\":\"gid:\\/\\/shopify\\/Location\\/2345678901\"},\"available\":0,\"__parentId\":\"gid:\\/\\/shopify\\/ProductVariant\\/5678901234\"}\n    {% endcapture %}\n\n    {% assign bulkOperation = hash %}\n    {% assign bulkOperation[\"objects\"] = bulkOperation_objects_jsonl | parse_jsonl %}\n  {% endif %}\n\n  {% assign in_stock_by_product_id_and_location_id = hash %}\n\n  {% assign inventory_levels = bulkOperation.objects | where: \"__typename\", \"InventoryLevel\" %}\n  {% assign products = bulkOperation.objects | where: \"__typename\", \"Product\" %}\n  {% assign variants = bulkOperation.objects | where: \"__typename\", \"ProductVariant\" %}\n\n  {% for inventory_level in inventory_levels %}\n    {% assign variant = variants | where: \"id\", inventory_level.__parentId | first %}\n    {% assign product = products | where: \"id\", variant.__parentId | first %}\n    {% assign location = inventory_level.location %}\n\n    {% if in_stock_by_product_id_and_location_id[product.id] == nil %}\n      {% assign in_stock_by_product_id_and_location_id[product.id] = hash %}\n    {% endif %}\n\n    {% if inventory_level.available > 0 %}\n      {% assign in_stock_by_product_id_and_location_id[product.id][location.id] = true %}\n    {% elsif in_stock_by_product_id_and_location_id[product.id][location.id] == nil %}\n      {% assign in_stock_by_product_id_and_location_id[product.id][location.id] = false %}\n    {% endif %}\n  {% endfor %}\n\n  {% for product in products %}\n    {% assign tags_to_add = array %}\n    {% assign tags_to_remove = array %}\n\n    {% for keyval in in_stock_by_product_id_and_location_id[product.id] %}\n      {% assign location_id = keyval[0] %}\n      {% assign in_stock = keyval[1] %}\n\n      {% assign location_id_integer = location_id | split: \"/\" | last %}\n\n      {% assign in_stock_tag = options.tag_prefix_when_in_stock | append: location_id_integer | append: options.tag_suffix_when_in_stock %}\n      {% assign out_of_stock_tag = options.tag_prefix_when_out_of_stock | append: location_id_integer | append: options.tag_suffix_when_out_of_stock %}\n\n      {% if in_stock %}\n        {% assign tag_to_add = in_stock_tag %}\n        {% assign tag_to_remove = out_of_stock_tag %}\n      {% else %}\n        {% assign tag_to_remove = in_stock_tag %}\n        {% assign tag_to_add = out_of_stock_tag %}\n      {% endif %}\n\n      {% if product.tags contains tag_to_add %}\n        {% assign tag_to_add = nil %}\n      {% endif %}\n\n      {% unless product.tags contains tag_to_remove %}\n        {% assign tag_to_remove = nil %}\n      {% endunless %}\n\n      {% if tag_to_add %}\n        {% assign tags_to_add[tags_to_add.size] = tag_to_add %}\n      {% endif %}\n\n      {% if tag_to_remove %}\n        {% assign tags_to_remove[tags_to_remove.size] = tag_to_remove %}\n      {% endif %}\n    {% endfor %}\n\n    {% if tags_to_add != empty or tags_to_remove != empty %}\n      {% action \"shopify\" %}\n        mutation {\n          {% if tags_to_add != empty %}\n            tagsAdd(\n              id: {{ product.id | json }}\n              tags: {{ tags_to_add | json }}\n            ) {\n              userErrors {\n                field\n                message\n              }\n            }\n          {% endif %}\n          {% if tags_to_remove != empty %}\n            tagsRemove(\n              id: {{ product.id | json }}\n              tags: {{ tags_to_remove | json }}\n            ) {\n              userErrors {\n                field\n                message\n              }\n            }\n          {% endif %}\n        }\n      {% endaction %}\n    {% endif %}\n  {% endfor %}\n{% endif %}",
  "docs": "Use this task to easily keep an eye on which products are in stock, or out of stock, as established by individual locations. Configure tag prefixes and suffixes to arrive at product tags resembling \"location-123456890-instock\" or \"oos-123456890\". Configure this task to run hourly or daily, to keep these tags in sync.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Auto-Tag",
    "In stock",
    "Location",
    "Multi-Location",
    "Out of Stock"
  ]
}
