{
  "docs": "Use this task to easily keep an eye on which products are in stock, or out of stock, as established by individual locations. Configure tag prefixes and suffixes to arrive at product tags resembling \"location-123456890-instock\" or \"oos-123456890\". Configure this task to run hourly or daily, to keep these tags in sync.",
  "halt_action_run_sequence_on_error": false,
  "name": "Tag products as in- or out-of-stock, by location ID",
  "online_store_javascript": null,
  "options": {
    "tag_prefix_when_in_stock": "location-",
    "tag_suffix_when_in_stock": "-instock",
    "tag_prefix_when_out_of_stock": "location-",
    "tag_suffix_when_out_of_stock": "-outofstock",
    "run_daily__boolean": false,
    "run_hourly__boolean": false
  },
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "script": "{% assign tag_prefix_when_in_stock = options.tag_prefix_when_in_stock %}\n{% assign tag_suffix_when_in_stock = options.tag_suffix_when_in_stock %}\n{% assign tag_prefix_when_out_of_stock = options.tag_prefix_when_out_of_stock %}\n{% assign tag_suffix_when_out_of_stock = options.tag_suffix_when_out_of_stock %}\n\n{% if tag_prefix_when_in_stock == blank and tag_suffix_when_in_stock == blank %}\n  {% error \"Add either a prefix or suffix for the 'in stock' tag, to distinguish it from the 'out of stock' tag.\" %}\n{% endif %}\n\n{% if tag_prefix_when_out_of_stock == blank and tag_suffix_when_out_of_stock == blank %}\n  {% error \"Add either a prefix or suffix for the 'out of stock' tag, to distinguish it from the 'in stock' tag.\" %}\n{% endif %}\n\n{% if event.topic == \"mechanic/user/trigger\" or event.topic contains \"mechanic/scheduler/\" %}\n  {% capture bulk_operation_query %}\n    query {\n      products {\n        edges {\n          node {\n            __typename\n            id\n            tags\n            variants {\n              edges {\n                node {\n                  __typename\n                  id\n                  inventoryItem {\n                    inventoryLevels {\n                      edges {\n                        node {\n                          __typename\n                          id\n                          location {\n                            legacyResourceId\n                          }\n                          quantities(names: \"available\") {\n                            name\n                            quantity\n                          }\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% action \"shopify\" %}\n    mutation {\n      bulkOperationRunQuery(\n        query: {{ bulk_operation_query | json }}\n      ) {\n        bulkOperation {\n          id\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n\n{% elsif event.topic == \"mechanic/shopify/bulk_operation\" %}\n  {% if event.preview %}\n    {% capture bulkOperation_objects_jsonl %}\n      {\"__typename\":\"Product\",\"id\":\"gid:\\/\\/shopify\\/Product\\/1234567890\"}\n      {\"__typename\":\"ProductVariant\",\"id\":\"gid:\\/\\/shopify\\/ProductVariant\\/1234567890\",\"__parentId\":\"gid:\\/\\/shopify\\/Product\\/1234567890\"}\n      {\"__typename\":\"InventoryLevel\",\"location\":{\"legacyResourceId\":\"1234567890\"},\"quantities\":[{\"name\":\"available\",\"quantity\":1}],\"__parentId\":\"gid:\\/\\/shopify\\/ProductVariant\\/1234567890\"}\n    {% endcapture %}\n\n    {% assign bulkOperation = hash %}\n    {% assign bulkOperation[\"objects\"] = bulkOperation_objects_jsonl | parse_jsonl %}\n  {% endif %}\n\n  {% assign bulk_products = bulkOperation.objects | where: \"__typename\", \"Product\" %}\n  {% assign bulk_variants = bulkOperation.objects | where: \"__typename\", \"ProductVariant\" %}\n  {% assign bulk_inventory_levels = bulkOperation.objects | where: \"__typename\", \"InventoryLevel\" %}\n\n  {% for product in bulk_products %}\n    {% assign tags_to_add = array %}\n    {% assign tags_to_remove = array %}\n\n    {% assign variants = bulk_variants | where: \"__parentId\", product.id %}\n\n    {% for variant in variants %}\n      {% assign inventory_levels = bulk_inventory_levels | where: \"__parentId\", variant.id %}\n\n      {% for inventory_level in inventory_levels %}\n        {% assign location_id = inventory_level.location.legacyResourceId %}\n        {% assign in_stock_tag = tag_prefix_when_in_stock | append: location_id | append: tag_suffix_when_in_stock %}\n        {% assign out_of_stock_tag = tag_prefix_when_out_of_stock | append: location_id | append: tag_suffix_when_out_of_stock %}\n\n        {% if inventory_level.quantities.first.quantity > 0 %}\n          {% unless product.tags contains in_stock_tag %}\n            {% assign tags_to_add = tags_to_add | push: in_stock_tag %}\n          {% endunless %}\n\n          {% if product.tags contains out_of_stock_tag %}\n            {% assign tags_to_remove = tags_to_remove | push: out_of_stock_tag %}\n          {% endif %}\n\n        {% else %}\n          {% unless product.tags contains out_of_stock_tag %}\n            {% assign tags_to_add = tags_to_add | push: out_of_stock_tag %}\n          {% endunless %}\n\n          {% if product.tags contains in_stock_tag %}\n            {% assign tags_to_remove = tags_to_remove | push: in_stock_tag %}\n          {% endif %}\n        {% endif %}\n      {% endfor %}\n    {% endfor %}\n\n    {% if tags_to_add != blank or tags_to_remove != blank %}\n      {% action \"shopify\" %}\n        mutation {\n          {% if tags_to_add != blank %}\n            tagsAdd(\n              id: {{ product.id | json }}\n              tags: {{ tags_to_add | json }}\n            ) {\n              userErrors {\n                field\n                message\n              }\n            }\n          {% endif %}\n          {% if tags_to_remove != blank %}\n            tagsRemove(\n              id: {{ product.id | json }}\n              tags: {{ tags_to_remove | json }}\n            ) {\n              userErrors {\n                field\n                message\n              }\n            }\n          {% endif %}\n        }\n      {% endaction %}\n    {% endif %}\n  {% endfor %}\n{% endif %}\n",
  "subscriptions": [
    "mechanic/user/trigger",
    "mechanic/shopify/bulk_operation"
  ],
  "subscriptions_template": "mechanic/user/trigger\nmechanic/shopify/bulk_operation\n\n{% if options.run_daily__boolean %}\n  mechanic/scheduler/daily\n{% elsif options.run_hourly__boolean %}\n  mechanic/scheduler/hourly\n{% endif %}",
  "tags": [
    "Auto-Tag",
    "In stock",
    "Location",
    "Multi-Location",
    "Out of Stock"
  ]
}
