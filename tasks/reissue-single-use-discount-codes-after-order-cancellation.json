{
  "name": "Reissue single-use discount codes after order cancellation",
  "options": {
    "ignore_discount_codes_containing_this_text": null,
    "email_subject__required": "We've issued you a new discount code",
    "email_body__required_multiline": "Hello,\n\nNow that order {{ order.name }} has been cancelled, we wanted to make sure you have another chance to use your discount.\n\nYour new discount code: REISSUED_DISCOUNT_CODE\n\nThanks,\n{{ shop.name }}",
    "email_bcc__email": null
  },
  "subscriptions": [
    "shopify/orders/cancelled"
  ],
  "subscriptions_template": "shopify/orders/cancelled",
  "script": "{% if event.preview %}\n  {% assign order = hash %}\n  {% assign order[\"email\"] = \"customer@example.com\" %}\n  {% assign order[\"order_number\"] = \"5678\" %}\n  {% assign order[\"discount_codes\"] = array %}\n  {% assign order[\"discount_codes\"][0] = hash %}\n  {% assign order[\"discount_codes\"][0][\"code\"] = \"ABCD1234\" %}\n  {% assign order[\"customer\"] = hash %}\n  {% assign order[\"customer\"][\"admin_graphql_api_id\"] = \"gid://shopify/Customer/1234567890\" %}\n{% endif %}\n\n{% assign discount_code = order.discount_codes.first.code %}\n\n{% assign discount_code_qualifies = true %}\n\n{% if discount_code == blank %}\n  {% assign discount_code_qualifies = false %}\n{% elsif options.ignore_discount_codes_containing_this_text != blank %}\n  {% assign discount_code_downcase = discount_code | downcase %}\n  {% assign ignore_downcase = options.ignore_discount_codes_containing_this_text | strip | downcase %}\n  {% if discount_code_downcase contains ignore_downcase %}\n    {% assign discount_code_qualifies = false %}\n  {% endif %}\n{% endif %}\n\n{% if event.preview or discount_code_qualifies %}\n  {% assign reissued_discount_code = discount_code | append: order.order_number %}\n\n  {% capture query %}\n    query {\n      codeDiscountNodeByCode(code: {{ discount_code | json }}) {\n        id\n        codeDiscount {\n          __typename\n          ... on DiscountCodeBasic {\n            title\n            usageLimit\n            codeCount\n            startsAt\n            endsAt\n            appliesOncePerCustomer\n            summary\n            minimumRequirement {\n              __typename\n              ... on DiscountMinimumQuantity {\n                greaterThanOrEqualToQuantity\n              }\n              ... on DiscountMinimumSubtotal {\n                greaterThanOrEqualToSubtotal {\n                  amount\n                  currencyCode\n                }\n              }\n            }\n            customerGets {\n              items {\n                __typename\n                ... on AllDiscountItems {\n                  allItems\n                }\n                ... on DiscountProducts {\n                  productVariants(first: 250) {\n                    edges {\n                      node {\n                        id\n                      }\n                    }\n                  }\n                  products(first: 250) {\n                    edges {\n                      node {\n                        id\n                      }\n                    }\n                  }\n                }\n                ... on DiscountCollections {\n                  collections(first: 250) {\n                    edges {\n                      node {\n                        id\n                      }\n                    }\n                  }\n                }\n              }\n              value {\n                __typename\n                ... on DiscountAmount {\n                  amount {\n                    amount\n                    currencyCode\n                  }\n                  appliesOnEachItem\n                }\n                ... on DiscountOnQuantity {\n                  effect {\n                    ... on DiscountPercentage {\n                      percentage\n                    }\n                  }\n                  quantity {\n                    quantity\n                  }\n                }\n                ... on DiscountPercentage {\n                  percentage\n                }\n              }\n            }\n            customerSelection {\n              __typename\n              ... on DiscountCustomers {\n                customers {\n                  id\n                }\n              }\n              ... on DiscountCustomerAll {\n                allCustomers\n              }\n              ... on DiscountCustomerSavedSearches {\n                savedSearches {\n                  id\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n      {\n        \"data\": {\n          \"codeDiscountNodeByCode\": {\n            \"id\": \"gid://shopify/DiscountCodeNode/1234567890\",\n            \"codeDiscount\": {\n              \"__typename\": \"DiscountCodeBasic\",\n              \"title\": \"DISCOUNT\",\n              \"usageLimit\": 1,\n              \"codeCount\": 1,\n              \"startsAt\": \"2019-11-04T20:06:44Z\",\n              \"endsAt\": \"2019-11-13T04:59:59Z\",\n              \"appliesOncePerCustomer\": true,\n              \"summary\": \"50% off No shipping • Minimum purchase of $5.00 • For Isaac Bowen • One use per customer\",\n              \"minimumRequirement\": {\n                \"__typename\": \"DiscountMinimumSubtotal\",\n                \"greaterThanOrEqualToSubtotal\": {\n                  \"amount\": \"5.0\",\n                  \"currencyCode\": \"USD\"\n                }\n              },\n              \"customerGets\": {\n                \"items\": {\n                  \"__typename\": \"DiscountProducts\",\n                  \"productVariants\": {\n                    \"edges\": []\n                  },\n                  \"products\": {\n                    \"edges\": [\n                      {\n                        \"node\": {\n                          \"id\": \"gid://shopify/Product/1234567890\"\n                        }\n                      }\n                    ]\n                  }\n                },\n                \"value\": {\n                  \"__typename\": \"DiscountPercentage\",\n                  \"percentage\": 0.5\n                }\n              },\n              \"customerSelection\": {\n                \"__typename\": \"DiscountCustomers\",\n                \"customers\": [\n                  {\n                    \"id\": \"gid://shopify/Customer/1234567890\"\n                  }\n                ]\n              }\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n\n  {% assign discountNode = result.data.codeDiscountNodeByCode.codeDiscount %}\n\n  {% log discount_summary: discountNode.summary %}\n\n  {% assign hasAppropriateCustomerLimit = false %}\n  {% if discountNode.appliesOncePerCustomer or discountNode.usageLimit == 1 %}\n    {% assign hasAppropriateCustomerLimit = true %}\n  {% endif %}\n\n  {% if discountNode == nil %}\n    {% log \"No discount found.\" %}\n  {% elsif discountNode.__typename != \"DiscountCodeBasic\" %}\n    {% log \"This task only supports basic discounts. It does not support free shipping, or buy-one-get-one.\" %}\n  {% elsif hasAppropriateCustomerLimit == false %}\n    {% log \"This discount can be used multiple times by the same customer, and so is not applicable.\" %}\n  {% else %}\n    {% action \"shopify\" %}\n      mutation {\n        discountCodeBasicCreate(\n          basicCodeDiscount: {\n            title: {{ reissued_discount_code | json }}\n            code: {{ reissued_discount_code | json }}\n            startsAt: {{ discountNode.startsAt | json }}\n            endsAt: {{ discountNode.endsAt | json }}\n            usageLimit: {{ discountNode.usageLimit | json }}\n            appliesOncePerCustomer: {{ discountNode.appliesOncePerCustomer | json }}\n            {% if discountNode.minimumRequirement.__typename == \"DiscountMinimumQuantity\" %}\n              minimumRequirement: {\n                quantity: {\n                  greaterThanOrEqualToQuantity: {{ discountNode.minimumRequirement.greaterThanOrEqualToQuantity | json }}\n                }\n              }\n            {% elsif discountNode.minimumRequirement.__typename == \"DiscountMinimumSubtotal\" %}\n              minimumRequirement: {\n                subtotal: {\n                  greaterThanOrEqualToSubtotal: {{ discountNode.minimumRequirement.greaterThanOrEqualToSubtotal.amount | json }}\n                }\n              }\n            {% endif %}\n            customerGets: {\n              items: {\n                {% if discountNode.customerGets.items.__typename == \"AllDiscountItems\" %}\n                  all: {{ discountNode.customerGets.items.allItems | json }}\n                {% elsif discountNode.customerGets.items.__typename == \"DiscountProducts\" %}\n                  products: {\n                    productsToAdd: {{ discountNode.customerGets.items.products.edges | map: \"node\" | map: \"id\" | json }}\n                    productVariantsToAdd: {{ discountNode.customerGets.items.productVariants.edges | map: \"node\" | map: \"id\" | json }}\n                  }\n                {% elsif discountNode.customerGets.items.__typename == \"DiscountCollections\" %}\n                  collections: {\n                    add: {{ discountNode.customerGets.items.collections.edges | map: \"node\" | map: \"id\" | json }}\n                  }\n                {% endif %}\n              }\n              value: {\n                {% if discountNode.customerGets.value.__typename == \"DiscountAmount\" %}\n                  discountAmount: {\n                    amount: {{ discountNode.customerGets.value.amount.amount | json }}\n                    appliesOnEachItem: {{ discountNode.customerGets.value.appliesOnEachItem | json }}\n                  }\n                {% elsif discountNode.customerGets.value.__typename == \"DiscountOnQuantity\" %}\n                  discountOnQuantity: {\n                    quantity: {{ discountNode.customerGets.value.quantity.quantity | json }}\n                    effect: {\n                      percentage: {{ discountNode.customerGets.value.effect.percentage | json }}\n                    }\n                  }\n                {% elsif discountNode.customerGets.value.__typename == \"DiscountPercentage\" %}\n                  percentage: {{ discountNode.customerGets.value.percentage | json }}\n                {% endif %}\n              }\n            }\n            customerSelection: {\n              customers: {\n                add: {{ order.customer.admin_graphql_api_id | json }}\n              }\n            }\n          }\n        ) {\n          codeDiscountNode {\n            id\n            codeDiscount {\n              ... on DiscountCodeBasic {\n                summary\n              }\n            }\n          }\n          userErrors {\n            code\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n\n    {% action \"email\" %}\n      {\n        \"to\": {{ order.email | json }},\n        \"subject\": {{ options.email_subject__required | json }},\n        \"body\": {{ options.email_body__required_multiline | replace: \"REISSUED_DISCOUNT_CODE\", reissued_discount_code | newline_to_br | json }},\n        \"reply_to\": {{ shop.customer_email | json }},\n        \"from_display_name\": {{ shop.name | json }},\n        \"bcc\": {{ options.email_bcc__email | json }}\n      }\n    {% endaction %}\n  {% endif %}\n{% endif %}",
  "docs": "This task watches for cancellations of orders that have either a single-use discount code, or a discount code that can only be used once per customer. When such an order is found, this task creates a new copy of the discount exclusively for the related customer, using a new discount code, and emails it to the customer.\r\n\r\nThis task only supports basic discounts, having up to 250 products or collections (if any). Shipping discounts and buy-one-get-one discounts are not supported.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Cancel",
    "Discounts",
    "Orders"
  ]
}
