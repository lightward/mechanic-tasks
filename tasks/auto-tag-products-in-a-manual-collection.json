{
  "name": "Auto-tag products in a manual collection",
  "options": {
    "collection_tag__required": "sale",
    "collection_id__number_required": null
  },
  "subscriptions": [
    "mechanic/user/trigger",
    "shopify/collections/update"
  ],
  "subscriptions_template": "mechanic/user/trigger\nshopify/collections/update",
  "script": "{% assign collection_tag = options.collection_tag__required %}\n\n{% assign collection_qualifies = false %}\n\n{% if event.topic contains \"shopify/collections/\" and collection.id == options.collection_id__number_required %}\n  {% assign collection_qualifies = true %}\n\n{% elsif event.topic == \"mechanic/user/trigger\" %}\n  {% assign collection_qualifies = true %}\n  {% assign collection = shop.collections[options.collection_id__number_required] %}\n{% endif %}\n\n{% if collection_qualifies or event.preview %}\n  {% assign collection_product_ids = collection.products | map: \"admin_graphql_api_id\" %}\n\n  {% assign cursor = nil %}\n  {% assign tagged_product_ids = array %}\n\n  {% for n in (0..100) %}\n    {% capture query %}\n      query {\n        products(\n          first: 250\n          after: {{ cursor | json }}\n          query: {{ collection_tag | json | prepend: \"tag:\" | json }}\n        ) {\n          pageInfo {\n            hasNextPage\n          }\n          edges {\n            cursor\n            node {\n              id\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = query | shopify %}\n\n    {% if event.preview %}\n      {% assign collection_product_ids = array %}\n      {% assign collection_product_ids[0] = \"gid://shopify/Product/1234567890\" %}\n      {% assign collection_product_ids[1] = \"gid://shopify/Product/2345678901\" %}\n\n      {% capture result_json %}\n        {\n          \"data\": {\n            \"products\": {\n              \"edges\": [\n                {\n                  \"node\": {\n                    \"id\": \"gid://shopify/Product/1234567890\"\n                  }\n                },\n                {\n                  \"node\": {\n                    \"id\": \"gid://shopify/Product/9876543210\"\n                  }\n                }\n              ]\n            }\n          }\n        }\n      {% endcapture %}\n\n      {% assign result = result_json | parse_json %}\n    {% endif %}\n\n    {% assign products_result = result.data.products.edges | map: \"node\" | map: \"id\" %}\n    {% assign tagged_product_ids = tagged_product_ids | concat: products_result %}\n\n    {% if result.data.products.pageInfo.hasNextPage %}\n      {% assign cursor = result.data.products.edges.last.cursor %}\n    {% else %}\n      {% break %}\n    {% endif %}\n  {% endfor %}\n\n  {% for collection_product_id in collection_product_ids %}\n    {% unless tagged_product_ids contains collection_product_id %}\n      {% action \"shopify\" %}\n        mutation {\n          tagsAdd(\n            id: {{ collection_product_id | json }}\n            tags: {{ collection_tag | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endunless %}\n  {% endfor %}\n\n  {% for tagged_product_id in tagged_product_ids %}\n    {% unless collection_product_ids contains tagged_product_id %}\n      {% action \"shopify\" %}\n        mutation {\n          tagsRemove(\n            id: {{ tagged_product_id | json }}\n            tags: {{ collection_tag | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endunless %}\n  {% endfor %}\n{% endif %}",
  "docs": "If you prefer to categorize your products using manual collections, but you still need your tags to match up, use this task to monitor your manual collection and automatically tag the products it contains.\n\nRun this task manually to auto-tag products in your configured collection, and to untag any products that are not in this collection. Otherwise, this task will run automatically whenever the configured collection is updated, which includes the addition or removal of products.\r\n\r\nThis task only supports manual collections, not automated collections. ([Learn about the differences here.](https://help.shopify.com/en/manual/products/collections#collection-types)) Configure this task with your collection ID. [Learn how to find this.](https://help.usemechanic.com/en/articles/2946120-how-do-i-find-an-id-for-a-product-collection-order-or-something-else)",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Auto-Tag",
    "Collections",
    "Products"
  ]
}
