{
  "docs": "This task monitors for newly-created orders, and auto-tags any that have a detected post office box in the shipping address. This is useful for shipping services that do not service postal boxes. The task can also optionally send an email notification when a P.O. Box is detected.",
  "halt_action_run_sequence_on_error": false,
  "name": "Auto-tag orders with a post office box",
  "online_store_javascript": null,
  "options": {
    "tag_to_add__required": "PO-Box",
    "send_email_notification__boolean": true,
    "email_recipient__email": "timd.mackey@gmail.com",
    "email_subject": "P.O. Box Detected - Order {{ order.name }}",
    "email_body__multiline": "Order {{ order.name }} was flagged as having a P.O. Box in the shipping address:\n\nName: {{ order.shipping_address.first_name }} {{ order.shipping_address.last_name }}\nCompany: {{ order.shipping_address.company }}\nPhone: {{ order.shipping_address.phone }}\n\nShipping Address:\n{{ order.shipping_address.address1 }}\n{{ order.shipping_address.address2 }}\n{{ order.shipping_address.city }}, {{ order.shipping_address.province_code }} {{ order.shipping_address.zip }}\n{{ order.shipping_address.country }}\n\n\nThanks,\n{{ shop.name }}"
  },
  "perform_action_runs_in_sequence": false,
  "preview_event_definitions": [
    {
      "description": "An order with a PO Box",
      "event_attributes": {
        "topic": "shopify/orders/create",
        "data": {
          "admin_graphql_api_id": "gid://shopify/Order/1234567890",
          "name": "#1030",
          "shipping_address": {
            "address1": "123 Main Street",
            "address2": "PO Box 243",
            "city": "Springfield",
            "company": "Widgets Inc",
            "country": "United States",
            "first_name": "Marge",
            "last_name": "Simpson",
            "phone": "+1-855-553-4763",
            "province_code": "IL",
            "zip": "62701"
          }
        }
      }
    },
    {
      "description": "An order without a PO Box",
      "event_attributes": {
        "topic": "shopify/orders/create",
        "data": {
          "admin_graphql_api_id": "gid://shopify/Order/1234567890",
          "shipping_address": {
            "address1": "123 Main Street",
            "address2": ""
          }
        }
      }
    }
  ],
  "script": "{% assign tag_to_add = options.tag_to_add__required %}\n{% assign send_email_notification = options.send_email_notification__boolean %}\n{% assign email_recipient = options.email_recipient__email %}\n{% assign email_subject = options.email_subject %}\n{% assign email_body = options.email_body__multiline %}\n\n{% comment %} \n  Check address lines 1 and 2 for a post office box\n  The matching logic strips out all spaces and special characters,\n  then matches against one of several strings followed by a digit\n{% endcomment %}\n\n{% assign order_has_po_box = false %}\n{% assign po_box_regex = \"(POB|POBOX|POSTBOX|POSTALBOX|POSTOFFICEBOX|BOXNUMBER|BOXNO|^BOX)\\d+\" %}\n\n{% assign po_box_match1\n  = order.shipping_address.address1\n  | scan: \"[A-Za-z0-9]+\"\n  | join: \"\"\n  | upcase\n  | match: po_box_regex\n%}\n{% assign po_box_match2\n  = order.shipping_address.address2\n  | scan: \"[A-Za-z0-9]+\"\n  | join: \"\"\n  | upcase\n  | match: po_box_regex\n%}\n\n{% if po_box_match1 or po_box_match2 %}\n  {% assign order_has_po_box = true %}\n{% endif %}\n\n{% comment %}\n  IF PO Box is detected, add tag to order\n{% endcomment %}\n{% if order_has_po_box %}\n  {% action \"shopify\" %}\n    mutation {\n      tagsAdd(\n        id: {{ order.admin_graphql_api_id | json }}\n        tags: {{ tag_to_add | json }}\n      ) {\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n\n  {% if send_email_notification %}\n    {% if email_recipient == blank %}\n      {% error \"Email Notifications are enabled, please add a valid email.\" %}\n    {% endif %}\n    {% if email_subject == blank %}\n      {% error \"Email Notifications are enabled, please add an email subject.\" %}\n    {% endif %}\n    {% if email_body == blank %}\n      {% error \"Email Notifications are enabled, please add an email body.\" %}\n    {% endif %}\n\n    {% action \"email\" %}\n      {\n        \"to\": {{ email_recipient | json }},\n        \"subject\": {{ email_subject | json }},\n        \"body\": {{ email_body | newline_to_br | json }},\n        \"reply_to\": {{ shop.customer_email | json }},\n        \"from_display_name\": {{ shop.name | json }}\n      }\n    {% endaction %}\n  {% endif %}\n{% else %}\n  {% log \"No PO Box detected\" %}\n{% endif %}",
  "subscriptions": [
    "shopify/orders/create"
  ],
  "subscriptions_template": "shopify/orders/create",
  "tags": [
    "Address",
    "Auto-Tag",
    "Orders",
    "Shipping"
  ]
}
