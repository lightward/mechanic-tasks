{
  "name": "Sync inventory levels to variant metafields",
  "options": {
    "metafield_namespace__required": null,
    "location_ids_and_metafield_keys__keyval_required": null
  },
  "subscriptions": [
    "shopify/inventory_levels/connect",
    "shopify/inventory_levels/update",
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "shopify/inventory_levels/connect\r\nshopify/inventory_levels/update\r\nmechanic/user/trigger",
  "script": "{% assign metafield_namespace = options.metafield_namespace__required | strip %}\n\n{% if event.preview %}\n  {\n    \"action\": {\n      \"type\": \"shopify\",\n      \"options\": [\n        \"post\",\n        \"/admin/products/1234567890/variants/1234567890/metafields.json\",\n        {\n          \"metafield\": {\n            \"namespace\": {{ metafield_namespace | json }},\n            \"key\": {{ options.location_ids_and_metafield_keys__keyval_required.first.last | json }},\n            \"value_type\": \"integer\",\n            \"value\": 10\n          }\n        }\n      ]\n    }\n  }\n{% elsif event.topic contains \"shopify/inventory_levels/\" %}\n  {% assign inventory_level_string = inventory_level.location_id | append: \"\" %}\n\n  {% assign metafield_namespace = options.metafield_namespace__required | strip %}\n  {% assign metafield_key = options.location_ids_and_metafield_keys__keyval_required[inventory_level_string] %}\n\n  {% if metafield_key != blank %}\n    {\n      \"action\": {\n        \"type\": \"shopify\",\n        \"options\": [\n          \"post\",\n          \"/admin/products/{{ inventory_level.variant.product_id }}/variants/{{ inventory_level.variant.id }}/metafields.json\",\n          {\n            \"metafield\": {\n              \"namespace\": {{ metafield_namespace | json }},\n              \"key\": {{ metafield_key | json }},\n              \"value_type\": \"integer\",\n              \"value\": {{ inventory_level.available | json }}\n            }\n          }\n        ]\n      }\n    }\n  {% endif %}\n{% elsif event.topic == \"mechanic/user/trigger\" %}\n  {% for variant in shop.variants %}\n    {% for inventory_level in variant.inventory_levels %}\n      {% assign inventory_level_string = inventory_level.location_id | append: \"\" %}\n\n      {% assign metafield_namespace = options.metafield_namespace__required | strip %}\n      {% assign metafield_key = options.location_ids_and_metafield_keys__keyval_required[inventory_level_string] %}\n\n      {% if metafield_key != blank and inventory_level.available != blank %}\n        {\n          \"action\": {\n            \"type\": \"shopify\",\n            \"options\": [\n              \"post\",\n              \"/admin/products/{{ variant.product_id }}/variants/{{ variant.id }}/metafields.json\",\n              {\n                \"metafield\": {\n                  \"namespace\": {{ metafield_namespace | json }},\n                  \"key\": {{ metafield_key | json }},\n                  \"value_type\": \"integer\",\n                  \"value\": {{ inventory_level.available | json }}\n                }\n              }\n            ]\n          }\n        }\n      {% endif %}\n    {% endfor %}\n  {% endfor %}\n{% endif %}",
  "docs": "Use this task to easily make your inventory levels available in your online storefront theme. This task monitors for changes to inventory, and copies inventory availability figures to metafields on the related variant.\n\nThis task runs automatically, whenever an inventory level is adjusted or whenever a variant is stocked for the first time at a new location.\r\n\r\nRun this task manually to backfill metafields for all variants that are stocked the locations you've connfigured in this task.\r\n\r\nFind your location IDs by navigating to Settings > Locations in the Shopify admin area. Then, select an individual location from the list. Its location ID can be found at the very end of the URL in your browser's address bar. For example, the location at this URL:\r\n\r\n```\r\nhttps://example.myshopify.com/admin/locations/1234567890\r\n```\r\n\r\n... has a location ID of `1234567890`.\r\n\r\nUse this ID on the left-hand side of the \"Location IDs and metafield keys\" option.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Inventory",
    "Metafields",
    "Products",
    "Sync",
    "Variants"
  ]
}
