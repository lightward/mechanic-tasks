{
  "docs": "This task watches for new and updated products, copying variant barcodes over to the variant SKU. This occurs whenever a barcode is found, and the related variant's SKU does not already have that value.\n\nThe task may also be run manually to scan all products and variants in the shop, updating the unmatched SKUs as needed.",
  "halt_action_run_sequence_on_error": false,
  "name": "Keep SKUs up to date with barcodes",
  "online_store_javascript": null,
  "options": {},
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "script": "{% if event.topic == \"shopify/products/create\" or event.topic == \"shopify/products/update\" %}\n  {% if event.preview %}\n    {% capture product_json %}\n      {\n        \"variants\": [\n          {\n            \"admin_graphql_api_id\": \"gid://shopify/ProductVariant/1234567890\",\n            \"barcode\": \"ABC123\",\n            \"sku\": \"\"\n          }\n        ]\n      }\n    {% endcapture %}\n\n    {% assign product = product_json | parse_json %}\n  {% endif %}\n\n  {% for variant in product.variants %}\n    {% if variant.barcode != blank and variant.sku != variant.barcode %}\n      {% action \"shopify\" %}\n        mutation {\n          productVariantUpdate(\n            input: {\n              id: {{ variant.admin_graphql_api_id | json }}\n              sku: {{ variant.barcode | json }}\n            }\n          ) {\n            productVariant {\n              barcode\n              sku\n            }\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endif %}\n  {% endfor %}\n\n{% elsif event.topic == \"mechanic/user/trigger\" %}\n  {% capture bulk_operation_query %}\n    query {\n      products {\n        edges {\n          node {\n            __typename\n            id\n            variants {\n              edges {\n                node {\n                  __typename\n                  id\n                  barcode\n                  sku\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% action \"shopify\" %}\n    mutation {\n      bulkOperationRunQuery(\n        query: {{ bulk_operation_query | json }}\n      ) {\n        bulkOperation {\n          id\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n\n{% elsif event.topic == \"mechanic/shopify/bulk_operation\" %}\n  {% if event.preview %}\n    {% capture jsonl_string %}\n      {\"__typename\":\"Product\",\"id\":\"gid:\\/\\/shopify\\/Product\\/1234567890\"}\n      {\"__typename\":\"ProductVariant\",\"id\":\"gid:\\/\\/shopify\\/ProductVariant\\/1234567890\",\"barcode\":\"123ABC\",\"__parentId\":\"gid:\\/\\/shopify\\/Product\\/1234567890\"}\n      {\"__typename\":\"ProductVariant\",\"id\":\"gid:\\/\\/shopify\\/ProductVariant\\/2345678901\",\"barcode\":\"456DEF\",\"__parentId\":\"gid:\\/\\/shopify\\/Product\\/1234567890\"}\n    {% endcapture %}\n\n    {% assign bulkOperation = hash %}\n    {% assign bulkOperation[\"objects\"] = jsonl_string | parse_jsonl %}\n  {% endif %}\n\n  {% assign products = bulkOperation.objects | where: \"__typename\", \"Product\" %}\n  {% assign bulk_variants = bulkOperation.objects | where: \"__typename\", \"ProductVariant\" %}\n\n  {% for product in products %}\n    {% assign variants = bulk_variants | where: \"__parentId\", product.id %}\n\n    {% assign variant_inputs = array %}\n\n    {% for variant in variants %}\n      {% if variant.barcode != blank and variant.barcode != variant.sku %}\n        {% assign variant_input = hash %}\n        {% assign variant_input[\"id\"] = variant.id %}\n        {% assign variant_input[\"sku\"] = variant.barcode %}\n        {% assign variant_inputs = variant_inputs | push: variant_input %}\n      {% endif %}\n    {% endfor %}\n\n    {% if variant_inputs != blank %}\n      {% action \"shopify\" %}\n        mutation {\n          productVariantsBulkUpdate(\n            allowPartialUpdates: true\n            productId: {{ product.id | json }}\n            variants: {{ variant_inputs | graphql_arguments }}\n          ) {\n            product {\n              title\n            }\n            productVariants {\n              displayName\n              barcode\n              sku\n            }\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endif %}\n  {% endfor %}\n{% endif %}",
  "subscriptions": [
    "shopify/products/create",
    "shopify/products/delete",
    "mechanic/user/trigger",
    "mechanic/shopify/bulk_operation"
  ],
  "subscriptions_template": "shopify/products/create\nshopify/products/delete\nmechanic/user/trigger\nmechanic/shopify/bulk_operation",
  "tags": [
    "Barcodes",
    "Bulk",
    "SKU"
  ]
}
