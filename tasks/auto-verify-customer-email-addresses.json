{
  "name": "Auto-verify customer email addresses",
  "options": {
    "tag_to_add_after_verifying__required": "verified",
    "verification_email_subject__required": "[{{ shop.name }}] Please verify your account",
    "verification_email_body__multiline_required": "Hello,\n\nWe've received your registration, but we need you to verify your email address before continuing.\n\nPlease visit https://example.com/pages/verify, and submit the verification code VERIFICATION_CODE.\n\nIf you have any questions, please reply to this email.\n\nThanks,\n{{ shop.name }}",
    "verification_confirmed_email_subject__required": "[{{ shop.name }}] Your account has been confirmed",
    "verification_confirmed_email_body__multiline_required": "Hello,\n\nYour account has been successfully verified. Thank you!\n\nCheers,\n{{ shop.name }}",
    "verification_webhook_event_topic__required": "user/customers/verify_webhook"
  },
  "subscriptions": [
    "shopify/customers/create",
    "user/customers/verify_webhook"
  ],
  "subscriptions_template": "shopify/customers/create\n{{ options.verification_webhook_event_topic__required }}",
  "script": "{% comment %}\n  Preferred option order:\n\n  {{ options.tag_to_add_after_verifying__required }}\n  {{ options.verification_email_subject__required }}\n  {{ options.verification_email_body__multiline_required }}\n  {{ options.verification_confirmed_email_subject__required }}\n  {{ options.verification_confirmed_email_body__multiline_required }}\n  {{ options.verification_webhook_event_topic__required }}\n{% endcomment %}\n\n{% if event.topic == \"shopify/customers/create\" %}\n  {% assign customer_tags = customer.tags | split: \", \" %}\n  {% unless customer_tags contains options.tag_to_add_after_verifying__required %}\n    {% assign verification_code = \"now\" | date: \"%s\" | append: customer.email | sha256 | slice: 0, 6 | upcase %}\n    {% action \"email\" %}\n      {\n        \"to\": {{ customer.email | json }},\n        \"subject\": {{ options.verification_email_subject__required | json }},\n        \"body\": {{ options.verification_email_body__multiline_required | replace: \"VERIFICATION_CODE\", verification_code | strip | newline_to_br | json }},\n        \"reply_to\": {{ shop.customer_email | json }},\n        \"from_display_name\": {{ shop.name | json }}\n      }\n    {% endaction %}\n\n    {% assign cache_key = customer.email | downcase | sha256 | prepend: \"customer_verification_code:\" %}\n    {% action \"cache\", \"set\", cache_key, verification_code %}\n  {% endunless %}\n{% elsif event.topic == options.verification_webhook_event_topic__required %}\n  {% assign cache_key = event.data.customer_email | downcase | sha256 | prepend: \"customer_verification_code:\" %}\n  {% assign submitted_verification_code = event.data.verification_code %}\n  {% assign required_verification_code = cache[cache_key] %}\n  {% assign customer = shop.customers[event.data.customer_email] %}\n\n  {% if event.preview %}\n    {% assign submitted_verification_code = \"123ABC\" %}\n    {% assign required_verification_code = \"123ABC\" %}\n    {% assign customer = hash %}\n    {% assign customer[\"admin_graphql_api_id\"] = \"gid://shopify/Customer/1234567890\" %}\n    {% assign customer[\"email\"] = \"customer@example.com\" %}\n  {% endif %}\n\n  {% if customer == nil %}\n    {\"log\": {{ event.data.customer_email | json | prepend: \"Unable to locate customer for submitted email address \" | json }}}\n  {% elsif required_verification_code == nil %}\n    {\"log\": {{ event.data.customer_email | json | prepend: \"No verification code on file for customer \" | json }}}\n  {% elsif required_verification_code != submitted_verification_code %}\n    {\"log\": {{ event.data.customer_email | json | prepend: \"Submitted verification code did not match the code on file for customer \" | json }}}\n    {\"log\": {{ required_verification_code | json | prepend: \"Verification code on file: \" | json }}}\n  {% else %}\n    {% action \"email\" %}\n      {\n        \"to\": {{ customer.email | json }},\n        \"subject\": {{ options.verification_confirmed_email_subject__required | json }},\n        \"body\": {{ options.verification_confirmed_email_body__multiline_required | strip | newline_to_br | json }},\n        \"reply_to\": {{ shop.customer_email | json }},\n        \"from_display_name\": {{ shop.name | json }}\n      }\n    {% endaction %}\n    {% action \"cache\", \"del\", cache_key %}\n    {% action \"shopify\" %}\n      mutation {\n        tagsAdd(\n          id: {{ customer.admin_graphql_api_id | json }}\n          tags: {{ options.tag_to_add_after_verifying__required | json }}\n        ) {\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endif %}\n{% endif %}",
  "docs": null,
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false
}
