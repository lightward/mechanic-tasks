{
  "name": "Auto-verify customer email addresses",
  "options": {
    "tag_to_add_after_verifying__required": "verified",
    "verification_email_subject__required": "[{{ shop.name }}] Please verify your account",
    "verification_email_body__multiline_required": "Hello,\n\nWe've received your registration, but we need you to verify your email address before continuing.\n\nPlease visit https://example.com/pages/verify, and submit the verification code VERIFICATION_CODE.\n\nIf you have any questions, please reply to this email.\n\nThanks,\n{{ shop.name }}",
    "verification_confirmed_email_subject__required": "[{{ shop.name }}] Your account has been confirmed",
    "verification_confirmed_email_body__multiline_required": "Hello,\n\nYour account has been successfully verified. Thank you!\n\nCheers,\n{{ shop.name }}",
    "verification_webhook_event_topic__required": "user/customers/verify_webhook"
  },
  "subscriptions": [
    "shopify/customers/create",
    "user/customers/verify_webhook"
  ],
  "subscriptions_template": "shopify/customers/create\n{{ options.verification_webhook_event_topic__required }}",
  "script": "{% comment %}\n  Preferred option order:\n\n  {{ options.tag_to_add_after_verifying__required }}\n  {{ options.verification_email_subject__required }}\n  {{ options.verification_email_body__multiline_required }}\n  {{ options.verification_confirmed_email_subject__required }}\n  {{ options.verification_confirmed_email_body__multiline_required }}\n  {{ options.verification_webhook_event_topic__required }}\n{% endcomment %}\n\n{% if event.topic == \"shopify/customers/create\" %}\n  {% assign customer_tags = customer.tags | split: \", \" %}\n  {% unless customer_tags contains options.tag_to_add_after_verifying__required %}\n    {% assign verification_code = \"now\" | date: \"%s\" | append: customer.email | sha256 | slice: 0, 6 | upcase %}\n    {% action \"email\" %}\n      {\n        \"to\": {{ customer.email | json }},\n        \"subject\": {{ options.verification_email_subject__required | json }},\n        \"body\": {{ options.verification_email_body__multiline_required | replace: \"VERIFICATION_CODE\", verification_code | strip | newline_to_br | json }},\n        \"reply_to\": {{ shop.customer_email | json }},\n        \"from_display_name\": {{ shop.name | json }}\n      }\n    {% endaction %}\n\n    {% assign cache_key = customer.email | downcase | sha256 | prepend: \"customer_verification_code:\" %}\n    {% action \"cache\", \"set\", cache_key, verification_code %}\n  {% endunless %}\n{% elsif event.topic == options.verification_webhook_event_topic__required %}\n  {% assign cache_key = event.data.customer_email | downcase | sha256 | prepend: \"customer_verification_code:\" %}\n  {% assign submitted_verification_code = event.data.verification_code %}\n  {% assign required_verification_code = cache[cache_key] %}\n  {% assign customer = shop.customers[event.data.customer_email] %}\n\n  {% if event.preview %}\n    {% assign submitted_verification_code = \"123ABC\" %}\n    {% assign required_verification_code = \"123ABC\" %}\n    {% assign customer = hash %}\n    {% assign customer[\"admin_graphql_api_id\"] = \"gid://shopify/Customer/1234567890\" %}\n    {% assign customer[\"email\"] = \"customer@example.com\" %}\n  {% endif %}\n\n  {% if customer == nil %}\n    {\"log\": {{ event.data.customer_email | json | prepend: \"Unable to locate customer for submitted email address \" | json }}}\n  {% elsif required_verification_code == nil %}\n    {\"log\": {{ event.data.customer_email | json | prepend: \"No verification code on file for customer \" | json }}}\n  {% elsif required_verification_code != submitted_verification_code %}\n    {\"log\": {{ event.data.customer_email | json | prepend: \"Submitted verification code did not match the code on file for customer \" | json }}}\n    {\"log\": {{ required_verification_code | json | prepend: \"Verification code on file: \" | json }}}\n  {% else %}\n    {% action \"email\" %}\n      {\n        \"to\": {{ customer.email | json }},\n        \"subject\": {{ options.verification_confirmed_email_subject__required | json }},\n        \"body\": {{ options.verification_confirmed_email_body__multiline_required | strip | newline_to_br | json }},\n        \"reply_to\": {{ shop.customer_email | json }},\n        \"from_display_name\": {{ shop.name | json }}\n      }\n    {% endaction %}\n    {% action \"cache\", \"del\", cache_key %}\n    {% action \"shopify\" %}\n      mutation {\n        tagsAdd(\n          id: {{ customer.admin_graphql_api_id | json }}\n          tags: {{ options.tag_to_add_after_verifying__required | json }}\n        ) {\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endif %}\n{% endif %}",
  "docs": "Use this task to perform an extra verification step for your newly-created customers, in which a verification code is emailed to them, along with a link to a form on your online storefront where they can enter the code for verification. Once verified, the customer will be tagged, and sent a confirmation email.\r\n\r\n### Setting up\r\n\r\n1.  Install this task! :) Customize the email content to taste.\r\n2.  Navigate to your Mechanic account settings, and use the \"Webhooks\" section to create a new webhook, named \"Customer verification\" (or another name of your choosing), and using the event topic \"user/customers/verify_webhook\". Make a note of the webhook URL that Mechanic generates for you.\r\n3.  Adapt and use the following code sample on your online store, perhaps using a new page and [editing its HTML](https://help.shopify.com/en/manual/sell-online/online-store/pages#add-content-to-a-webpage). Make sure to replace the `mechanicWebhookUrl` javascript variable with the webhook URL that Mechanic generated for you earlier.\r\n\r\n    ```\r\n    <p>Please verify your account:</p>\r\n\r\n    <form id=\"verify\">\r\n      <p><label>Email address: <input type=\"email\" name=\"customer_email\" required></label>\r\n      <p><label>Verification code: <input type=\"text\" name=\"verification_code\" required></label>\r\n      <p><button type=\"submit\">Submit</button></p>\r\n    </form>\r\n\r\n    <script>\r\n      var mechanicWebhookUrl = 'https://usemechanic.com/webhook/00000000-0000-0000-0000-000000000000';\r\n      window.addEventListener('load', function () {\r\n        $('#verify').on('submit', function (e) {\r\n          e.preventDefault();\r\n          $.post(mechanicWebhookUrl + '?' + $(this).serialize());\r\n          alert('Your information has been submitted. If verification was successful, you will receive a confirmation email.');\r\n        });\r\n      });\r\n    </script>\r\n    ```\r\n4. You're done! Perform a test to make sure everything works as intended.\r\n\r\nPlease note: the team at Mechanic can help with debugging the Mechanic side of things, but we can't help with adapting the code above. Work with a web designer or developer to create the right experience for your store.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Account",
    "Customers",
    "Email"
  ]
}
