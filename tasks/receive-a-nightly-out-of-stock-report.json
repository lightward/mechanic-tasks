{
  "docs": "Based on an out-of-stock threshold you define, this task sends you an email summary (with CSV attachment) of all variants that are out of stock in any location. Run this task manually to receive the report on demand.",
  "halt_action_run_sequence_on_error": false,
  "name": "Receive a nightly out-of-stock report",
  "online_store_javascript": null,
  "options": {
    "out_of_stock_quantity__number_required": 0,
    "report_recipient_email__email_required": null,
    "report_subject__required": "Out of stock report ({{ \"now\" | date: \"%Y-%m-%d\" }})"
  },
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "script": "{% assign out_of_stock_list_items = array %}\n\n{% assign report_csv = array %}\n{% assign report_csv[0] = array %}\n{% assign report_csv[0][0] = \"Display name\" %}\n{% assign report_csv[0][1] = \"Product ID\" %}\n{% assign report_csv[0][2] = \"Variant ID\" %}\n{% assign report_csv[0][3] = \"Location ID\" %}\n\n{% assign cursor = nil %}\n\n{% for n in (0..30000) %}\n  {% capture query %}\n    query {\n      productVariants(\n        first: 3\n        after: {{ cursor | json }}\n        sortKey: FULL_TITLE\n      ) {\n        pageInfo {\n          hasNextPage\n          endCursor\n        }\n        nodes {\n          displayName\n          legacyResourceId\n          product {\n            legacyResourceId\n          }\n          inventoryItem {\n            tracked\n            inventoryLevels(first: 100) {\n              nodes {\n                location {\n                  name\n                  legacyResourceId\n                }\n                quantities(names: \"available\") {\n                  name\n                  quantity\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n      {\n        \"data\": {\n          \"productVariants\": {\n            \"nodes\": [\n              {\n                \"displayName\": \"Short Sleeve T-Shirt - M, Red\",\n                \"inventoryItem\": {\n                  \"tracked\": true,\n                  \"inventoryLevels\": {\n                    \"nodes\": [\n                      {\n                        \"location\": {\n                          \"name\": \"Warehouse\"\n                        },\n                        \"quantities\": [\n                          {\n                            \"name\": \"available\",\n                            \"quantity\": 0\n                          }\n                        ]\n                      }\n                    ]\n                  }\n                }\n              },\n              {\n                \"displayName\": \"Short Sleeve T-Shirt - S, Blue\",\n                \"inventoryItem\": {\n                  \"tracked\": true,\n                  \"inventoryLevels\": {\n                    \"nodes\": [\n                      {\n                        \"location\": {\n                          \"name\": \"Warehouse\"\n                        },\n                        \"quantities\": [\n                          {\n                            \"name\": \"available\",\n                            \"quantity\": -1\n                          }\n                        ]\n                      }\n                    ]\n                  }\n                }\n              },\n              {\n                \"displayName\": \"Short Sleeve T-Shirt - XL, Green\",\n                \"inventoryItem\": {\n                  \"tracked\": true,\n                  \"inventoryLevels\": {\n                    \"nodes\": [\n                      {\n                        \"location\": {\n                          \"name\": \"Storefront\"\n                        },\n                        \"quantities\": [\n                          {\n                            \"name\": \"available\",\n                            \"quantity\": -5\n                          }\n                        ]\n                      }\n                    ]\n                  }\n                }\n              }\n            ]\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n\n  {% for variant in result.data.productVariants.nodes %}\n    {% if variant.inventoryItem.tracked == false %}\n      {% continue %}\n    {% endif %}\n\n    {% for inventory_level in variant.inventoryItem.inventoryLevels.nodes %}\n      {% if inventory_level.quantities.first.quantity <= options.out_of_stock_quantity__number_required %}\n        {% capture list_item %}\n          <li>\n            {% if event.preview %}\n              <a>{{ variant.displayName }}</a>\n            {% else %}\n              <a href=\"https://{{ shop.domain }}/admin/products/{{ variant.product.legacyResourceId }}/variants/{{ variant.legacyResourceId }}\">{{ variant.displayName }}</a>\n            {% endif %}\n            ({{ inventory_level.quantities.first.quantity }} in {{ inventory_level.location.name }})\n          </li>\n        {% endcapture %}\n        {% assign out_of_stock_list_items[out_of_stock_list_items.size] = list_item %}\n\n        {% assign report_csv_row = array %}\n        {% assign report_csv_row[0] = variant.displayName %}\n        {% assign report_csv_row[1] = variant.product.legacyResourceId %}\n        {% assign report_csv_row[2] = variant.legacyResourceId %}\n        {% assign report_csv_row[3] = inventory_level.location.legacyResourceId %}\n        {% assign report_csv[report_csv.size] = report_csv_row %}\n      {% endif %}\n    {% endfor %}\n  {% endfor %}\n\n  {% if result.data.productVariants.pageInfo.hasNextPage %}\n    {% assign cursor = result.data.productVariants.pageInfo.endCursor %}\n  {% else %}\n    {% break %}\n  {% endif %}\n{% endfor %}\n\n{% if out_of_stock_list_items != empty %}\n  {% action \"email\" %}\n    {\n      \"to\": {{ options.report_recipient_email__email_required | json }},\n      \"subject\": {{ options.report_subject__required | json }},\n      \"body\": {{ out_of_stock_list_items | join: newline | prepend: \"<p>Hello,</p><p>The following variants are out of stock, in the named locations:</p><ul>\" | append: \"</ul><p>Thanks,<br>Mechanic, for \" | append: shop.name | append: \"</p>\" | json }},\n      \"attachments\": {\n        {{ \"now\" | date: \"%Y%m%d\" | prepend: \"out-of-stock-\" | append: \".csv\" | json }}: {{ report_csv | csv | json }}\n      }\n    }\n  {% endaction %}\n{% endif %}\n",
  "subscriptions": [
    "mechanic/user/trigger",
    "mechanic/scheduler/daily"
  ],
  "subscriptions_template": "mechanic/user/trigger\nmechanic/scheduler/daily",
  "tags": [
    "Email",
    "Inventory",
    "Low Stock",
    "Report",
    "Schedule"
  ]
}
