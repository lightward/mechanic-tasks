{
  "name": "Receive a nightly out-of-stock report",
  "options": {
    "out_of_stock_quantity__number_required": 0,
    "report_recipient_email__email_required": null,
    "report_subject__required": "Out of stock report ({{ \"now\" | date: \"%Y-%m-%d\" }})"
  },
  "subscriptions": [
    "mechanic/user/trigger",
    "mechanic/scheduler/daily"
  ],
  "subscriptions_template": "mechanic/user/trigger\nmechanic/scheduler/daily",
  "script": "{% assign out_of_stock_list_items = array %}\n\n{% assign report_csv = array %}\n{% assign report_csv[0] = array %}\n{% assign report_csv[0][0] = \"Display name\" %}\n{% assign report_csv[0][1] = \"Product ID\" %}\n{% assign report_csv[0][2] = \"Variant ID\" %}\n{% assign report_csv[0][3] = \"Location ID\" %}\n\n{% if event.preview %}\n  {% comment %}\n    Signal that we need access to products\n  {% endcomment %}\n  {% capture query %}\n    query {\n      productVariants(\n        first: 250\n      ) {\n        edges {\n          cursor\n          node {\n            id\n          }\n        }\n      }\n    }\n  {% endcapture %}\n  {% assign result = query | shopify %}\n\n  {% comment %}\n    Signal that we need access to inventory\n  {% endcomment %}\n  {% capture query %}\n    query {\n      inventoryItems(first: 5) {\n        edges {\n          node {\n            id\n          }\n        }\n      }\n    }\n  {% endcapture %}\n  {% assign result = query | shopify %}\n\n  {% assign out_of_stock_list_items[0] = \"<li><a>Short Sleeve T-Shirt - M, Red</a> (0 in Warehouse)</a></li>\" %}\n  {% assign out_of_stock_list_items[1] = \"<li><a>Short Sleeve T-Shirt - S, Blue</a> (-1 in Warehouse)</a></li>\" %}\n  {% assign out_of_stock_list_items[2] = \"<li><a>Short Sleeve T-Shirt - XL, Green</a> (-5 in Storefront)</a></li>\" %}\n{% else %}\n  {% assign cursor = nil %}\n\n  {% for n in (0..10000) %}\n    {% capture query %}\n      query {\n        productVariants(\n          first: 9\n          after: {{ cursor | json }}\n          sortKey: FULL_TITLE\n        ) {\n          pageInfo {\n            hasNextPage\n          }\n          edges {\n            cursor\n            node {\n              displayName\n              id\n              legacyResourceId\n              product {\n                legacyResourceId\n              }\n              inventoryItem {\n                tracked\n                inventoryLevels(first: 50) {\n                  edges {\n                    node {\n                      location {\n                        name\n                        legacyResourceId\n                      }\n                      available\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = query | shopify %}\n\n    {% for variant_edge in result.data.productVariants.edges %}\n      {% if variant_edge.node.inventoryItem.tracked == false %}\n        {% continue %}\n      {% endif %}\n\n      {% for inventoryLevel_edge in variant_edge.node.inventoryItem.inventoryLevels.edges %}\n        {% if inventoryLevel_edge.node.available <= options.out_of_stock_quantity__number_required %}\n          {% capture list_item %}\n            <li>\n              <a href=\"https://{{ shop.domain }}/admin/products/{{ variant_edge.node.product.legacyResourceId }}/variants/{{ variant_edge.node.legacyResourceId }}\">{{ variant_edge.node.displayName }}</a>\n              ({{ inventoryLevel_edge.node.available }} in {{ inventoryLevel_edge.node.location.name }})\n            </li>\n          {% endcapture %}\n          {% assign out_of_stock_list_items[out_of_stock_list_items.size] = list_item %}\n\n          {% assign report_csv_row = array %}\n          {% assign report_csv_row[0] = variant_edge.node.displayName %}\n          {% assign report_csv_row[1] = variant_edge.node.product.legacyResourceId %}\n          {% assign report_csv_row[2] = variant_edge.node.legacyResourceId %}\n          {% assign report_csv_row[3] = inventoryLevel_edge.node.location.legacyResourceId %}\n          {% assign report_csv[report_csv.size] = report_csv_row %}\n        {% endif %}\n      {% endfor %}\n    {% endfor %}\n\n    {% if result.data.productVariants.pageInfo.hasNextPage %}\n      {% assign cursor = result.data.productVariants.edges.last.cursor %}\n    {% else %}\n      {% break %}\n    {% endif %}\n  {% endfor %}\n{% endif %}\n\n{% if out_of_stock_list_items != empty %}\n  {% action \"email\" %}\n    {\n      \"to\": {{ options.report_recipient_email__email_required | json }},\n      \"subject\": {{ options.report_subject__required | json }},\n      \"body\": {{ out_of_stock_list_items | join: newline | prepend: \"<p>Hello,</p><p>The following variants are out of stock, in the named locations:</p><ul>\" | append: \"</ul><p>Thanks,<br>Mechanic, for \" | append: shop.name | append: \"</p>\" | json }},\n      \"attachments\": {\n        {{ \"now\" | date: \"%Y%m%d\" | prepend: \"out-of-stock-\" | append: \".csv\" | json }}: {{ report_csv | csv | json }}\n      }\n    }\n  {% endaction %}\n{% endif %}",
  "docs": "Based on an out-of-stock threshold you define, this task sends you an email summary (with CSV attachment) of all variants that are out of stock in any location. Run this task manually to receive the report on demand.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Email",
    "Inventory",
    "Low Stock",
    "Report",
    "Schedule"
  ]
}
