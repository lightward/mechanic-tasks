{
  "name": "Auto-associate products with a delivery profile, by product tag",
  "options": {
    "delivery_profile_id__required_number": "1234567890",
    "required_product_tag__required": "special"
  },
  "subscriptions": [
    "shopify/products/create",
    "shopify/products/update"
  ],
  "subscriptions_template": "shopify/products/create\nshopify/products/update",
  "script": "{% capture query %}\n  query {\n    deliveryProfile(id: {{ \"gid://shopify/DeliveryProfile/\" | append: options.delivery_profile_id__required_number | json }}) {\n      name\n      id\n    }\n\n    product(id: {{ product.admin_graphql_api_id | json }}) {\n      id\n      tags\n      variants(first: 250) {\n        pageInfo {\n          hasNextPage\n        }\n        edges {\n          node {\n            id\n            deliveryProfile {\n              id\n            }\n          }\n        }\n      }\n    }\n  }\n{% endcapture %}\n\n{% assign result = query | shopify %}\n\n{% if event.preview %}\n  {% capture result_json %}\n    {\n      \"data\": {\n        \"deliveryProfile\": {\n          \"name\": \"General Profile\",\n          \"id\": \"gid://shopify/DeliveryProfile/1234567890\"\n        },\n        \"product\": {\n          \"id\": \"gid://shopify/Product/1234567890\",\n          \"tags\": [{{ options.required_product_tag__required | json }}],\n          \"variants\": {\n            \"pageInfo\": {\n              \"hasNextPage\": false\n            },\n            \"edges\": [\n              {\n                \"node\": {\n                  \"id\": \"gid://shopify/ProductVariant/1234567890\",\n                  \"deliveryProfile\": {\n                    \"id\": \"gid://shopify/DeliveryProfile/2345678901\"\n                  }\n                }\n              }\n            ]\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = result_json | parse_json %}\n{% endif %}\n\n{% assign deliveryProfile = result.data.deliveryProfile %}\n{% assign product = result.data.product %}\n\n{% if result.data.deliveryProfile == nil %}\n  {% error message: \"Delivery profile not found! Please double-check the profile ID.\", delivery_profile_id: options.delivery_profile_id__required_number %}\n{% else %}\n  {% log delivery_profile: deliveryProfile, product: product %}\n{% endif %}\n\n{% if product.variants.pageInfo.hasNextPage %}\n  {% log \"Warning: This product has more than 250 variants. Only the first 250 will be handled.\" %}\n{% endif %}\n\n{% assign variant_ids_to_associate = array %}\n{% assign variant_ids_to_dissociate = array %}\n\n{% for variant_edge in product.variants.edges %}\n  {% assign variant = variant_edge.node %}\n\n  {% if product.tags contains options.required_product_tag__required %}\n    {% if variant.deliveryProfile.id != deliveryProfile.id %}\n      {% assign variant_ids_to_associate[variant_ids_to_associate.size] = variant.id %}\n    {% endif %}\n  {% else %}\n    {% if variant.deliveryProfile.id == deliveryProfile.id %}\n      {% assign variant_ids_to_dissociate[variant_ids_to_dissociate.size] = variant.id %}\n    {% endif %}\n  {% endif %}\n{% endfor %}\n\n{% if variant_ids_to_associate != empty or variant_ids_to_dissociate != empty %}\n  {% action \"shopify\" %}\n    mutation {\n      deliveryProfileUpdate(\n        id: {{ deliveryProfile.id | json }}\n        profile: {\n          {% if variant_ids_to_associate != empty %}\n            variantsToAssociate: {{ variant_ids_to_associate | json }}\n          {% endif %}\n\n          {% if variant_ids_to_dissociate != empty %}\n            variantsToDissociate: {{ variant_ids_to_dissociate | json }}\n          {% endif %}\n        }\n      ) {\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% endif %}",
  "docs": "Use this task to automatically add products, as they're tagged, to a specific delivery profile. Untag products to remove them from the configured profile.\n\nConfigure this task using a product tag to watch for, and a delivery profile ID. Find the delivery profile ID by navigating to the \"Shipping and delivery\" section of your Shopify admin area, and clicking on the \"Manage rates\" link of the delivery profile you want to use. The delivery profile ID is the series of numbers at the very end of the URL â€“ if the URL is example.myshopify.com/admin/settings/shipping/profiles/12345, then the delivery profile ID is 123545.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Delivery",
    "Products",
    "Tag"
  ]
}
