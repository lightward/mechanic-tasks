{
  "docs": "Use this task to set the available inventory of a single product variant at a single location in your shop at a specific time on your choice of recurring days. Great for daily or weekly product drops!\n\nThe time of day for the scheduled task run is controlled by setting the hours offset from midnight and the minutes offset from the hour. Entering zeroes in both of those fields will represent midnight.\n\nChoose either to schedule this task for daily runs, or instead on one or more days of the week.\n\nRun the task manually to have it validate the configured variant ID, the location name, and whether that variant is stocked at that location.\n\n**Notes:**\n- Midnight is considered the beginning of the configured day(s).\n- This task will not take into account local clock changes (e.g. \"Daylight saving time\"), so keep that in mind if a scheduled day will fall on a date where the clock is adjusted.\n\n",
  "halt_action_run_sequence_on_error": false,
  "name": "Scheduled inventory adjustment",
  "online_store_javascript": null,
  "options": {
    "variant_id__number_required": null,
    "inventory_quantity_to_set__number_required": null,
    "location_name__required": null,
    "hours_offset_from_midnight__number__required": "0",
    "minutes_offset_from_the_hour__number_required": "0",
    "run_daily__boolean": false,
    "run_on_mondays__boolean": false,
    "run_on_tuesdays__boolean": false,
    "run_on_wednesdays__boolean": false,
    "run_on_thursdays__boolean": false,
    "run_on_fridays__boolean": false,
    "run_on_saturdays__boolean": false,
    "run_on_sundays__boolean": false
  },
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "preview_event_definitions": [],
  "script": "{% assign variant_id = options.variant_id__number_required %}\n{% assign inventory_quantity_to_set = options.inventory_quantity_to_set__number_required %}\n{% assign location_name = options.location_name__required %}\n{% assign hours_offset = options.hours_offset_from_midnight__number__required %}\n{% assign minutes_offset = options.minutes_offset_from_the_hour__number_required %}\n\n{% if inventory_quantity_to_set < 0 %}\n  {% error \"Choose an inventory quantity to set greater than zero.\" %}\n{% endif %}\n\n{% if hours_offset < 0 or hours_offset > 23 %}\n  {% error \"Choose an hours offset from midnight between 0 and 23. An empty value will be considered as zero.\" %}\n{% endif %}\n\n{% if minutes_offset < 0 or minutes_offset > 59 %}\n  {% error \"Choose an minutes offset from the hour between 0 and 59. An empty value will be considered as zero.\" %}\n{% endif %}\n\n{% comment %}\n  -- set up \"run days\" and \"run_time\" for logging output\n{% endcomment %}\n\n{% if hours_offset == 0 and minutes_offset == 0 %}\n  {% assign run_time = \"midnight\" %}\n\n{% elsif hours_offset == 0 %}\n  {%- capture run_time -%}\n    {{ minutes_offset }} minute{% if minutes_offset > 1 %}s{% endif %} past midnight\n  {%- endcapture -%}\n\n{% else %}\n  {%- capture run_time -%}\n    {{ hours_offset }} hour{% if hours_offset > 1 %}s{% endif %}{% if minutes_offset > 0 %} and {{ minutes_offset }} minute{% if minutes_offset > 1 %}s{% endif %}{% endif %} past midnight\n  {%- endcapture -%}\n{% endif %}\n\n{% if options.run_daily__boolean %}\n  {% assign run_days = \"daily\" %}\n{% else %}\n  {% assign run_days = array %}\n\n  {% if options.run_on_mondays__boolean %}\n    {% assign run_days = run_days | push: \"Monday\" %}\n  {% endif %}\n  {% if options.run_on_tuesdays__boolean %}\n    {% assign run_days = run_days | push: \"Tuesday\" %}\n  {% endif %}\n  {% if options.run_on_wednesdays__boolean %}\n    {% assign run_days = run_days | push: \"Wednesday\" %}\n  {% endif %}\n  {% if options.run_on_thursdays__boolean %}\n    {% assign run_days = run_days | push: \"Thursday\" %}\n  {% endif %}\n  {% if options.run_on_fridays__boolean %}\n    {% assign run_days = run_days | push: \"Friday\" %}\n  {% endif %}\n  {% if options.run_on_saturdays__boolean %}\n    {% assign run_days = run_days | push: \"Saturday\" %}\n  {% endif %}\n  {% if options.run_on_sundays__boolean %}\n    {% assign run_days = run_days | push: \"Sunday\" %}\n  {% endif %}\n\n  {% if run_days.size == 1 %}\n    {% capture run_days -%}\n      every {{ run_days.first }}\n    {%- endcapture %}\n\n  {% elsif run_days.size == 2 %}\n    {% capture run_days -%}\n      every {{ run_days | join: \" and \" }}\n    {%- endcapture %}\n\n  {% elsif run_days.size > 2 %}\n    {% capture run_days -%}\n      every {{ run_days | join: \", \" | replace_last: \", \", \", and \" }}\n    {%- endcapture %}\n  {% endif %}\n{% endif %}\n\n{% if run_days == blank %}\n  {% error \"Choose at least one run day option.\" %}\n{% endif %}\n\n{% comment %}\n  -- get location if it exists\n{% endcomment %}\n\n{% capture query %}\n  query {\n    locations(\n      first: 1\n      query: {{ location_name | json | prepend: \"name:\" | json }}\n    ) {\n      nodes {\n        id\n        name\n      }\n    }\n  }\n{% endcapture %}\n\n{% assign result = query | shopify %}\n\n{% if event.preview %}\n  {% capture result_json %}\n    {\n      \"data\": {\n        \"locations\": {\n          \"nodes\": [\n            {\n              \"id\": \"gid://shopify/Location/1234567890\",\n              \"name\": {{ location_name | json }}\n            }\n          ]\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = result_json | parse_json %}\n{% endif %}\n\n{% assign location = result.data.locations.nodes.first %}\n\n{% if location == blank %}\n  {% error \"Location name configured in task does not match a location in this shop.\" %}\n  {% break %}\n{% endif %}\n\n{% comment %}\n  -- check to see if variant exists and get its inventory item ID and available quantitiy at the configured location\n{% endcomment %}\n\n{% capture query %}\n  query {\n    productVariant(id: {{ variant_id | json | prepend: \"gid://shopify/ProductVariant/\" | json }}) {\n      id\n      displayName\n      inventoryItem {\n        id\n        inventoryLevel(locationId: {{ location.id | json }} ) {\n          quantities(names: \"available\") {\n            quantity\n          }\n        }\n      }\n    }\n  }\n{% endcapture %}\n\n{% assign result = query | shopify %}\n\n{% if event.preview %}\n  {% capture result_json %}\n    {\n      \"data\": {\n        \"productVariant\": {\n          \"id\": \"gid://shopify/ProductVariant/1234567890\",\n          \"displayName\": \"ACME Widget - Onyx\",\n          \"inventoryItem\": {\n            \"id\": \"gid://shopify/InventoryItem/1234567890\",\n            \"inventoryLevel\": {\n              \"quantities\": [\n                {\n                  \"quantity\": 0\n                }\n              ]\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = result_json | parse_json %}\n{% endif %}\n\n{% assign variant = result.data.productVariant %}\n{% assign inventory_level = variant.inventoryItem.inventoryLevel %}\n{% assign available = inventory_level.quantities.first.quantity %}\n\n{% if variant == blank %}\n  {% error \"Variant ID configured in task does not match a variant in this shop.\" %}\n  {% break %}\n{% endif %}\n\n{% if inventory_level == blank %}\n  {% error \"Variant ID configured in task does not stock inventory at the configured location.\" %}\n  {% break %}\n{% endif %}\n\n{% if event.topic == \"mechanic/user/trigger\" %}\n  {% comment %}\n    -- this event is purely to log out the task config and related product, variant, inventory item, and location data\n  {% endcomment %}\n\n  {% capture output %}\n    This task is configured to run {{ run_days }} at {{ run_time }} local shop time.\n\n    It will set the available inventory for the {{ variant.displayName }} to {{ inventory_quantity_to_set }} at {{ location_name }}.\n  {% endcapture %}\n\n  {% log output %}\n\n{% elsif event.topic contains \"mechanic/scheduler/\" %}\n  {% comment %}\n    -- adjust the quantity of the configured variant's inventory item at the configured location\n  {% endcomment %}\n\n  {% if inventory_quantity_to_set == available %}\n    {% log \"Available inventory for this variant is already set to the configured quantity.\" %}\n    {% break %}\n  {% endif %}\n\n  {% action \"shopify\" %}\n    mutation {\n      inventoryAdjustQuantities(\n        input: {\n          reason: \"correction\"\n          name: \"available\"\n          changes: [\n            {\n              inventoryItemId: {{ variant.inventoryItem.id | json }}\n              locationId: {{ location.id | json }}\n              delta: {{ inventory_quantity_to_set | minus: available }}\n            }\n          ]\n        }\n      ) {\n        inventoryAdjustmentGroup {\n          reason\n          changes {\n            name\n            delta\n            item {\n              id\n              sku\n            }\n            location {\n              name\n            }\n          }\n        }\n        userErrors {\n          code\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% endif %}",
  "subscriptions": [
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "mechanic/user/trigger\n\n{% assign hours_offset = options.hours_offset_from_midnight__number__required | at_least: 0 %}\n{% assign minutes_offset = options.minutes_offset_from_the_hour__number_required | at_least: 0 %}\n{% assign total_minutes_offset = hours_offset | times: 60 | plus: minutes_offset %}\n\n{% if options.run_daily__boolean %}\n  mechanic/scheduler/daily+{{ total_minutes_offset }}.minutes\n{% else %}\n  {% if options.run_on_mondays__boolean %}\n    mechanic/scheduler/monday+{{ total_minutes_offset }}.minutes\n  {% endif %}\n  {% if options.run_on_tuesdays__boolean %}\n    mechanic/scheduler/tuesday+{{ total_minutes_offset }}.minutes\n  {% endif %}\n  {% if options.run_on_wednesdays__boolean %}\n    mechanic/scheduler/wednesday+{{ total_minutes_offset }}.minutes\n  {% endif %}\n  {% if options.run_on_thursdays__boolean %}\n    mechanic/scheduler/thursday+{{ total_minutes_offset }}.minutes\n  {% endif %}\n  {% if options.run_on_fridays__boolean %}\n    mechanic/scheduler/friday+{{ total_minutes_offset }}.minutes\n  {% endif %}\n  {% if options.run_on_saturdays__boolean %}\n    mechanic/scheduler/saturday+{{ total_minutes_offset }}.minutes\n  {% endif %}\n  {% if options.run_on_sundays__boolean %}\n    mechanic/scheduler/sunday+{{ total_minutes_offset }}.minutes\n  {% endif %}\n{% endif %}",
  "tags": [
    "Inventory",
    "Products",
    "Schedule",
    "Variants"
  ]
}
