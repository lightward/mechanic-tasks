{
  "name": "Maintain a collection of new products",
  "options": {
    "number_of_days_to_keep_a_product_in_this_collection__number": null,
    "number_of_products_to_keep_in_this_collection__number": null,
    "collection_id__number_required": null
  },
  "subscriptions": [
    "mechanic/user/trigger",
    "mechanic/scheduler/daily"
  ],
  "subscriptions_template": "mechanic/user/trigger\r\nmechanic/scheduler/daily",
  "script": "{% assign days_to_keep_products = options.number_of_days_to_keep_a_product_in_this_collection__number %}\n{% assign product_count = options.number_of_products_to_keep_in_this_collection__number %}\n\n{% if event.preview %}\n  {% if days_to_keep_products == blank and product_count == blank %}\n    {\"error\": \"Please fill in either \\\"Number of days to keep a product in this collection\\\" or \\\"Number of products to keep in this collection\\\" (but not both!).\"}\n  {% elsif days_to_keep_products != blank and product_count != blank %}\n    {\"error\": \"Please choose one of the options, but not both! :)\"}\n  {% else %}\n    {\n      \"action\": {\n        \"type\": \"shopify\",\n        \"options\": [\n          \"create\",\n          \"collect\",\n          {\n            \"collection_id\": 1234567890,\n            \"product_id\": 1234567890\n          }\n        ]\n      }\n    }\n\n    {\n      \"action\": {\n        \"type\": \"shopify\",\n        \"options\": [\n          \"delete\",\n          [\n            \"collect\",\n            1234567890\n          ]\n        ]\n      }\n    }\n  {% endif %}\n{% else %}\n  {% assign sorted_products = shop.products.published | sort: \"created_at\" | reverse %}\n  {% assign final_products = nil %}\n\n  {% if product_count != blank %}\n    {% assign final_products = sorted_products | slice: 0, product_count %}\n  {% elsif days_to_keep_products != blank %}\n    {% assign now_s = \"now\" | date: \"%s\" | times: 1 %}\n    {% assign days_to_keep_products_s = days_to_keep_products | times: 24 | times: 60 | times: 60 %}\n    {% assign created_at_threshold_s = now_s | minus: days_to_keep_products_s %}\n\n    {% assign product_count_by_age = nil %}\n    {% for product in sorted_products %}\n      {% assign product_created_at_s = product.created_at | date: \"%s\" | times: 1 %}\n      {% if product_created_at_s < created_at_threshold_s %}\n        {% assign product_count_by_age = forloop.index0 %}\n        {% break %}\n      {% endif %}\n    {% endfor %}\n\n    {% if product_count_by_age == nil %}\n      {% assign final_products = sorted_products %}\n    {% else %}\n      {% assign final_products = sorted_products | slice: 0, product_count_by_age %}\n    {% endif %}\n  {% endif %}\n\n  {% assign collection = shop.collections[options.collection_id__number_required] %}\n  {% assign current_collects = collection.collects %}\n\n  {% assign current_product_ids = current_collects | map: \"product_id\" %}\n\n  {% assign product_ids_to_keep = \"[]\" | parse_json %}\n  {% for product in final_products %}\n    {% if current_product_ids contains product.id %}\n      {% assign product_id_array = \"[\" | append: product.id | append: \"]\" | parse_json %}\n      {% assign product_ids_to_keep = product_ids_to_keep | concat: product_id_array %}\n    {% endif %}\n  {% endfor %}\n\n  {% for collect in current_collects %}\n    {% if product_ids_to_keep contains collect.product_id %}\n      {% continue %}\n    {% endif %}\n\n    {\n      \"action\": {\n        \"type\": \"shopify\",\n        \"options\": [\n          \"delete\",\n          [\n            \"collect\",\n            {{ collect.id | json }}\n          ]\n        ]\n      }\n    }\n  {% endfor %}\n\n  {% for product in final_products %}\n    {% if product_ids_to_keep contains product.id %}\n      {% continue %}\n    {% endif %}\n\n    {\n      \"action\": {\n        \"type\": \"shopify\",\n        \"options\": [\n          \"create\",\n          \"collect\",\n          {\n            \"collection_id\": {{ collection.id | json }},\n            \"product_id\": {{ product.id | json }}\n          }\n        ]\n      }\n    }\n  {% endfor %}\n{% endif %}",
  "docs": "Use this task to maintain a \"New Products\" collection, specifying either a number of products to include or the number of days to keep each product around. Easy! :)\n\nTo use this task, create a manual collection, and add the collection ID to the task options. (Find the ID by opening the collection in the Shopify admin, then looking at the URL in your browser's address bar. If the URL is https://example.myshopify.com/admin/collections/12345, the collection ID is 12345.)\r\n\r\nUse the \"Run task\" button to populate your collection for the first time. After that, this task will run daily, at midnight in your local timezone. During each run, the task will update the collection, adding new products and removing old ones as appropriate.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Collections",
    "Products",
    "Watch"
  ]
}
