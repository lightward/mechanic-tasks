{
  "name": "Auto-tag products when their variants change",
  "options": {
    "variant_attribute_to_watch_for_changes__required": null,
    "tag_product_with_the_titles_of_each_variant_that_has_changed__boolean": null,
    "product_tag_to_add__required": null,
    "ignore_products_with_any_of_these_tags__array": null
  },
  "subscriptions": [
    "mechanic/user/trigger",
    "shopify/products/create",
    "shopify/products/update"
  ],
  "subscriptions_template": "mechanic/user/trigger\nshopify/products/create\nshopify/products/update",
  "script": "{% comment %}\n  An opinion about option order:\n\n  {{ options.variant_attribute_to_watch_for_changes__required }}\n  {{ options.tag_product_with_the_titles_of_each_variant_that_has_changed__boolean }}\n  {{ options.product_tag_to_add__required }}\n  {{ options.ignore_products_with_any_of_these_tags__array }}\n{% endcomment %}\n\n{% assign variant_attribute = options.variant_attribute_to_watch_for_changes__required %}\n\n{% assign valid_variant_attributes = \"barcode,compare_at_price,grams,option1,option2,option3,price,sku,taxable\" | split: \",\" %}\n\n{% unless valid_variant_attributes contains variant_attribute %}\n  {% capture message -%}\n    {{ variant_attribute | json }} is not a valid variant attribute. Choose one of these instead: {{ valid_variant_attributes | join: \", \" }}\n  {%- endcapture %}\n  {% error message %}\n{% endunless %}\n\n{% assign metafield_key = \"variant_ids_and_\" | append: variant_attribute | append: \"s\" %}\n\n{% assign products_that_need_a_metafield_update = array %}\n\n{% if event.topic == \"mechanic/user/trigger\" %}\n  {% if event.preview %}\n    {% capture shop_json %}\n      {\n        \"products\": [\n          {\n            \"variants\": [\n              {\n                \"id\": 1234567890,\n                {{ variant_attribute | json }}: \"OHHELLO\"\n              },\n              {\n                \"id\": 2345678901,\n                {{ variant_attribute | json }}: \"OHGOODBYE\"\n              }\n            ]\n          }\n        ]\n      }\n    {% endcapture %}\n\n    {% assign shop = shop_json | parse_json %}\n  {% endif %}\n\n  {% assign products_that_need_a_metafield_update = shop.products %}\n{% elsif event.topic == \"shopify/products/create\" %}\n  {% assign products_that_need_a_metafield_update[0] = product %}\n{% elsif event.topic == \"shopify/products/update\" %}\n  {% if event.preview %}\n    {% capture product_json %}\n      {\n        \"admin_graphql_api_id\": \"gid://shopify/Product/12346567890\",\n        \"variants\": [\n          {\n            \"id\": 1234567890,\n            {{ variant_attribute | json }}: \"OHHELLO\",\n            \"title\": \"OH / HELLO\"\n          },\n          {\n            \"id\": 2345678901,\n            {{ variant_attribute | json }}: \"OHGOODBYE\",\n            \"title\": \"OH / GOODBYE\"\n          }\n        ],\n        \"metafields\": {\n          \"mechanic\": {\n            {{ metafield_key | json }}: {\n              \"1234567890\": \"OHHELLOOOOOOOOOOOOOOOOO\",\n              \"2345678901\": \"OHGOODBYE\"\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign product = product_json | parse_json %}\n  {% endif %}\n\n  {% assign previous_variant_ids_and_values = product.metafields.mechanic[metafield_key] %}\n\n  {% if previous_variant_ids_and_values == nil %}\n    {% error %}\n      \"Mechanic has not had an opportunty to store this product's previous variant values. Use the \\\"Run task\\\" button to re-scan your products. :)\"\n    {% enderror %}\n  {% endif %}\n\n  {% assign product_qualifies = false %}\n\n  {% assign tags_to_add = array %}\n\n  {% unless options.tag_product_with_the_titles_of_each_variant_that_has_changed__boolean %}\n    {% assign tags_to_add[0] = options.product_tag_to_add__required %}\n  {% endunless %}\n\n  {% for variant in product.variants %}\n    {% assign variant_id_string = variant.id | append: \"\" %}\n    {% if previous_variant_ids_and_values[variant_id_string] != variant[variant_attribute] %}\n      {% assign product_qualifies = true %}\n\n      {% if options.tag_product_with_the_titles_of_each_variant_that_has_changed__boolean %}\n        {% if variant.title == \"Default Title\" %}\n          {% assign tags_to_add[tags_to_add.size] = options.product_tag_to_add__required %}\n        {% else %}\n          {% assign tags_to_add[tags_to_add.size] = options.product_tag_to_add__required | append: \" \" | append: variant.title %}\n        {% endif %}\n      {% endif %}\n    {% endif %}\n  {% endfor %}\n\n  {% if options.ignore_products_with_any_of_these_tags__array != empty %}\n    {% assign product_tags = product.tags | split: \", \" %}\n    {% for product_tag in product_tags %}\n      {% if options.ignore_products_with_any_of_these_tags__array contains product_tag %}\n        {% log message: \"Product is disqualified by tag\", disqualifying_product_tag: product_tag %}\n        {% assign product_qualifies = false %}\n        {% break %}\n      {% endif %}\n    {% endfor %}\n  {% endif %}\n\n  {% if product_qualifies %}\n    {% action \"shopify\" %}\n      mutation {\n        tagsAdd(\n          id: {{ product.admin_graphql_api_id | json }}\n          tags: {{ tags_to_add | json }}\n        ) {\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n\n    {% assign products_that_need_a_metafield_update[0] = product %}\n  {% endif %}\n{% endif %}\n\n{% assign metafields = array %}\n\n{% for product in products_that_need_a_metafield_update %}\n  {% assign metafield_value = hash %}\n  {% assign existing_metafield = product.metafields.mechanic | where: \"key\", metafield_key | first %}\n\n  {% for variant in product.variants %}\n    {% assign variant_id_string = variant.id | append: \"\" %}\n    {% assign metafield_value[variant_id_string] = variant[variant_attribute] %}\n  {% endfor %}\n\n  {% assign metafield_value_json = metafield_value | json %}\n\n  {% if existing_metafield.value == metafield_value_json %}\n    {% log message: \"Product metafield is already up to date\", product_id: product.id %}\n\n  {% else %}\n    {% capture metafield %}\n      {\n        ownerId: {{ product.admin_graphql_api_id | json }}\n        namespace: \"mechanic\"\n        key: {{ metafield_key | json }}\n        value: {{ metafield_value_json | json }}\n        type: \"json\"\n      }\n    {% endcapture %}\n\n    {% assign metafields = metafields | push: metafield %}\n  {% endif %}\n{% endfor %}\n\n{% assign groups_of_metafields = metafields | in_groups_of: 25, fill_with: false %}\n\n{% for group_of_metafields in groups_of_metafields %}\n  {% action \"shopify\" %}\n    mutation {\n      metafieldsSet(\n        metafields: [\n          {{ group_of_metafields | join: newline }}\n        ]\n      ) {\n        metafields {\n          id\n          namespace\n          key\n          type\n          value\n          owner {\n            ... on Product {\n              id\n            }\n          }\n        }\n        userErrors {\n          code\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% endfor %}",
  "docs": "Need to print price tags whenever a SKU is added? Or make a note of a new variant price? Use this task to tag products that need your attention, whenever a specific variant attribute changes.\n\nConfigure this task with a specific variant attribute to watch for changes. Valid attributes include \"barcode\", \"compare_at_price\", \"grams\", \"option1\", \"option2\", \"option3\", \"price\", \"sku\", and \"taxable\".\r\n\r\n*Important:* After saving this task, you must click the \"Run task\" button before the task will start monitoring your existing products. This task run will allow the task to scan your existing products, and store information about their existing variant attributes. This is what lets the task determine whether or not a specific variant attribute has changed.\r\n\r\nEnable the \"Tag with the titles of each variant that has changed\" option to have this task add a separate tag for _each_ variant that has had its specific attribute change values. The variant title will be appended to your configured tag, resulting in one or more tags per product, resembling \"SKU RED\" or \"repriced 5 / SMALL\", depending on your tag choice and variant options.\r\n\r\n[YouTube: Watch the development video!](https://youtu.be/v0W7JZV4RBQ)",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Auto-Tag",
    "Products"
  ]
}
