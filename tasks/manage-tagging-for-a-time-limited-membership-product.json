{
  "name": "Manage tagging for a time-limited membership product",
  "options": {
    "membership_product_title__required": "1 month membership",
    "membership_tag__required": "member",
    "days_to_wait_before_untagging__number_required": 30,
    "remove_tag_immediately_for_cancelled_orders__boolean": null
  },
  "subscriptions": [
    "shopify/orders/paid",
    "user/memberships/expire"
  ],
  "subscriptions_template": "shopify/orders/paid\n{% if options.remove_tag_immediately_for_cancelled_orders__boolean %}\n  shopify/orders/updated\n{% endif %}\nuser/memberships/expire",
  "script": "{% comment %}\n  A preference on option order:\n\n  {{ options.membership_product_title__required }}\n  {{ options.membership_tag__required }}\n  {{ options.days_to_wait_before_untagging__number_required }}\n  {{ options.remove_tag_immediately_for_cancelled_orders__boolean }}\n{% endcomment %}\n\n{% assign order_includes_membership_product = false %}\n{% if order %}\n  {% assign purchased_product_titles = order.line_items | map: \"product\" | map: \"title\" | sort | uniq %}\n\n  {% if options.membership_product_title__required != blank and purchased_product_titles contains options.membership_product_title__required %}\n    {% assign order_includes_membership_product = true %}\n  {% endif %}\n{% endif %}\n\n{% if event.topic == \"shopify/orders/paid\" %}\n  {% assign days_in_the_future_s = options.days_to_wait_before_untagging__number_required | times: 24 | times: 60 | times: 60 %}\n  {% assign expire_at_s = \"now\" | date: \"%s\" | plus: days_in_the_future_s %}\n\n  {% if event.preview %}\n    {% action \"shopify\" %}\n      mutation {\n        tagsAdd(\n          id: \"gid://shopify/Customer/1234567890\"\n          tags: {{ options.membership_tag__required | json }}\n        ) {\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n\n    {% action \"event\" %}\n      {\n        \"topic\": \"user/memberships/expire\",\n        \"data\": {\n          \"membership_tag\": {{ options.membership_tag__required | json }},\n          \"customer_id\": 1234567890\n        },\n        \"run_at\": {{ expire_at_s | json }},\n        \"task_id\": {{ task.id | json }}\n      }\n    {% endaction %}\n  {% elsif order_includes_membership_product %}\n    {% assign customer = order.customer.reload %}\n    {% assign customer_tags = customer.tags | split: \", \" %}\n    {% unless customer_tags contains options.membership_tag__required %}\n      {% action \"shopify\" %}\n        mutation {\n          tagsAdd(\n            id: {{ customer.admin_graphql_api_id | json }}\n            tags: {{ options.membership_tag__required | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n\n      {% action \"event\" %}\n        {\n          \"topic\": \"user/memberships/expire\",\n          \"data\": {\n            \"membership_tag\": {{ options.membership_tag__required | json }},\n            \"customer_id\": {{ customer.id | json }}\n          },\n          \"run_at\": {{ expire_at_s | json }},\n          \"task_id\": {{ task.id | json }}\n        }\n      {% endaction %}\n    {% endunless %}\n  {% endif %}\n{% elsif event.topic == \"shopify/orders/updated\" and options.remove_tag_immediately_for_cancelled_orders__boolean %}\n  {% if event.preview %}\n    {% action \"event\" %}\n      {\n        \"topic\": \"user/memberships/expire\",\n        \"data\": {\n          \"membership_tag\": {{ options.membership_tag__required | json }},\n          \"customer_id\": {{ order.customer.id | json }}\n        },\n        \"task_id\": {{ task.id | json }}\n      }\n    {% endaction %}\n  {% elsif order_includes_membership_product %}\n    {% assign customer = order.customer.reload %}\n    {% assign customer_tags = customer.tags | split: \", \" %}\n    {% if order.cancelled_at != blank and customer_tags contains options.membership_tag__required %}\n      {% action \"event\" %}\n        {\n          \"topic\": \"user/memberships/expire\",\n          \"data\": {\n            \"membership_tag\": {{ options.membership_tag__required | json }},\n            \"customer_id\": {{ customer.id | json }}\n          },\n          \"task_id\": {{ task.id | json }}\n        }\n      {% endaction %}\n    {% endif %}\n  {% endif %}\n{% elsif event.topic == \"user/memberships/expire\" %}\n  {% if event.preview %}\n    {% action \"shopify\" %}\n      mutation {\n        tagsRemove(\n          id: \"gid://shopify/Customer/1234567890\" \n          tags: {{ options.membership_tag__required | json }}\n        ) {\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% elsif event.data.membership_tag == options.membership_tag__required %}\n    {% assign customer = shop.customers[event.data.customer_id] %}\n    {% assign customer_tags = customer.tags | split: \", \" %}\n    {% if customer_tags contains options.membership_tag__required %}\n      {% action \"shopify\" %}\n        mutation {\n          tagsRemove(\n            id: {{ customer.admin_graphql_api_id | json }}\n            tags: {{ options.membership_tag__required | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endif %}\n  {% endif %}\n{% endif %}",
  "docs": "Use this task to automatically tag customers when they purchase specific a membership product, and then untag them after a certain amount of time has passed! (Optionally, this task can also automatically untag the customer if/when their membership order is cancelled.)",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Membership",
    "Products",
    "Tag",
    "Time-Limited"
  ]
}
