{
  "name": "Tag orders in bulk by order name",
  "options": {
  },
  "subscriptions": [
    "mechanic/user/text"
  ],
  "subscriptions_template": "mechanic/user/text",
  "script": "{% if event.preview %}\n  {% action \"shopify\" %}\n    mutation {\n      tagsAdd(\n        id: \"gid://shopify/Order/1234567890\"\n        tags: \"sometag\"\n      ) {\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% else %}\n  {% assign order_name_and_tag_lines = event.data | strip | split: newline %}\n  {% assign order_names_tags = hash %}\n  {% assign order_names_ids = hash %}\n\n  {% assign unresolved_order_names = array %}\n  {% assign already_tagged_order_names = array %}\n\n  {% assign query_batch_size = 100 %}\n  {% assign query_batch_count = order_name_and_tag_lines.size | times: 1.0 | divided_by: query_batch_size | ceil %}\n  {% assign query_batch_count_minus_one = query_batch_count | minus: 1 %}\n\n  {% for n in (0..query_batch_count_minus_one) %}\n    {% assign query_friendly_order_names = array %}\n\n    {% assign offset = n | times: query_batch_size %}\n    {% for line in order_name_and_tag_lines limit:query_batch_size offset:offset %}\n      {% assign keyval = line | split: \":\" %}\n      {% assign order_names_tags[keyval.first] = keyval.last %}\n      {% assign query_friendly_order_names[query_friendly_order_names.size] = line | split: \":\" | first | json %}\n    {% endfor %}\n\n    {% assign cursor = nil %}\n    {% for m in (0..1000) %}\n      {% capture query %}\n        query {\n          orders(\n            first: {{ query_batch_size | json }} \n            after: {{ cursor | json }}\n            query: {{ query_friendly_order_names | join: \" OR \" | json }}\n          ) {\n            pageInfo {\n              hasNextPage\n            }\n            edges {\n              cursor\n              node {\n                id\n                name\n                tags\n              }\n            }\n          }\n        }\n      {% endcapture %}\n\n      {% assign result = query | shopify %}\n\n      {% for order_edge in result.data.orders.edges %}\n        {% assign order_node = order_edge.node %}\n        {% assign order_names_ids[order_node.name] = order_node.id %}\n\n        {% if order_node.tags contains order_names_tags[order_node.name] %}\n          {% assign already_tagged_order_names[already_tagged_order_names.size] = order_node.name %}\n        {% endif %}\n      {% endfor %}\n\n      {% if result.data.orders.pageInfo.hasNextPage %}\n        {% assign cursor = result.data.orders.edges.last.cursor %}\n      {% else %}\n        {% break %}\n      {% endif %}\n    {% endfor %}\n  {% endfor %}\n\n  {% capture mutations %}\n    {% for keyval in order_names_tags %}\n      {% assign order_name = keyval[0] %}\n      {% assign tag_to_apply = keyval[1] %}\n      {% assign order_id = order_names_ids[order_name] %}\n\n      {% if order_id == blank %}\n        {% assign unresolved_order_names[unresolved_order_names.size] = order_name %}\n      {% elsif already_tagged_order_names contains order_name %}\n        {% comment %}do nothing; no need to re-tag{% endcomment %}\n      {% else %}\n        {% action \"shopify\" %}\n          mutation {\n            tagsAdd(\n              id: {{ order_id | json }}\n              tags: {{ tag_to_apply | json }}\n            ) {\n              userErrors {\n                field\n                message\n              }\n            }\n          }\n        {% endaction %}\n      {% endif %}\n    {% endfor %}\n  {% endcapture %}\n\n  {% if unresolved_order_names != blank %}\n    {\"log\": [\"Failed to locate and tag {{ unresolved_order_names.size }} order(s):\", {{ unresolved_order_names | json }}]}\n  {% endif %}\n\n  {% if already_tagged_order_names != blank %}\n    {\"log\": [\"{{ already_tagged_order_names.size }} order(s) were already tagged:\", {{ already_tagged_order_names | json }}]}\n  {% endif %}\n\n  {{ mutations }}\n{% endif %}",
  "docs": "Use this task to rapidly update your order list, by entering a set of order names (e.g. \"#12345\", often called order numbers) and the tags to apply to those orders.\n\nEnter a list of order name + tag pairs, like so:\r\n\r\n```\r\n#12345:approved\r\n#67890:approved\r\n#11111:denied\r\n```\r\n\r\nPlease note: the order name must be an exact match, including any prefixes and suffixes.\r\n\r\nMechanic will look up each order by name, and add the tag you specify. (If the tag is already present, Mechanic won't update the order.)",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false
}
