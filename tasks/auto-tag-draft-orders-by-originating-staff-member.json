{
  "docs": "Use this task to keep track of who created what draft order. This task watches for new draft orders, and tags each one with the name of the store staff member who created it. This task can also be run manually, to scan and tag all draft orders already in your store.\n\nOptionally, enter a tag prefix to help identify these tags (e.g \"Created by: \").",
  "halt_action_run_sequence_on_error": false,
  "name": "Auto-tag draft orders by originating staff member",
  "online_store_javascript": null,
  "options": {
    "tag_prefix": null
  },
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "script": "{% assign tag_prefix = options.tag_prefix %}\n\n{% if event.topic == \"shopify/draft_orders/create\" %}\n  {% capture query %}\n    query {\n      draftOrder(id: {{ draft_order.admin_graphql_api_id | json }}) {\n        id\n        name\n        tags\n        events(\n          first: 1\n          query: \"action:create\"\n        ) {\n          nodes {\n            attributeToUser\n            message\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n      {\n        \"data\": {\n          \"draftOrder\": {\n            \"id\": \"gid://shopify/DraftOrder/1234567890\",\n            \"events\": {\n              \"nodes\": [\n                {\n                  \"attributeToUser\": true,\n                  \"message\": \"Jean Deaux created this draft order.\"\n                }\n              ]\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n\n  {% assign draft_order = result.data.draftOrder %}\n  {% assign create_event = draft_order.events.nodes.first %}\n\n  {% if create_event.attributeToUser and create_event.message contains \" created \" %}\n    {% assign originator = create_event.message | split: \" created \" | first %}\n    {% assign originator_tag = tag_prefix | append: originator %}\n\n    {% unless draft_order.tags contains originator_tag %}\n      {% action \"shopify\" %}\n        mutation {\n          tagsAdd(\n            id: {{ draft_order.id | json }}\n            tags: {{ originator_tag | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endunless %}\n  {% endif %}\n\n{% elsif event.topic == \"mechanic/user/trigger\" %}\n  {% comment %}\n    -- get all draft orders\n  {% endcomment %}\n\n  {% capture bulk_operation_query %}\n    query {\n      draftOrders {\n        edges {\n          node {\n            __typename\n            id\n            tags\n            events(\n              first: 1\n              query: \"action:create\"\n            ) {\n              edges {\n                node {\n                  __typename\n                  id\n                  attributeToUser\n                  message\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% action \"shopify\" %}\n    mutation {\n      bulkOperationRunQuery(\n        query: {{ bulk_operation_query | json }}\n      ) {\n        bulkOperation {\n          id\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n\n{% elsif event.topic == \"mechanic/shopify/bulk_operation\" %}\n  {% if event.preview %}\n    {% capture jsonl_string %}\n      {\"__typename\":\"DraftOrder\",\"id\":\"gid://shopify/DraftOrder/1234567890\"}\n      {\"__typename\":\"BasicEvent\",\"attributeToUser\":true,\"message\":\"Jean Deaux created this draft order\",\"__parentId\":\"gid://shopify/DraftOrder/1234567890\"}\n    {% endcapture %}\n\n    {% assign bulkOperation = hash %}\n    {% assign bulkOperation[\"objects\"] = jsonl_string | parse_jsonl %}\n  {% endif %}\n\n  {% assign draft_orders = bulkOperation.objects | where: \"__typename\", \"DraftOrder\" %}\n  {% assign events = bulkOperation.objects | where: \"__typename\", \"BasicEvent\" %}\n\n  {% for draft_order in draft_orders %}\n    {% assign create_event = events | where: \"__parentId\", draft_order.id | first %}\n\n    {% if create_event.attributeToUser and create_event.message contains \" created \" %}\n      {% assign originator = create_event.message | split: \" created \" | first %}\n      {% assign originator_tag = tag_prefix | append: originator %}\n\n      {% unless draft_order.tags contains originator_tag %}\n        {% action \"shopify\" %}\n          mutation {\n            tagsAdd(\n              id: {{ draft_order.id | json }}\n              tags: {{ originator_tag | json }}\n            ) {\n              userErrors {\n                field\n                message\n              }\n            }\n          }\n        {% endaction %}\n      {% endunless %}\n    {% endif %}\n  {% endfor %}\n{% endif %}\n",
  "subscriptions": [
    "shopify/draft_orders/create",
    "mechanic/user/trigger",
    "mechanic/shopify/bulk_operation"
  ],
  "subscriptions_template": "shopify/draft_orders/create\nmechanic/user/trigger\nmechanic/shopify/bulk_operation",
  "tags": [
    "Auto-Tag",
    "Draft Orders",
    "Staff"
  ]
}
