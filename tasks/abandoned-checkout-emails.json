{
  "name": "Abandoned checkout emails",
  "options": {
    "email_subject__required": "Just one more step to finish your order!",
    "email_body__required_multiline": "Hey there! You're almost done:\n\n<a href=\"ABANDONED_CHECKOUT_URL\">Finish your order today!</a>\n\nThanks,\n- The team at {{ shop.name }}",
    "hours_to_wait_before_sending_email__number_required": 24
  },
  "subscriptions": [
    "user/checkouts/abandoned+24.hours",
    "shopify/checkouts/create",
    "shopify/checkouts/update",
    "shopify/orders/create"
  ],
  "subscriptions_template": "user/checkouts/abandoned+{{ options.hours_to_wait_before_sending_email__number_required }}.hours\nshopify/checkouts/create\nshopify/checkouts/update\nshopify/orders/create",
  "script": "{% assign abandoned_event = \"user/checkouts/abandoned\" %}\n\n{% if event.topic == \"shopify/checkouts/create\" or event.topic == \"shopify/checkouts/update\" %}\n\n  {% if event.preview %}\n    {% assign checkout = hash %}\n    {% assign checkout[\"token\"] = \"00000000000000000000000000000000\" %}\n    {% assign checkout[\"abandoned_checkout_url\"] = \"https://example.shop/checkouts/...\" %}\n  {% endif %}\n\n  {% comment %}\n    When a checkout is created or updated, save it to the cache.\n  {% endcomment %}\n\n  {% capture checkout_cache_key %}checkout:{{ checkout.token }}{% endcapture %}\n\n  {% action \"cache\", \"set\", checkout_cache_key, checkout %}\n\n  {% if event.topic == \"shopify/checkouts/create\" %}\n    {% comment %}\n      ... and if we're looking at the create event, schedule our abandoned checkout followup.\n    {% endcomment %}\n\n    {% action \"event\" %}\n      {\n        \"topic\": {{ abandoned_event | json }},\n        \"data\": {\n          \"checkout_token\": {{ checkout.token | json }}\n        }\n      }\n    {% endaction %}\n\n  {% endif %}\n\n{% elsif event.topic == \"shopify/orders/create\" %}\n\n  {% if event.preview %}\n    {% assign order = hash %}\n    {% assign order[\"name\"] = \"#1234\" %}\n    {% assign order[\"checkout_token\"] = \"00000000000000000000000000000000\" %}\n  {% endif %}\n\n  {% comment %}\n    When an order comes in, cache the order name associated with the checkout token. We'll use this\n    to determine if a checkout made it all the way to an order, thus making the checkout *not* abandoned.\n  {% endcomment %}\n\n  {% if order.checkout_token != blank %}\n    {% capture order_name_cache_key %}checkout_order_name:{{ order.checkout_token }}{% endcapture %}\n\n    {% action \"cache\", \"set\", order_name_cache_key, order.name %}\n  {% endif %}\n\n{% elsif event.topic == abandoned_event %}\n\n  {% comment %}\n    At this stage, our job is to check the cache and see if the checkout converted. If it did, we\n    do nothing. If it didn't, and we have checkout data safely in the cache, we fire off an email.\n    If somehow the checkout didn't convert but also didn't make it to the cache, we bail.\n  {% endcomment %}\n\n  {% assign checkout_token = event.data.checkout_token %}\n\n  {% capture order_name_cache_key %}checkout_order_name:{{ checkout_token }}{% endcapture %}\n  {% capture checkout_cache_key %}checkout:{{ checkout_token }}{% endcapture %}\n\n  {% comment %}\n    Make sure to render an email during event preview - Mechanic and the merchant both need to\n    see what this email will look like.\n  {% endcomment %}\n\n  {% if cache[order_name_cache_key] and event.preview != true %}\n    {% capture message %}Checkout converted as order {{ cache[order_name_cache_key] }} - not sending an email{% endcapture %}\n    {% log message %}\n  {% elsif cache[checkout_cache_key] != blank or event.preview %}\n    {% assign checkout = cache[checkout_cache_key] %}\n\n    {% action \"email\" %}\n      {\n        \"to\": {{ checkout.email | json }},\n        \"subject\": {{ options.email_subject__required | json }},\n        \"body\": {{ options.email_body__required_multiline | replace: 'ABANDONED_CHECKOUT_URL', checkout.abandoned_checkout_url | strip | newline_to_br | json }},\n        \"reply_to\": {{ shop.customer_email | json }},\n        \"from_display_name\": {{ shop.name | json }}\n      }\n    {% endaction %}\n  {% else %}\n    {% log \"Checkout did not convert to an order, but no email address was ever given - unable to send an email\" %}\n  {% endif %}\n\n{% endif %}",
  "docs": "Roll your own abandoned checkout emails with this task – or, modify it to perform any other actions that your business needs when a checkout is let go. :) Out of the box, this task sends customers a recovery link, with an emails subject and message that you can easily customize.\n\nThis task monitors checkouts in your store, and kicks off an email a day after a checkout is created – if the checkout wasn't completed, and if the customer provided their email address.\r\n\r\nTo change the followup time from 1 day to something else, click the \"Show Advanced\" link, and tweak the subscriptions with the time interval that suits your business.\r\n\r\nPlease note! While the full checkout details are stored, it'll require some custom code to substitute in more details than the checkout recovery URL. Click the \"Show Advanced\" link in the task editor to dig into the task script, and feel free to message support if you have any questions.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Abandoned Checkout",
    "Email",
    "Retention"
  ]
}
