{
  "name": "Abandoned checkout emails",
  "options": {
    "email_subject__required": "Just one more step to finish your order!",
    "custom_message__multiline_required": "Hi, you added one or more items to your shopping cart and haven't completed your purchase. You can complete it now while it's still available.",
    "action_button_text__required": "Complete your purchase",
    "cart_items_header_text__required": "Items in your cart",
    "primary_brand_color_as_hex_rgb": "#cb6015",
    "hours_to_wait_before_sending_email__number_required": 24
  },
  "subscriptions": [
    "user/checkouts/abandoned+24.hours",
    "shopify/checkouts/create",
    "shopify/checkouts/update",
    "shopify/orders/create"
  ],
  "subscriptions_template": "user/checkouts/abandoned+{{ options.hours_to_wait_before_sending_email__number_required }}.hours\nshopify/checkouts/create\nshopify/checkouts/update\nshopify/orders/create",
  "script": "{% assign subject = options.email_subject__required %}\n{% assign custom_message = options.custom_message__multiline_required %}\n{% assign action_button_text = options.action_button_text__required %}\n{% assign cart_items_header_text = options.cart_items_header_text__required %}\n{% assign primary_brand_color = options.primary_brand_color_as_hex_rgb | default: \"#1990c6\" %}\n\n{% assign abandoned_event = \"user/checkouts/abandoned\" %}\n\n{% if event.topic == \"shopify/checkouts/create\" or event.topic == \"shopify/checkouts/update\" %}\n\n  {% if event.preview %}\n    {% assign checkout = hash %}\n    {% assign checkout[\"token\"] = \"00000000000000000000000000000000\" %}\n    {% assign checkout[\"abandoned_checkout_url\"] = \"https://example.shop/checkouts/...\" %}\n  {% endif %}\n\n  {% comment %}\n    When a checkout is created or updated, save it to the cache.\n  {% endcomment %}\n\n  {% capture checkout_cache_key %}checkout:{{ checkout.token }}{% endcapture %}\n\n  {% action \"cache\", \"set\", checkout_cache_key, checkout %}\n\n  {% if event.topic == \"shopify/checkouts/create\" %}\n    {% comment %}\n      ... and if we're looking at the create event, schedule our abandoned checkout followup.\n    {% endcomment %}\n\n    {% action \"event\" %}\n      {\n        \"topic\": {{ abandoned_event | json }},\n        \"data\": {\n          \"checkout_token\": {{ checkout.token | json }}\n        }\n      }\n    {% endaction %}\n  {% endif %}\n\n{% elsif event.topic == \"shopify/orders/create\" %}\n\n  {% if event.preview %}\n    {% assign order = hash %}\n    {% assign order[\"name\"] = \"#1234\" %}\n    {% assign order[\"checkout_token\"] = \"00000000000000000000000000000000\" %}\n  {% endif %}\n\n  {% comment %}\n    When an order comes in, cache the order name associated with the checkout token. We'll use this\n    to determine if a checkout made it all the way to an order, thus making the checkout *not* abandoned.\n  {% endcomment %}\n\n  {% if order.checkout_token != blank %}\n    {% capture order_name_cache_key %}checkout_order_name:{{ order.checkout_token }}{% endcapture %}\n\n    {% action \"cache\", \"set\", order_name_cache_key, order.name %}\n  {% endif %}\n\n{% elsif event.topic == abandoned_event %}\n\n  {% comment %}\n    At this stage, our job is to check the cache and see if the checkout converted. If it did, we\n    do nothing. If it didn't, and we have checkout data safely in the cache, we fire off an email.\n    If somehow the checkout didn't convert but also didn't make it to the cache, we bail.\n  {% endcomment %}\n\n  {% assign checkout_token = event.data.checkout_token %}\n\n  {% capture order_name_cache_key %}checkout_order_name:{{ checkout_token }}{% endcapture %}\n  {% capture checkout_cache_key %}checkout:{{ checkout_token }}{% endcapture %}\n\n  {% comment %}\n    Make sure to render an email during event preview - Mechanic and the merchant both need to\n    see what this email will look like.\n  {% endcomment %}\n\n  {% if cache[order_name_cache_key] and event.preview != true %}\n    {% capture message %}Checkout converted as order {{ cache[order_name_cache_key] }} - not sending an email{% endcapture %}\n    {% log message %}\n\n  {% elsif cache[checkout_cache_key].email != blank or event.preview %}\n    {% assign checkout = cache[checkout_cache_key] %}\n\n    {% assign line_item_output = array %}\n\n    {% for line_item in checkout.line_items %}\n      {% assign product = shop.products[line_item.product_id] %}\n      {% assign variant = shop.variants[line_item.variant_id] %}\n      {% assign variant_image = product.images | where: \"id\", variant.image_id | first %}\n      {% assign image = variant_image | default: product.image %}\n\n      {%- capture line_item_html -%}\n        <tr class=\"order-list__item\">\n          <td class=\"order-list__item__cell\">\n            <table>\n              <td>\n                {% if image %}\n                  <img src=\"{{ image.src | img_url: 'compact_cropped' }}\" align=\"left\" width=\"60\" height=\"60\" class=\"order-list__product-image\"/>\n                {% endif %}\n              </td>\n              <td class=\"order-list__product-description-cell\">\n                <span class=\"order-list__item-title\">{{ line_item.title }}&nbsp;&times;&nbsp;{{ line_item.quantity }}</span><br/>\n\n                {% if line_item.variant_title != 'Default Title' %}\n                  <span class=\"order-list__item-variant\">{{ line_item.variant_title }}</span><br/>\n                {% endif %}\n              </td>\n            </table>\n          </td>\n        </tr>\n      {%- endcapture -%}\n\n      {% assign line_item_output = line_item_output | push: line_item_html %}\n    {% endfor %}\n\n    {%- capture body -%}\n      <!DOCTYPE html>\n      <html lang=\"{{ shop.primary_locale }}\">\n        <head>\n        <title>{{ subject }}</title>\n        <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n        <meta name=\"viewport\" content=\"width=device-width\">\n        <style>\n          .body {\n            height: 100% !important;\n            width: 100% !important;\n          }\n          .body,\n          .button.main-action-cell,\n          .container,\n          .header.row,\n          .row,\n          .row.actions,\n          .row.content,\n          .row.section,\n          .order-list__item__cell > table {\n            border-spacing: 0;\n            border-collapse: collapse;\n          }\n          .actions__cell,\n          .button__cell,\n          .content__cell,\n          .header__cell,\n          .order-list__item__cell,\n          .order-list__product-description-cell,\n          .section__cell,\n          .shop-name__cell,\n          .empty-line {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',\n              'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',\n              sans-serif;\n          }\n          .order-list__item,\n          .order-list__product-description-cell,\n          .header.row,\n          .row,\n          .row.actions,\n          .row.content,\n          .row.section {\n            width: 100%;\n          }\n          .shop-name__text > a {\n            font-size: 30px;\n            color: #333;\n            text-decoration: none;\n          }\n          .header.row {\n            margin: 40px 0 20px;\n          }\n          .container {\n            width: 560px;\n            text-align: left;\n            margin: 0 auto;\n          }\n          .shop-name__text {\n            font-weight: 400;\n            font-size: 30px;\n            color: #333;\n            margin: 0;\n          }\n          .content__cell {\n            padding-bottom: 40px;\n            border: 0;\n          }\n          .row.actions {\n            margin-top: 20px;\n          }\n          .button.main-action-cell {\n            float: left;\n            margin-right: 15px;\n          }\n          .button__cell {\n            border-radius: 4px;\n            background: {{ primary_brand_color }};\n          }\n          .button__text {\n            font-size: 16px;\n            text-decoration: none;\n            display: block;\n            color: #fff;\n            padding: 20px 25px;\n          }\n          .section__cell {\n            padding: 40px 0;\n          }\n          .order-list__item__cell {\n            padding-bottom: 15px;\n          }\n          .order-list__product-image {\n            margin-right: 15px;\n            border-radius: 8px;\n            border: 1px solid #e5e5e5;\n          }\n          .order-list__item-title {\n            font-size: 16px;\n            font-weight: 600;\n            line-height: 1.4;\n            color: #555;\n          }\n          .order-list__item-variant {\n            font-size: 14px;\n            color: #999;\n          }\n          .spacer {\n            min-width: 600px;\n            height: 0;\n          }\n          .empty-line {\n            line-height: 0;\n          }\n          a, a:hover, a:active, a:visited {\n            color: {{ primary_brand_color }};\n          }\n        </style>\n        </head>\n        <body>\n          <table class=\"body\">\n            <tr>\n              <td>\n                <table class=\"header row\">\n                  <tr>\n                    <td class=\"header__cell\">\n                      <center>\n                        <table class=\"container\">\n                          <tr>\n                            <td>\n                              <table class=\"row\">\n                                <tr>\n                                  <td class=\"shop-name__cell\">\n                                    <h1 class=\"shop-name__text\">\n                                      <a href=\"https://{{ shop.domain }}/\">{{ shop.name }}</a>\n                                    </h1>\n                                  </td>\n                                </tr>\n                              </table>\n                            </td>\n                          </tr>\n                        </table>\n                      </center>\n                    </td>\n                  </tr>\n                </table>\n                <table class=\"row content\">\n                  <tr>\n                    <td class=\"content__cell\">\n                      <center>\n                        <table class=\"container\">\n                          <tr>\n                            <td>\n                              <p>{{ custom_message | strip | newline_to_br }}</p>\n                              <table class=\"row actions\">\n                                <tr>\n                                  <td class=\"empty-line\">&nbsp;</td>\n                                </tr>\n                                <tr>\n                                  <td class=\"actions__cell\">\n                                    <table class=\"button main-action-cell\">\n                                      <tr>\n                                        <td class=\"button__cell\"><a href=\"{{ checkout.abandoned_checkout_url }}\" class=\"button__text\">{{ action_button_text }}</a></td>\n                                      </tr>\n                                    </table>\n                                  </td>\n                                </tr>\n                              </table>\n                            </td>\n                          </tr>\n                        </table>\n                      </center>\n                    </td>\n                  </tr>\n                </table>\n                <table class=\"row section\">\n                  <tr>\n                    <td class=\"section__cell\">\n                      <center>\n                        <table class=\"container\">\n                          <tr>\n                            <td>\n                              <h3>{{ cart_items_header_text }}</h3>\n                            </td>\n                          </tr>\n                        </table>\n                        <table class=\"container\">\n                          <tr>\n                            <td>\n                              <table class=\"row\">\n                                {{ line_item_output | join: newline }}\n                              </table>\n                            </td>\n                          </tr>\n                        </table>\n                      </center>\n                    </td>\n                  </tr>\n                </table>\n              </td>\n            </tr>\n          </table>\n        </body>\n      </html>\n    {%- endcapture -%}\n\n    {% action \"email\" %}\n      {\n        \"to\": {{ checkout.email | json }},\n        \"subject\": {{ subject | json }},\n        \"body\": {{ body | json }},\n        \"reply_to\": {{ shop.customer_email | json }},\n        \"from_display_name\": {{ shop.name | json }}\n      }\n    {% endaction %}\n\n  {% else %}\n    {% log \"Checkout did not convert to an order, but no email address was ever given - unable to send an email\" %}\n  {% endif %}\n{% endif %}\n",
  "docs": "This task monitors checkouts in your store, and kicks off an email a configurable number of hours after a checkout is created â€“ if the checkout wasn't completed, and if the customer provided their email address.\n\nThis task uses the same basic formatting as the standard Shopify abandoned checkout notification template. You may override the action button background with your own brand color, provided it is entered as an RGB hex value (e.g. #abc123).\n\nYou can configure the custom message to the customer, the action button text, and the item list header. And since the task will set an email header to the primary locale (language) of your shop, these may be set to your native shop language. Product and variant titles will automatically be output in the language they are listed in your shop.\n\nEven though they don't appear in the task preview, item images *will* appear in the sent emails.\n\n**Important**: When using this task, make sure that Shopify's abandoned checkout notifications are disabled to prevent sending duplicate emails to customers.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "preview_event_definitions": [],
  "tags": [
    "Abandoned Checkout",
    "Email",
    "Retention"
  ]
}
