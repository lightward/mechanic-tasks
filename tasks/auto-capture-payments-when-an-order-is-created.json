{
  "name": "Auto-capture payments when an order is created",
  "options": {
    "number_of_minutes_to_wait_before_capturing__number": null,
    "capture_orders_with_a_high_risk_level__boolean": true,
    "capture_orders_with_a_medium_risk_level__boolean": true,
    "capture_orders_with_a_low_risk_level__boolean": true,
    "required_order_tag": null,
    "only_capture_for_line_items_that_do_not_require_shipping__boolean": false
  },
  "subscriptions": [
    "shopify/orders/create"
  ],
  "subscriptions_template": "{% assign n = options.number_of_minutes_to_wait_before_capturing__number %}\n\nshopify/orders/create{% if n != blank and n > 0 %}+{{ n }}.minutes{% endif %}",
  "script": "{% assign n = options.number_of_minutes_to_wait_before_capturing__number %}\n{% if n != blank and n <= 0 %}\n  {\"error\": \"'Number of minutes to wait before capturing' must be positive! :)\"}\n{% endif %}\n\n{% capture query %}\n  query {\n    order(id: {{ order.admin_graphql_api_id | json }}) {\n      id\n      tags\n      riskLevel\n      transactions(first: 1, capturable: true) {\n        id\n        totalUnsettledSet {\n          presentmentMoney {\n            amount\n            currencyCode\n          }\n        }\n      }\n      lineItems(first: 250) {\n        pageInfo {\n          hasNextPage\n        }\n        edges {\n          node {\n            requiresShipping\n            discountedTotalSet {\n              presentmentMoney {\n                amount\n                currencyCode\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n{% endcapture %}\n\n{% assign result = query | shopify %}\n\n{% if event.preview %}\n  {% if options.capture_orders_with_a_high_risk_level__boolean %}\n    {% assign preview_risk_level = \"HIGH\" %}\n  {% elsif options.capture_orders_with_a_medium_risk_level__boolean %}\n    {% assign preview_risk_level = \"MEDIUM\" %}\n  {% elsif options.capture_orders_with_a_low_risk_level__boolean %}\n    {% assign preview_risk_level = \"LOW\" %}\n  {% endif %}\n  \n  {% capture result_json %}\n    {\n      \"data\": {\n        \"order\": {\n          \"id\": \"gid://shopify/Order/1234567890\",\n          \"tags\": [{{ options.required_order_tag | json }}],\n          \"capturable\": true,\n          \"riskLevel\": {{ preview_risk_level | json }},\n          \"transactions\": [\n            {\n              \"id\": \"gid://shopify/OrderTransaction/1234567890\",\n              \"totalUnsettledSet\": {\n                \"presentmentMoney\": {\n                  \"amount\": \"200.0\",\n                  \"currencyCode\": \"CAD\"\n                }\n              }\n            }\n          ],\n          \"lineItems\": {\n            \"pageInfo\": {\n              \"hasNextPage\": false\n            },\n            \"edges\": [\n              {\n                \"node\": {\n                  \"requiresShipping\": true,\n                  \"discountedTotalSet\": {\n                    \"presentmentMoney\": {\n                      \"amount\": \"10.0\",\n                      \"currencyCode\": \"CAD\"\n                    }\n                  }\n                }\n              },\n              {\n                \"node\": {\n                  \"requiresShipping\": false,\n                  \"discountedTotalSet\": {\n                    \"presentmentMoney\": {\n                      \"amount\": \"100.0\",\n                      \"currencyCode\": \"CAD\"\n                    }\n                  }\n                }\n              }\n            ]\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = result_json | parse_json %}\n{% endif %}\n\n{% assign orderNode = result.data.order %}\n{% assign capturableTransactionNode = orderNode.transactions.first %}\n\n{% log order: orderNode %}\n\n{% assign do_capture = false %}\n\n{% if capturableTransactionNode %}\n  {% if orderNode.riskLevel == \"HIGH\" and options.capture_orders_with_a_high_risk_level__boolean %}\n    {% assign do_capture = true %}\n  {% elsif orderNode.riskLevel == \"MEDIUM\" and options.capture_orders_with_a_medium_risk_level__boolean %}\n    {% assign do_capture = true %}\n  {% elsif orderNode.riskLevel == \"LOW\" and options.capture_orders_with_a_low_risk_level__boolean %}\n    {% assign do_capture = true %}\n  {% endif %}\n{% endif %}\n\n{% if options.required_order_tag != blank %}\n  {% unless orderNode.tags contains options.required_order_tag %}\n    {% assign do_capture = false %}\n  {% endunless %}\n{% endif %}\n\n{% if do_capture %}\n  {% assign maximum_amount_to_capture = capturableTransactionNode.totalUnsettledSet.presentmentMoney.amount | times: 1 %}\n\n  {% if options.only_capture_for_line_items_that_do_not_require_shipping__boolean %}\n    {% assign lineItemNodes_noShipping = orderNode.lineItems.edges | map: \"node\" | where: \"requiresShipping\", false %}\n\n    {% if lineItemNodes_noShipping.size == orderNode.lineItems.edges.size and orderNode.lineItems.pageInfo.hasNextPage == false %}\n      {% comment %}\n        Automatically include taxes/etc if every line item qualifies\n      {% endcomment %}\n      {% assign amount_to_capture = maximum_amount_to_capture %}\n    {% else %}\n      {% assign amount_to_capture = 0 %}\n      {% for lineItemNode in lineItemNodes_noShipping %}\n        {% assign amount_to_capture = amount_to_capture | plus: lineItemNode.discountedTotalSet.presentmentMoney.amount %}\n      {% endfor %}\n\n      {% if amount_to_capture > maximum_amount_to_capture %}\n        {% assign amount_to_capture = maximum_amount_to_capture %}\n      {% endif %}\n    {% endif %}\n  {% else %}\n    {% assign amount_to_capture = maximum_amount_to_capture %}\n  {% endif %}\n\n  {% action \"shopify\" %}\n    mutation {\n      orderCapture(\n        input: {\n          id: {{ orderNode.id | json }}\n          parentTransactionId: {{ capturableTransactionNode.id | json }}\n          amount: {{ amount_to_capture | json }}\n          currency: {{ capturableTransactionNode.totalUnsettledSet.presentmentMoney.currencyCode }}\n        }\n      ) {\n        transaction {\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% endif %}",
  "docs": "This task runs immediately after an order is created, and captures an authorized transaction if one is present. Choose which risk levels to capture for, and optionally choose to filter by order tag. You may also choose to only capture funds for line items that do not require shipping.\n\nThis task runs immediately after an order is created. If you are selectively capturing by risk level, and if you have additional apps informing an order's risk level, increase \"Number of minutes to wait before capturing\" to make sure those apps have time to contribute their data.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false
}
