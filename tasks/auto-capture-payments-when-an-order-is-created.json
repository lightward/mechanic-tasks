{
  "docs": "This task runs immediately after an order is created, and captures an authorized transaction if one is present. Choose which risk levels to capture for, and optionally choose to filter by order tag. You may also choose to only capture funds for line items that do not require shipping.\n\nThis task runs immediately after an order is created. If you are selectively capturing by risk level, and if you have additional apps informing an order's risk level, increase \"Number of minutes to wait before capturing\" to make sure those apps have time to contribute their data.",
  "halt_action_run_sequence_on_error": false,
  "name": "Auto-capture payments when an order is created",
  "online_store_javascript": null,
  "options": {
    "minutes_to_wait_before_capturing__number": null,
    "filter_orders_by_this_tag": null,
    "capture_orders_with_a_high_risk_level__boolean": false,
    "capture_orders_with_a_medium_risk_level__boolean": false,
    "capture_orders_with_a_low_risk_level__boolean": true
  },
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "preview_event_definitions": [],
  "script": "{% assign min = options.minutes_to_wait_before_capturing__number | at_least: 0 %}\n{% assign filter_orders_by_this_tag = options.filter_orders_by_this_tag %}\n{% assign capture_orders_with_a_high_risk_level = options.capture_orders_with_a_high_risk_level__boolean %}\n{% assign capture_orders_with_a_medium_risk_level = options.capture_orders_with_a_medium_risk_level__boolean %}\n{% assign capture_orders_with_a_low_risk_level = options.capture_orders_with_a_low_risk_level__boolean %}\n\n{% capture query %}\n  query {\n    order(id: {{ order.admin_graphql_api_id | json }}) {\n      id\n      name\n      displayFinancialStatus\n      tags\n      riskLevel\n      transactions(capturable: true) {\n        id\n        kind\n        totalUnsettledSet {\n          shopMoney {\n            amount\n          }\n        }\n      }\n    }\n  }\n{% endcapture %}\n\n{% assign result = query | shopify %}\n\n{% if event.preview %}\n  {% if capture_orders_with_a_high_risk_level %}\n    {% assign preview_risk_level = \"HIGH\" %}\n  {% elsif capture_orders_with_a_medium_risk_level %}\n    {% assign preview_risk_level = \"MEDIUM\" %}\n  {% elsif capture_orders_with_a_low_risk_level %}\n    {% assign preview_risk_level = \"LOW\" %}\n  {% endif %}\n\n  {% capture result_json %}\n    {\n      \"data\": {\n        \"order\": {\n          \"id\": \"gid://shopify/Order/1234567890\",\n          \"displayFinancialStatus\": \"AUTHORIZED\",\n          \"tags\": [{{ filter_orders_by_this_tag | json }}],\n          \"capturable\": true,\n          \"riskLevel\": {{ preview_risk_level | json }},\n          \"transactions\": [\n            {\n              \"id\": \"gid://shopify/OrderTransaction/1234567890\",\n              \"kind\": \"AUTHORIZATION\",\n              \"status\": \"SUCCESS\",\n              \"totalUnsettledSet\": {\n                \"shopMoney\": {\n                  \"amount\": \"12.34\"\n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = result_json | parse_json %}\n{% endif %}\n\n{% assign order = result.data.order %}\n\n{% unless order.displayFinancialStatus == \"AUTHORIZED\" or order.displayFinancialStatus == \"PARTIALLY_PAID\" %}\n  {% break %}\n{% endunless %}\n\n{% assign do_capture = false %}\n\n{% if order.riskLevel == \"HIGH\" and capture_orders_with_a_high_risk_level %}\n  {% assign do_capture = true %}\n{% elsif order.riskLevel == \"MEDIUM\" and capture_orders_with_a_medium_risk_level %}\n  {% assign do_capture = true %}\n{% elsif order.riskLevel == \"LOW\" and capture_orders_with_a_low_risk_level %}\n  {% assign do_capture = true %}\n{% else %}\n  {% error \"Choose at least one risk level to capture for!\" %}\n{% endif %}\n\n{% if filter_orders_by_this_tag != blank %}\n  {% unless order.tags contains filter_orders_by_this_tag %}\n    {% assign do_capture = false %}\n  {% endunless %}\n{% endif %}\n\n{% if do_capture %}\n  {% assign authorized_transactions = order.transactions | where: \"kind\", \"AUTHORIZATION\" %}\n\n  {% for transaction in authorized_transactions %}\n    {% assign unsettled_amount = transaction.totalUnsettledSet.shopMoney.amount | times: 1.0 %}\n\n    {% if unsettled_amount > 0 %}\n      {% action \"shopify\" %}\n        mutation {\n          orderCapture(\n            input: {\n              id: {{ order.id | json }}\n              parentTransactionId: {{ transaction.id | json }}\n              amount: {{ unsettled_amount | json }}\n            }\n          ) {\n            transaction {\n              id\n              status\n              parentTransaction {\n                id\n                kind\n              }\n            }\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endif %}\n  {% endfor %}\n{% endif %}",
  "subscriptions": [
    "shopify/orders/create+0.minutes"
  ],
  "subscriptions_template": "shopify/orders/create+{{ options.minutes_to_wait_before_capturing__number | at_least: 0 }}.minutes",
  "tags": [
    "Orders",
    "Payment",
    "Risk"
  ]
}
