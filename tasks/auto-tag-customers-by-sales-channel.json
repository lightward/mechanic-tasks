{
  "name": "Auto-tag customers by sales channel",
  "options": {
    "sales_channel_names_and_tags__keyval_required": {
      "Online Store": "online-customer",
      "Buy Button": "buy-button-customer"
    },
    "test_mode__boolean": true
  },
  "subscriptions": [
    "shopify/orders/create",
    "mechanic/user/trigger",
    "mechanic/shopify/bulk_operation"
  ],
  "subscriptions_template": "shopify/orders/create\nmechanic/user/trigger\nmechanic/shopify/bulk_operation",
  "script": "{% if event.topic contains \"shopify/orders/\" %}\n  {% capture query %}\n    query {\n      order(id: {{ order.admin_graphql_api_id | json }}) {\n        customer {\n          id\n          tags\n        }\n        publication {\n          name\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n      {\n        \"data\": {\n          \"order\": {\n            \"customer\": {\n              \"id\": \"gid://shopify/Customer/1234567890\",\n              \"tags\": []\n            },\n            \"publication\": {\n              \"name\": {{ options.sales_channel_names_and_tags__keyval_required.first.first | json }}\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n\n  {% assign publication_name = result.data.order.publication.name %}\n  {% assign tag_to_add = options.sales_channel_names_and_tags__keyval_required[publication_name] %}\n\n  {% if tag_to_add == blank %}\n    {% log message: \"No tag found for this channel. Skipping.\", publication_name: publication_name %}\n  {% elsif result.data.order.customer.tags contains tag_to_add %}\n    {% log message: \"The customer already has the tag for this channel. Skipping.\", publication_name: publication_name, tag_to_add: tag_to_add %}\n  {% elsif options.test_mode__boolean %}\n    {% action \"echo\" customer_id: result.data.order.customer.id, customer_publication_name: publication_name, customer_tag_to_add: tag_to_add %}\n  {% else %}\n    {% action \"shopify\" %}\n      mutation {\n        tagsAdd(\n          id: {{ result.data.order.customer.id | json }}\n          tags: {{ tag_to_add | json }}\n        ) {\n          userErrors {\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endif %}\n{% elsif event.topic == \"mechanic/user/trigger\" %}\n  {% capture bulk_operation_query %}\n    query {\n      customers {\n        edges {\n          node {\n            __typename\n            id\n            tags\n            orders {\n              edges {\n                node {\n                  __typename\n                  publication {\n                    name\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% action \"shopify\" %}\n    mutation {\n      bulkOperationRunQuery(\n        query: {{ bulk_operation_query | json }}\n      ) {\n        bulkOperation {\n          id\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% elsif event.topic == \"mechanic/shopify/bulk_operation\" %}\n  {% if event.preview %}\n    {% capture bulkOperation_json %}\n      {\n        \"objects\": [\n          {\n            \"__typename\": \"Customer\",\n            \"id\": \"gid://shopify/Customer/1234567890\",\n            \"tags\": []\n          },\n          {\n            \"__typename\": \"Order\",\n            \"publication\": {\n              \"name\": {{ options.sales_channel_names_and_tags__keyval_required.first.first | json }}\n            },\n            \"__parentId\": \"gid://shopify/Customer/1234567890\"\n          }\n        ]\n      }\n    {% endcapture %}\n\n    {% assign bulkOperation = bulkOperation_json | parse_json %}\n  {% endif %}\n\n  {% assign customers = bulkOperation.objects | where: \"__typename\", \"Customer\" %}\n  {% assign orders = bulkOperation.objects | where: \"__typename\", \"Order\" %}\n  {% assign publication_counts = hash %}\n\n  {% for order in orders %}\n    {% assign publication_name = order.publication.name %}\n\n    {% if publication_name == blank %}\n      {% assign publication_name = \"(not placed via sales channel)\" %}\n    {% endif %}\n\n    {% assign publication_counts[publication_name] = publication_counts[publication_name] | plus: 1 %}\n  {% endfor %}\n\n  {% log publication_counts: publication_counts %}\n\n  {% if options.test_mode__boolean %}\n    {% assign summaries = array %}\n  {% endif %}\n          \n  {% for customer in customers %}\n    {% assign customer_orders = orders | where: \"__parentId\", customer.id %}\n    {% assign customer_publication_names = customer_orders | map: \"publication\" | map: \"name\" | compact | uniq %}\n\n    {% assign tags_to_add = array %}\n    {% for name in customer_publication_names %}\n      {% assign tag = options.sales_channel_names_and_tags__keyval_required[name] %}\n\n      {% if tag == blank or customer.tags contains tag %}\n        {% continue %}\n      {% endif %}\n\n      {% assign tags_to_add[tags_to_add.size] = tag %}\n    {% endfor %}\n\n    {% if tags_to_add != empty %}\n      {% if options.test_mode__boolean %}\n        {% assign summary = hash %}\n        {% assign summary[\"customer_id\"] = customer.id %}\n        {% assign summary[\"customer_publication_names\"] = customer_publication_names %}\n        {% assign summary[\"customer_tags_to_add\"] = tags_to_add %}\n        {% assign summaries[summaries.size] = summary %}\n      {% else %}\n        {% action \"shopify\" %}\n          mutation {\n            tagsAdd(\n              id: {{ customer.id | json }}\n              tags: {{ tags_to_add | uniq | json }}\n            ) {\n              userErrors {\n                field\n                message\n              }\n            }\n          }\n        {% endaction %}\n      {% endif %}\n    {% endif %}\n  {% endfor %}\n\n  {% if options.test_mode__boolean %}\n    {% action \"echo\" summaries %}\n  {% endif %}\n{% endif %}",
  "docs": "Use this task to tag customers, as their orders come in, based on which sales channel they used for their purchase. Run this task manually to backfill tags for customers based on their historical orders. Use test mode to see what this task _would_ do, if test mode wasn't enabled. :)\r\n\r\n[YouTube: Watch the development video!](https://youtu.be/TN13-eX1ops)",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false
}
