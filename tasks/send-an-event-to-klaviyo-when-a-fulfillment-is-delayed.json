{
  "name": "Send an event to Klaviyo when a fulfillment is delayed",
  "options": {
    "test_mode__boolean": null,
    "qualifying_fulfillment_statuses__array_required": [
      "in_transit",
      "failure",
      "attempted_delivery"
    ],
    "klaviyo_api_token__required": null,
    "klaviyo_event_name__required": "Fulfillment delayed or failed",
    "days_to_wait_before_checking__number_required": 5
  },
  "subscriptions": [
    "shopify/orders/fulfilled+5.days"
  ],
  "subscriptions_template": "{% if options.test_mode__boolean %}\n  mechanic/user/trigger\n{% else %}\n  shopify/orders/fulfilled+{{ options.days_to_wait_before_checking__number_required | default: 5 }}.days\n{% endif %}",
  "script": "{% if options.test_mode__boolean or event.preview %}\n  {% capture order_json %}\n    {\n      \"name\": \"#1234\",\n      \"email\": \"customer@example.com\",\n      \"fulfillments\": [\n        {\n          \"shipment_status\": {{ options.qualifying_fulfillment_statuses__array_required[0] | json }}\n        }\n      ]\n    }\n  {% endcapture %}\n  {% assign order = order_json | parse_json %}\n{% else %}\n  {% assign order = order.reload %}\n{% endif %}\n\n{% assign fulfillments_qualify = false %}\n\n{% for fulfillment in order.fulfillments %}\n  {% if options.qualifying_fulfillment_statuses__array_required contains fulfillment.shipment_status %}\n    {% assign fulfillments_qualify = true %}\n  {% endif %}\n{% endfor %}\n\n{% if fulfillments_qualify %}\n  {% assign klaviyo_data = hash %}\n  {% assign klaviyo_data[\"token\"] = options.klaviyo_api_token__required %}\n  {% assign klaviyo_data[\"event\"] = options.klaviyo_event_name__required %}\n  {% assign klaviyo_data[\"customer_properties\"] = hash %}\n  {% assign klaviyo_data[\"customer_properties\"][\"$email\"] = order.email %}\n  {% assign klaviyo_data[\"properties\"] = hash %}\n  {% assign klaviyo_data[\"properties\"][\"order_name\"] = order.name %}\n\n  {% action \"http\" %}\n    {\n      \"method\": \"get\",\n      \"url\": \"https://a.klaviyo.com/api/track?data={{ klaviyo_data | json | base64 }}\"\n    }\n  {% endaction %}\n{% endif %}",
  "docs": null,
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false
}
