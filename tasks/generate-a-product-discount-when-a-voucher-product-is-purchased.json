{
  "name": "Generate a product discount when a voucher product is purchased",
  "options": {
    "voucher_product_ids_and_entitled_product_ids__keyval_number_required": {},
    "discount_code_prefix__required": "HOORAY",
    "discount_value__number_required": "-5",
    "email_subject__required": "[Order {{ order.name }}] Thanks! Your discount is attached.",
    "email_body__multiline_required": "Hi {{ order.customer.first_name | default: \"there\" }},\n\nThanks for your order! Here's your discount code:\n\n<code>DISCOUNT_CODE</code>\n\nYour purchase of VOUCHER_PRODUCT_TITLE has earned you a one-time discount on a future order of ENTITLED_PRODUCT_TITLE.\n\nThanks,\nThe team at {{ shop.name }}"
  },
  "subscriptions": [
    "shopify/orders/paid"
  ],
  "subscriptions_template": "shopify/orders/paid",
  "script": "{% assign ve_product_ids_keyval = options.voucher_product_ids_and_entitled_product_ids__keyval_number_required %}\n\n{% if event.preview or order.customer %}\n  {% for order_line_item in order.line_items %}\n    {% assign voucher_product_id = order_line_item.product_id %}\n    {% assign voucher_product_id_string = voucher_product_id | append: \"\" %}\n    {% assign entitled_product_id = ve_product_ids_keyval[voucher_product_id_string] %}\n\n    {% if event.preview or entitled_product_id %}\n      {% for order_line_item_n in (1..order_line_item.quantity) %}\n        {% assign discount_code = options.discount_code_prefix__required | append: order.order_number | append: order_line_item.sku | append: order_line_item_n | append: order.customer.id %}\n\n        {% if event.preview or shop.discount_codes[discount_code] == nil %}\n          {% assign voucher_product = shop.products[voucher_product_id] %}\n          {% assign entitled_product = shop.products[entitled_product_id] %}\n\n          {% assign voucher_product_title = voucher_product.title | default: \"(voucher product title)\" %}\n          {% assign entitled_product_title = entitled_product.title | default: \"(entitled product title)\" %}\n          {% assign entitled_product_admin_graphql_api_id = entitled_product.admin_graphql_api_id %}\n\n          {% assign customer_admin_graphql_api_id = shop.customers[order.customer.id].admin_graphql_api_id %}\n\n          {% capture graphql_query %}\n            mutation {\n              priceRuleCreate(\n                priceRule: {\n                  allocationMethod: ACROSS\n                  customerSelection: {\n                    customerIdsToAdd: [{{ customer_admin_graphql_api_id | json }}]\n                  }\n                  itemEntitlements:{\n                    productIds: [{{ entitled_product_admin_graphql_api_id | json }}]\n                  }\n                  target: LINE_ITEM\n                  title: {{ discount_code | json }}\n                  usageLimit: 1\n                  validityPeriod: {\n                    start: {{ \"now\" | date: \"%FT%T%:z\" | json }}\n                  }\n                  value: {\n                    fixedAmountValue: {{ options.discount_value__number_required | json }}\n                  }\n                }\n                priceRuleDiscountCode: {\n                  code: {{ discount_code | json }}\n                }\n              ) {\n                priceRule {\n                  id\n                }\n                priceRuleUserErrors {\n                  code\n                  field\n                  message\n                }\n                priceRuleDiscountCode {\n                  code\n                  id\n                }\n              }\n            }\n          {% endcapture %}\n\n          {\n            \"action\": {\n              \"type\": \"shopify\",\n              \"options\": {{ graphql_query | json }}\n            }\n          }\n\n          {% assign email_subject = options.email_subject__required | replace: 'DISCOUNT_CODE', discount_code | replace: 'VOUCHER_PRODUCT_TITLE', voucher_product_title | replace: 'ENTITLED_PRODUCT_TITLE', entitled_product_title %}\n          {% assign email_body = options.email_body__multiline_required | replace: 'DISCOUNT_CODE', discount_code | replace: 'VOUCHER_PRODUCT_TITLE', voucher_product_title | replace: 'ENTITLED_PRODUCT_TITLE', entitled_product_title %}\n\n          {\n            \"action\": {\n              \"type\": \"email\",\n              \"options\": {\n                \"to\": {{ order.email | json }},\n                \"subject\": {{ email_subject | strip | json }},\n                \"body\": {{ email_body | newline_to_br | json }},\n                \"reply_to\": {{ shop.customer_email | json }},\n                \"from_display_name\": {{ shop.name | json }}\n              }\n            }\n          }\n        {% else %}\n          {\"log\": {{ discount_code | append: \" already exists; skipping\" | json }}}\n        {% endif %}\n      {% endfor %}\n    {% endif %}\n\n    {% if event.preview %}\n      {% break %}\n    {% endif %}\n  {% endfor %}\n{% endif %}",
  "docs": "Use this task to sell vouchers for future purchases. Buy a product, receive an emailed discount code for a discount on another specific product.\n\n### Getting started\r\n\r\nMake sure each of your voucher products has a SKU filled in. This is important: the SKU will be a part of each generated discount code.\r\n\r\nIn Mechanic, fill in the \"Voucher product IDs and entitled product IDs\" option with the IDs of the voucher products you're selling on the left, and the IDs of products you want to be discounted on the right.\r\n\r\nTo find a product ID, open up each product in the Shopify admin, and look at the URL in your browser. The numbers at the very end are your product ID. For example, if this is the URL you're seeing:\r\n\r\n```\r\nhttps://example.myshopify.com/admin/products/1234567890\r\n```\r\n\r\n... then your product ID is `1234567890`.\r\n\r\n### Background\r\n\r\nFor the purposes of this task, a \"voucher product\" is a product you sell to earn a discount to an \"entitled product\".\r\n\r\nThis task builds discount coupon codes that are single-use, for a fixed amount of money off a purchase on a specific entitled product.\r\n\r\nTo make unique discount codes, this task assembles codes using this format:\r\n\r\n```\r\n[PREFIX][ORDER NUMBER][VOUCHER SKU][QUANTITY COUNTER][CUSTOMER ID]\r\n```\r\n\r\nFor example, discount codes might look like:\r\n\r\n* `HOORAY1027SIMPLE1806736592949`\r\n* `FLASH381EARLYRISER2914633758241`\r\n* `PRESALE9912EAS135947168211735`",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "tags": [
    "Products",
    "Discounts",
    "Watch"
  ]
}
