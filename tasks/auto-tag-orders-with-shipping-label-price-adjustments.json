{
  "docs": "This task will run daily to scan order timeline events from the past week to see if any orders have new shipping provider charges for labels. Qualifying orders will be tagged with the tag of your choice.\n\nRun this task manually to scan the last 25K related order events. **Note:** You may need to enable [read all orders](https://learn.mechanic.dev/platform/shopify/read-all-orders) to successfully tag qualifying orders older than 60 days.",
  "halt_action_run_sequence_on_error": false,
  "name": "Auto-tag orders with shipping label price adjustments",
  "online_store_javascript": null,
  "options": {
    "order_tag_to_add__required": "shipping-label-price-adjustment"
  },
  "perform_action_runs_in_sequence": false,
  "preview_event_definitions": [],
  "script": "{% assign order_tag_to_add = options.order_tag_to_add__required %}\n\n{% if event.topic == \"mechanic/user/trigger\" or event.topic contains \"mechanic/scheduler/\" %}\n  {%- capture search_query -%}\n    subject_type:ORDER action:shipping_label_adjustment_charge_created\n  {%- endcapture -%}\n\n  {% if event.topic contains \"mechanic/scheduler/\" %}\n    {%- capture search_query -%}\n      {{ search_query }} created_at:past_week\n    {%- endcapture -%}\n  {% endif %}\n\n  {% comment %}\n    -- get order timeline events related to shipping\n    -- limit daily runs to a lookback of the past week; manual runs are only restricted by the number of events (25K max for this paginated query)\n  {% endcomment %}\n\n  {% assign cursor = nil %}\n  {% assign events = array %}\n\n  {% for n in (1..100) %}\n    {% capture query %}\n      query {\n        events(\n          first: 250\n          reverse: true\n          sortKey: CREATED_AT\n          after: {{ cursor | json }}\n          query: {{ search_query | json }}\n        ) {\n          pageInfo {\n            hasNextPage\n            endCursor\n          }\n          nodes {\n            ... on BasicEvent {\n              id\n              action\n              createdAt\n              message\n              subject {\n                ... on Order {\n                  id\n                  name\n                  createdAt\n                  tags\n                }\n              }\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = query | shopify %}\n\n    {% if event.preview %}\n      {% capture result_json %}\n        {\n          \"data\": {\n            \"events\": {\n              \"nodes\": [\n                {\n                  \"id\": \"gid://shopify/BasicEvent/1234567890\",\n                  \"action\": \"shipping_label_adjustment_charge_created\",\n                  \"message\": \"You were charged $1.50 for a shipping label price adjustment.\",\n                  \"subject\": {\n                    \"id\": \"gid://shopify/Order/1234567890\",\n                    \"name\": \"#PREVIEW\"\n                  }\n                }\n              ]\n            }\n          }\n        }\n      {% endcapture %}\n\n      {% assign result = result_json | parse_json %}\n    {% endif %}\n\n    {% assign events = events | concat: result.data.events.nodes %}\n\n    {% if result.data.events.pageInfo.hasNextPage %}\n      {% assign cursor = result.data.events.pageInfo.endCursor %}\n    {% else %}\n      {% break %}\n    {% endif %}\n  {% endfor %}\n\n  {% comment %}\n    -- tag all orders associated with shipping label price adjustment events, unless they are already tagged\n  {% endcomment %}\n\n  {% for event in events %}\n    {% assign order = event.subject %}\n\n    {% if order == blank %}\n      {% log\n        message: \"No order object was returned with this event. Check to make sure that Mechanic has access to order older than 60 days.\",\n        event: event\n      %}\n      {% continue %}\n    {% endif %}\n\n    {% unless order.tags contains order_tag_to_add %}\n      {% log\n        message: \"Order qualified to be tagged\",\n        event: event\n      %}\n\n      {% action \"shopify\" %}\n        mutation {\n          tagsAdd(\n            id: {{ order.id | json }}\n            tags: {{ order_tag_to_add | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endunless %}\n  {% endfor %}\n{% endif %}\n",
  "subscriptions": [
    "mechanic/scheduler/daily",
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "mechanic/scheduler/daily\nmechanic/user/trigger",
  "tags": [
    "Auto-Tag",
    "Orders",
    "Shipping"
  ]
}
