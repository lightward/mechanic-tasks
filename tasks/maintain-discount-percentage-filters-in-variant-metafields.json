{
  "name": "Maintain discount percentage filters in variant metafields",
  "options": {
    "metafield_namespace_and_key__required": null,
    "discount_filters_and_percentage_thresholds__keyval_number_required": null
  },
  "subscriptions": [
    "shopify/products/update",
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "shopify/products/update\nmechanic/user/trigger",
  "script": "{% assign metafield_namespace_and_key = options.metafield_namespace_and_key__required | match: \"(?<namespace>[\\w-]{3,})\\.(?<key>[\\w-]{3,})\" %}\n{% assign discount_filters_and_percentage_thresholds = options.discount_filters_and_percentage_thresholds__keyval_number_required %}\n\n{% assign metafield_namespace = metafield_namespace_and_key.named_captures.namespace %}\n{% assign metafield_key = metafield_namespace_and_key.named_captures.key %}\n\n{% if metafield_namespace == blank or metafield_key == blank %}\n  {% error %}\n    \"The metafield key and namespace must each be at least 3 characters long and separated only by a '.'.\\n\\nValid characters are a-z, A-Z, 0-9, underscores, and dashes.\"\n  {% enderror %}\n  {% break %}\n{% endif %}\n\n{% assign variants = array %}\n\n{% if event.topic == \"mechanic/user/trigger\" or event.topic contains \"mechanic/scheduler/\" %}\n  {% assign cursor = nil %}\n\n  {% for n in (1..200) %}\n    {% capture query %}\n      query {\n        productVariants(\n          first: 250\n          after: {{ cursor | json }}\n        ) {\n          pageInfo {\n            hasNextPage\n            endCursor\n          }\n          nodes {\n            id\n            displayName\n            price\n            compareAtPrice\n            metafield(\n              namespace: {{ metafield_namespace | json }}\n              key: {{ metafield_key | json }}\n            ) {\n              id\n              value\n            }\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = query | shopify %}\n\n    {% assign variants\n      = result.data.productVariants.nodes\n      | default: array\n      | concat: variants\n    %}\n\n    {% if result.data.productVariants.pageInfo.hasNextPage %}\n      {% assign cursor = result.data.productVariants.pageInfo.endCursor %}\n    {% else %}\n      {% break %}\n    {% endif %}\n  {% endfor %}\n\n{% elsif event.topic == \"shopify/products/update\" %}\n  {% capture query %}\n    query {\n      product(id: {{ product.admin_graphql_api_id | json }}) {\n        variants(first: 100) {\n          nodes {\n            id\n            displayName\n            price\n            compareAtPrice\n            metafield(\n              namespace: {{ metafield_namespace | json }}\n              key: {{ metafield_key | json }}\n            ) {\n              id\n              value\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% assign variants = result.data.product.variants.nodes %}\n{% endif %}\n\n{% if event.preview %}\n  {% capture variants_json %}\n    [\n      {\n        \"id\": \"gid://shopify/ProductVariant/1234567890\",\n        \"price\": \"0.00\",\n        \"compareAtPrice\": \"1.00\"\n      }\n    ]\n  {% endcapture %}\n\n  {% assign variants = variants_json | parse_json %}\n{% endif %}\n\n{% assign metafields_to_set = array %}\n{% assign metafields_to_delete = array %}\n{% assign variant_logs = array %}\n\n{% for variant in variants %}\n  {% assign variant_log = hash %}\n  {% assign variant_log[\"variant\"] = variant %}\n\n  {% assign price = variant.price | times: 1.0 %}\n  {% assign compare_at_price = variant.compareAtPrice | times: 1.0 %}\n\n  {% comment %}\n    Note: converting to floats above will handle cases where compareAtPrice is empty or \"0.00\", as it will become 0.0 in either case\n  {% endcomment %}\n\n  {% if compare_at_price <= price %}\n    {% if variant.metafield != blank %}\n      {% assign metafields_to_delete = metafields_to_delete | push: variant.metafield %}\n    {% endif %}\n\n    {% assign variant_log[\"message\"] = \"Variant is not discounted; skipping.\" %}\n    {% assign variant_logs = variant_logs | push: variant_log %}\n\n    {% continue %}\n  {% endif %}\n\n  {% assign discount_percentage\n    = price\n    | times: -100\n    | divided_by: compare_at_price\n    | plus: 100\n  %}\n\n  {% assign discount_filters_should_have = array %}\n\n  {% for keyval in discount_filters_and_percentage_thresholds %}\n    {% assign discount_filter = keyval.first %}\n    {% assign percentage_threshold = keyval.last %}\n\n    {% if discount_percentage >= percentage_threshold %}\n      {% assign discount_filters_should_have = discount_filters_should_have | push: discount_filter %}\n    {% endif %}\n  {% endfor %}\n\n  {% assign variant_log[\"discount_percentage\"] = discount_percentage %}\n  {% assign variant_log[\"discount_filters_should_have\"] = discount_filters_should_have %}\n\n  {% if discount_filters_should_have == blank %}\n    {% if variant.metafield != blank %}\n      {% assign metafields_to_delete = metafields_to_delete | push: variant.metafield %}\n    {% endif %}\n\n    {% assign variant_log[\"message\"] = \"Variant is discounted, but it does not meet any of the configured percentage thresholds; skipping.\" %}\n    {% assign variant_logs = variant_logs | push: variant_log %}\n\n    {% continue %}\n  {% endif %}\n\n  {% assign discount_filters_should_have_json = discount_filters_should_have | json %}\n\n  {% if variant.metafield.value == discount_filters_should_have_json %}\n    {% continue %}\n  {% endif %}\n\n  {% assign variant_log[\"message\"] = \"Variant is discounted and metafield does not match the discount filters it should have; updating.\" %}\n  {% assign variant_logs = variant_logs | push: variant_log %}\n\n  {% capture metafield_to_set %}\n    {\n      ownerId: {{ variant.id | json }}\n      namespace: {{ metafield_namespace | json }}\n      key: {{ metafield_key | json }}\n      value: {{ discount_filters_should_have_json | json }}\n      type: \"list.single_line_text_field\"\n    }\n  {% endcapture %}\n\n  {% assign metafields_to_set = metafields_to_set | push: metafield_to_set %}\n{% endfor %}\n\n{% log variant_logs %}\n\n{% if metafields_to_set != blank %}\n  {% assign groups_of_metafields_to_set = metafields_to_set | in_groups_of: 25, fill_with: false %}\n\n  {% for group_of_metafields_to_set in groups_of_metafields_to_set %}\n    {% action \"shopify\" %}\n      mutation {\n        metafieldsSet(\n          metafields: [\n            {{ group_of_metafields_to_set | join: newline }}\n          ]\n        ) {\n          metafields {\n            id\n            namespace\n            key\n            type\n            value\n            owner {\n              ... on ProductVariant {\n                id\n                displayName\n              }\n            }\n          }\n          userErrors {\n            code\n            field\n            message\n          }\n        }\n      }\n    {% endaction %}\n  {% endfor %}\n{% endif %}\n\n{% for metafield_to_delete in metafields_to_delete %}\n  {% action \"shopify\" %}\n    mutation {\n      metafieldDelete(\n        input: {\n          id: {{ metafield_to_delete.id | json }}\n        }\n      ) {\n        deletedId\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% endfor %}\n",
  "docs": "This task checks to see if a product's variants have been discounted (by having a price set below the compare at price), and for each variant that meets one ore more configured discount percentage thresholds, it will save the matched filters in a variant metafield for use with Online Store 2.0 filtering.\n\nVariants that are not discounted or do not meet any of the configured thresholds will have their metafield deleted if it exists.\n\nThis task runs when products are updated, and may also be run manually to scan all variants in the shop.\n\n**Important notes:**\n- Before configuring and running this task, a metafield definition must be created in the Shopify admin with a \"Single line text\" type configured to \"Accept list of values\", per the documentation on [creating custom metafield definitions](https://help.shopify.com/en/manual/metafields/metafield-definitions/creating-custom-metafield-definitions).\n- For the _Discount filters and percentage thresholds_ task configuration field, enter the discount filter values that will display on the storefront (e.g. 25% off or more) on the left-hand side, and the percentage thresholds as whole numbers (e.g. 25) on the right.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false,
  "preview_event_definitions": [],
  "tags": [
    "Discounts",
    "Metafields",
    "Online Store 2.0",
    "Price",
    "Variants"
  ]
}
