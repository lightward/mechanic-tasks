{
  "docs": "This task will automatically tag any products which have variants set to \"continue selling when out of stock.\" This allows you to set up a product collection that includes \"available\" products and not just products with inventory greater than zero. Configure the task with a tag to apply, and Mechanic will take care of applying and removing the tag as appropriate.\n\nRun this task manually to update your entire product catalog at once.",
  "halt_action_run_sequence_on_error": false,
  "name": "Auto-tag products marked \"Continue selling when out of stock\"",
  "online_store_javascript": null,
  "options": {
    "tag_for_continue_selling_products__required": "continue-selling"
  },
  "perform_action_runs_in_sequence": false,
  "preview_event_definitions": [],
  "script": "{% assign tag_for_continue_selling_products = options.tag_for_continue_selling_products__required %}\n\n{% comment %}\n  -- for product create/update, filter the products query with the product ID that caused the event\n{% endcomment %}\n\n{% if event.topic contains \"shopify/products/\" %}\n  {% assign search_query = product.id | prepend: \"id:\" %}\n{% endif %}\n\n{% comment %}\n  -- query product(s) in the shop; variants will be queried separately as needed to support up to 2K variants\n{% endcomment %}\n\n{% assign cursor = nil %}\n{% assign products = array %}\n\n{% for n in (1..100) %}\n  {% capture query %}\n    query {\n      products(\n        first: 250\n        after: {{ cursor | json }}\n        query: {{ search_query | json }}\n      ) {\n        pageInfo {\n          hasNextPage\n          endCursor\n        }\n        nodes {\n          id\n          tags\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% assign result = query | shopify %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n      {\n        \"data\": {\n          \"products\": {\n            \"nodes\": [\n              {\n                \"id\": \"gid://shopify/Product/1234567890\"\n              }\n            ]\n          }\n        }\n      }\n    {% endcapture %}\n\n    {% assign result = result_json | parse_json %}\n  {% endif %}\n\n  {% assign products = products | concat: result.data.products.nodes %}\n\n  {% if result.data.products.pageInfo.hasNextPage %}\n    {% assign cursor = result.data.products.pageInfo.endCursor %}\n  {% else %}\n    {% break %}\n  {% endif %}\n{% endfor %}\n\n{% comment %}\n  -- process each product by querying as many variants as needed to determine whether the product should be tagged\n{% endcomment %}\n\n{% for product in products %}\n  {% assign product_set_to_continue_selling = nil %}\n  {% assign cursor = nil %}\n\n  {% for n in (1..8) %}\n    {% capture query %}\n      query {\n        product(id: {{ product.id | json }}) {\n          variants(\n            first: 250\n            after: {{ cursor | json }}\n          ) {\n            pageInfo {\n              hasNextPage\n              endCursor\n            }\n            nodes {\n              inventoryPolicy\n            }\n          }\n        }\n      }\n    {% endcapture %}\n  {% action \"echo\" query %}\n\n    {% assign result = query | shopify %}\n\n    {% if event.preview %}\n      {% capture result_json %}\n        {\n          \"data\": {\n            \"product\": {\n              \"variants\": {\n                \"nodes\": [\n                  {\n                    \"inventoryPolicy\": \"CONTINUE\"\n                  }\n                ]\n              }\n            }\n          }\n        }\n      {% endcapture %}\n\n      {% assign result = result_json | parse_json %}\n    {% endif %}\n\n    {% assign variants = result.data.product.variants.nodes %}\n\n    {% comment %}\n      -- check batch of variants to see if any is marked \"continue selling\"\n    {% endcomment %}\n\n    {% for variant in variants %}\n      {% if variant.inventoryPolicy == \"CONTINUE\" %}\n        {% assign product_set_to_continue_selling = true %}\n        {% break %}\n      {% endif %}\n    {% endfor %}\n\n    {% comment %}\n      -- only query for more variants if the product has not yet qualified as \"continue selling\" AND if there are more variants\n    {% endcomment %}\n\n    {% if product_set_to_continue_selling %}\n      {% break %}\n    {% elsif result.data.product.variants.pageInfo.hasNextPage %}\n      {% assign cursor = result.data.product.variants.pageInfo.endCursor %}\n    {% else %}\n      {% break %}\n    {% endif %}\n  {% endfor %}\n\n  {% comment %}\n    -- adjust tags on product as needed\n  {% endcomment %}\n\n  {% assign tag_to_add = nil %}\n  {% assign tag_to_remove = nil %}\n\n  {% if product_set_to_continue_selling %}\n    {% unless product.tags contains tag_for_continue_selling_products %}\n      {% assign tag_to_add = tag_for_continue_selling_products %}\n    {% endunless %}\n\n  {% else %}\n    {% if product.tags contains tag_for_continue_selling_products %}\n      {% assign tag_to_remove = tag_for_continue_selling_products %}\n    {% endif %}\n\n  {% endif %}\n\n  {% if tag_to_add or tag_to_remove %}\n    {% action \"shopify\" %}\n      mutation {\n        {% if tag_to_add %}\n          tagsAdd(\n            id: {{ product.id | json }}\n            tags: {{ tag_to_add | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        {% endif %}\n\n        {% if tag_to_remove %}\n          tagsRemove(\n            id: {{ product.id | json }}\n            tags: {{ tag_to_remove | json }}\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        {% endif %}\n      }\n    {% endaction %}\n  {% endif %}\n{% endfor %}\n",
  "subscriptions": [
    "shopify/products/create",
    "shopify/products/update",
    "mechanic/user/trigger"
  ],
  "subscriptions_template": "shopify/products/create\nshopify/products/update\nmechanic/user/trigger",
  "tags": [
    "Auto-Tag",
    "Collections",
    "Inventory",
    "Products"
  ]
}
