{
  "name": "Delete product metafields in bulk",
  "options": {
    "metafield_namespace": null,
    "metafield_key": null,
    "test_mode__boolean": true
  },
  "subscriptions": [
    "mechanic/user/trigger",
    "mechanic/shopify/bulk_operation"
  ],
  "subscriptions_template": "mechanic/user/trigger\nmechanic/shopify/bulk_operation",
  "script": "{% if options.metafield_namespace == blank and options.metafield_key != blank %}\n  {% error \"If you provide a metafield key, you must also provide a metafield namespace.\" %}\n{% endif %}\n\n{% if event.topic == \"mechanic/user/trigger\" %}\n  {% capture bulk_operation_query %}\n    query {\n      products {\n        edges {\n          node {\n            __typename\n            id\n            {% if options.metafield_key != blank %}\n              metafield(\n                namespace: {{ options.metafield_namespace | json }}\n                key: {{ options.metafield_key | json }}\n              ) {\n                __typename\n                id\n                description\n                namespace\n                key\n                value\n                valueType\n              }\n            {% else %}\n              metafields(\n                {% if options.metafield_namespace != blank %}\n                  namespace: {{ options.metafield_namespace | json }}\n                {% endif %}\n              ) {\n                edges {\n                  node {\n                    __typename\n                    id\n                    description\n                    namespace\n                    key\n                    value\n                    valueType\n                  }\n                }\n              }\n            {% endif %}\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% action \"shopify\" %}\n    mutation {\n      bulkOperationRunQuery(\n        query: {{ bulk_operation_query | json }}\n      ) {\n        bulkOperation {\n          id\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n{% elsif event.topic == \"mechanic/shopify/bulk_operation\" %}\n  {% if event.preview %}\n    {% capture objects_jsonl %}\n      {% if options.metafield_key != blank %}\n        {\"__typename\":\"Product\",\"id\":\"gid:\\/\\/shopify\\/Product\\/1234567890\",\"metafield\":{\"__typename\":\"Metafield\",\"id\":\"gid:\\/\\/shopify\\/Metafield\\/1234567890\"}}\n      {% else %}\n        {\"__typename\":\"Metafield\",\"id\":\"gid:\\/\\/shopify\\/Metafield\\/0987654321\",\"__parentId\":\"gid:\\/\\/shopify\\/Product\\/0987654321\"}\n      {% endif %}\n    {% endcapture %}\n\n    {% assign bulkOperation = hash %}\n    {% assign bulkOperation[\"objects\"] = objects_jsonl | parse_jsonl %}\n  {% endif %}\n\n  {% assign metafield_ids = bulkOperation.objects | where: \"__typename\", \"Metafield\" | map: \"id\" %}\n  {% assign metafield_ids = bulkOperation.objects | where: \"__typename\", \"Product\" | where: \"metafield\" | map: \"metafield\" | map: \"id\" | concat: metafield_ids %}\n\n  {% assign product_ids = bulkOperation.objects | where: \"__typename\", \"Metafield\" | map: \"__parentId\" | uniq %}\n  {% assign product_ids = bulkOperation.objects | where: \"__typename\", \"Product\" | where: \"metafield\" | map: \"id\" | concat: product_ids %}\n\n  {% if options.test_mode__boolean %}\n    {% action \"echo\" metafields_found: metafield_ids.size, products_with_metafields_found: product_ids.size, metafield_ids: metafield_ids, product_with_metafields_ids: product_ids %}\n  {% else %}\n    {% log metafields_found: metafield_ids.size, products_with_metafields_found: product_ids.size, metafield_ids: metafield_ids, product_with_metafields_ids: product_ids %}\n\n    {% for metafield_id in metafield_ids %}\n      {% action \"shopify\" %}\n        mutation {\n          metafieldDelete(\n            input: {\n              id: {{ metafield_id | json }}\n            }\n          ) {\n            userErrors {\n              field\n              message\n            }\n          }\n        }\n      {% endaction %}\n    {% endfor %}\n  {% endif %}\n{% endif %}",
  "docs": "Use this task to delete all of your product metafields, optionally filtering by namespace or by namespace and key. This task will then delete all metafields found. Comes with a test mode â€“ use this first to make sure you're deleting the right things.\n\nWith no configuration, this task will delete all product metafields. Configure it with a metafield namespace to only delete metafields with that namespace, or add both a namespace and key to get even more specific. Run this task with the test mode option enabled, the first time, to make sure you're deleting the right material.",
  "halt_action_run_sequence_on_error": false,
  "online_store_javascript": null,
  "order_status_javascript": null,
  "perform_action_runs_in_sequence": false
}
